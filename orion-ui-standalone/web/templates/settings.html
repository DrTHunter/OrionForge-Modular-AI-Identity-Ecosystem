{% extends "base.html" %}
{% block title %}Settings ‚Äî SoulScript Engine{% endblock %}

{% block content %}
<style>
  /* ‚îÄ‚îÄ Settings tab bar ‚îÄ‚îÄ */
  .settings-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
  .settings-tab {
    padding: 0.4rem 1rem; border-radius: 0.375rem; font-size: 0.8125rem;
    font-weight: 600; cursor: pointer; border: 1px solid rgba(255,255,255,0.08);
    background: transparent; color: rgba(241,245,249,0.5); transition: all 0.15s;
  }
  .settings-tab:hover { color: #e2e8f0; border-color: rgba(255,255,255,0.15); }
  .settings-tab.active {
    background: #6366f1; color: #fff; border-color: #6366f1;
  }
  .settings-panel { display: none; }
  .settings-panel.active { display: block; }

  /* ‚îÄ‚îÄ Section cards ‚îÄ‚îÄ */
  .settings-section {
    background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
    border-radius: 0.75rem; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem;
    max-width: 48rem;
  }
  .settings-section-title {
    font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.5px; color: #a5b4fc; margin-bottom: 0.25rem;
  }
  .settings-section-desc {
    font-size: 0.75rem; color: rgba(241,245,249,0.4); margin-bottom: 1rem;
  }

  /* ‚îÄ‚îÄ Timezone mode buttons ‚îÄ‚îÄ */
  .tz-mode-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
  .tz-mode-btn {
    padding: 0.375rem 0.875rem; border-radius: 0.375rem; font-size: 0.8125rem;
    font-weight: 500; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
    background: transparent; color: rgba(241,245,249,0.5); transition: all 0.15s;
  }
  .tz-mode-btn:hover { border-color: rgba(255,255,255,0.2); color: #e2e8f0; }
  .tz-mode-btn.active {
    background: rgba(99,102,241,0.15); color: #818cf8;
    border-color: rgba(99,102,241,0.4);
  }

  /* ‚îÄ‚îÄ Background preview ‚îÄ‚îÄ */
  .bg-preview-zone {
    border: 2px dashed rgba(255,255,255,0.1); border-radius: 0.75rem;
    padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s;
    position: relative; overflow: hidden; height: 12rem;
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 0.5rem;
    max-width: 28rem;
  }
  .bg-preview-zone:hover { border-color: rgba(99,102,241,0.4); background: rgba(99,102,241,0.03); }
  .bg-preview-zone.has-image { border-style: solid; border-color: rgba(99,102,241,0.25); padding: 0; }
  .bg-preview-zone img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 0.6rem;
    position: absolute; inset: 0;
  }
  .bg-preview-zone .bg-overlay-text {
    position: relative; z-index: 2; background: rgba(0,0,0,0.6);
    padding: 0.375rem 0.875rem; border-radius: 0.375rem;
    font-size: 0.75rem; color: #d4d4d8;
  }
  .bg-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
</style>

<div>
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-white">Settings</h1>
    <p class="text-sm text-forge-muted mt-1">Manage connections, API keys, and runtime configuration</p>
  </div>

  <!-- ‚ïê‚ïê‚ïê Tab Bar ‚ïê‚ïê‚ïê -->
  <div class="settings-tabs">
    <button class="settings-tab {{ 'active' if tab == 'connections' }}" onclick="switchSettingsTab('connections')">Connections</button>
    <button class="settings-tab {{ 'active' if tab == 'api_keys' }}" onclick="switchSettingsTab('api_keys')">API Keys</button>
    <button class="settings-tab {{ 'active' if tab == 'voice' }}" onclick="switchSettingsTab('voice')">Voice</button>
    <button class="settings-tab {{ 'active' if tab == 'chat' }}" onclick="switchSettingsTab('chat')">Chat</button>
    <button class="settings-tab {{ 'active' if tab == 'general' }}" onclick="switchSettingsTab('general')">General</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 1 ‚Äî Connections
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="settings-panel {{ 'active' if tab == 'connections' }}" id="panel-connections">
    <div class="card mb-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <span class="card-header mb-0">API Connections</span>
          <p class="text-xs text-forge-muted mt-1">Manage OpenAI-compatible and Ollama API connections</p>
        </div>
        <button onclick="openModal()" class="filter-btn active" style="cursor:pointer;">+ Add Connection</button>
      </div>

      <div class="space-y-3" id="connections-list">
        {% for conn in connections %}
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg flex items-center justify-between" id="conn-{{ conn.id }}">
          <div class="flex items-center gap-3 flex-1">
            <button onclick="toggleConn('{{ conn.id }}', {{ 'false' if conn.enabled else 'true' }})"
                    class="w-10 h-5 rounded-full relative transition-colors {{ 'bg-forge-success' if conn.enabled else 'bg-zinc-600' }}"
                    style="cursor:pointer;">
              <span class="absolute top-0.5 {{ 'right-0.5' if conn.enabled else 'left-0.5' }} w-4 h-4 bg-white rounded-full transition-all shadow"></span>
            </button>
            <div>
              <div class="flex items-center gap-2">
                <span class="text-sm font-semibold text-white">{{ conn.name }}</span>
                <span class="badge {{ 'badge-scope' if conn.type == 'external' else 'badge-category' }}">{{ conn.type }}</span>
                <span class="badge badge-type">{{ conn.provider }}</span>
              </div>
              <p class="text-xs text-forge-muted mt-0.5">{{ conn.url }}</p>
              {% if conn.models %}
              <p class="model-list text-xs text-zinc-500 mt-0.5">Models: {{ conn.models | join(', ') }}</p>
              {% endif %}
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="fetchModels('{{ conn.id }}', this)" class="text-xs text-forge-highlight hover:text-white" style="cursor:pointer;" title="Fetch available models">‚Üì models</button>
            <button onclick="editConn('{{ conn.id }}')" class="text-xs text-forge-accent hover:text-white" style="cursor:pointer;">‚öô</button>
            <button onclick="deleteConn('{{ conn.id }}')" class="text-xs text-forge-danger hover:text-white" style="cursor:pointer;">‚úï</button>
          </div>
        </div>
        {% endfor %}
        {% if not connections %}
        <div class="p-6 text-center text-forge-muted text-sm">
          No connections configured. Add one to start chatting.
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB ‚Äî API Keys
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="settings-panel {{ 'active' if tab == 'api_keys' }}" id="panel-api_keys">

    <!-- OpenAI -->
    <div class="settings-section">
      <div class="settings-section-title">OpenAI</div>
      <div class="settings-section-desc">API key for GPT-4o, GPT-4o-mini, o1, and other OpenAI models</div>
      <div class="mb-3">
        <label class="block text-xs text-forge-muted mb-1">API Key</label>
        <input id="key-openai" type="password" class="search-input w-full" style="max-width:32rem;"
               placeholder="sk-..." value="{{ settings.get('api_keys', {}).get('openai', '') }}">
      </div>
    </div>

    <!-- Anthropic -->
    <div class="settings-section">
      <div class="settings-section-title">Anthropic</div>
      <div class="settings-section-desc">API key for Claude models (Opus, Sonnet, Haiku)</div>
      <div class="mb-3">
        <label class="block text-xs text-forge-muted mb-1">API Key</label>
        <input id="key-anthropic" type="password" class="search-input w-full" style="max-width:32rem;"
               placeholder="sk-ant-..." value="{{ settings.get('api_keys', {}).get('anthropic', '') }}">
      </div>
    </div>

    <!-- DeepSeek -->
    <div class="settings-section">
      <div class="settings-section-title">DeepSeek</div>
      <div class="settings-section-desc">API key for DeepSeek models (DeepSeek-V3, DeepSeek-R1, etc.)</div>
      <div class="mb-3">
        <label class="block text-xs text-forge-muted mb-1">API Key</label>
        <input id="key-deepseek" type="password" class="search-input w-full" style="max-width:32rem;"
               placeholder="sk-..." value="{{ settings.get('api_keys', {}).get('deepseek', '') }}">
      </div>
    </div>

    <!-- Google Gemini -->
    <div class="settings-section">
      <div class="settings-section-title">Google Gemini</div>
      <div class="settings-section-desc">API key for Gemini models (Gemini 2.0, 1.5 Pro, etc.)</div>
      <div class="mb-3">
        <label class="block text-xs text-forge-muted mb-1">API Key</label>
        <input id="key-google_gemini" type="password" class="search-input w-full" style="max-width:32rem;"
               placeholder="AIza..." value="{{ settings.get('api_keys', {}).get('google_gemini', '') }}">
      </div>
    </div>

    <!-- Ollama -->
    <div class="settings-section">
      <div class="settings-section-title">Ollama</div>
      <div class="settings-section-desc">Local inference via Ollama ‚Äî no API key required, just the server URL</div>
      <div class="mb-3">
        <label class="block text-xs text-forge-muted mb-1">Ollama Server URL</label>
        <input id="key-ollama_url" type="text" class="search-input w-full" style="max-width:32rem;"
               placeholder="http://localhost:11434" value="{{ settings.get('api_keys', {}).get('ollama_url', 'http://localhost:11434') }}">
      </div>
    </div>

    <button class="filter-btn active" onclick="saveApiKeys()" style="cursor:pointer;">Save API Keys</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB ‚Äî Voice (STT / TTS)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="settings-panel {{ 'active' if tab == 'voice' }}" id="panel-voice">

    <!-- STT -->
    <div class="settings-section">
      <div class="settings-section-title">Speech-to-Text (STT)</div>
      <div class="settings-section-desc">Choose a speech recognition provider for voice input</div>

      <div class="mb-3">
        <label class="block text-xs text-forge-muted mb-1">Provider</label>
        <select id="stt-provider" class="search-input" style="max-width:20rem;" onchange="toggleSttFields()">
          <option value="none" {{ 'selected' if settings.get('stt', {}).get('provider', 'none') == 'none' }}>Disabled</option>
          <option value="whisper" {{ 'selected' if settings.get('stt', {}).get('provider') == 'whisper' }}>Whisper (OpenAI)</option>
          <option value="whisper_local" {{ 'selected' if settings.get('stt', {}).get('provider') == 'whisper_local' }}>Whisper (Local / whisper.cpp)</option>
        </select>
      </div>

      <!-- Whisper API fields -->
      <div id="stt-whisper-fields" style="display:none;">
        <div class="mb-3">
          <label class="block text-xs text-forge-muted mb-1">OpenAI API Key <span class="text-zinc-600">(uses your OpenAI key above if left blank)</span></label>
          <input id="stt-whisper-api-key" type="password" class="search-input w-full" style="max-width:32rem;"
                 placeholder="sk-... (optional ‚Äî falls back to OpenAI key)" value="{{ settings.get('stt', {}).get('whisper_api_key', '') }}">
        </div>
      </div>

      <!-- Whisper local fields -->
      <div id="stt-whisper-local-fields" style="display:none;">
        <div class="mb-3">
          <label class="block text-xs text-forge-muted mb-1">Model Size</label>
          <select id="stt-whisper-model" class="search-input" style="max-width:14rem;">
            <option value="tiny" {{ 'selected' if settings.get('stt', {}).get('whisper_model') == 'tiny' }}>Tiny</option>
            <option value="base" {{ 'selected' if settings.get('stt', {}).get('whisper_model', 'base') == 'base' }}>Base</option>
            <option value="small" {{ 'selected' if settings.get('stt', {}).get('whisper_model') == 'small' }}>Small</option>
            <option value="medium" {{ 'selected' if settings.get('stt', {}).get('whisper_model') == 'medium' }}>Medium</option>
            <option value="large" {{ 'selected' if settings.get('stt', {}).get('whisper_model') == 'large' }}>Large</option>
          </select>
        </div>
      </div>
    </div>

    <!-- TTS -->
    <div class="settings-section">
      <div class="settings-section-title">Text-to-Speech (TTS)</div>
      <div class="settings-section-desc">Choose a voice synthesis provider for agent responses</div>

      <div class="mb-3">
        <label class="block text-xs text-forge-muted mb-1">Provider</label>
        <select id="tts-provider" class="search-input" style="max-width:20rem;" onchange="toggleTtsFields()">
          <option value="none" {{ 'selected' if settings.get('tts', {}).get('provider', 'none') == 'none' }}>Disabled</option>
          <option value="elevenlabs" {{ 'selected' if settings.get('tts', {}).get('provider') == 'elevenlabs' }}>ElevenLabs</option>
          <option value="edge_tts" {{ 'selected' if settings.get('tts', {}).get('provider') == 'edge_tts' }}>Edge TTS (Free)</option>
        </select>
      </div>

      <!-- ElevenLabs fields -->
      <div id="tts-elevenlabs-fields" style="display:none;">
        <div class="mb-3">
          <label class="block text-xs text-forge-muted mb-1">ElevenLabs API Key</label>
          <input id="tts-elevenlabs-api-key" type="password" class="search-input w-full" style="max-width:32rem;"
                 placeholder="xi-..." value="{{ settings.get('tts', {}).get('elevenlabs_api_key', '') }}">
        </div>
        <div class="mb-3">
          <label class="block text-xs text-forge-muted mb-1">Voice ID</label>
          <input id="tts-elevenlabs-voice-id" type="text" class="search-input w-full" style="max-width:32rem;"
                 placeholder="e.g. 21m00Tcm4TlvDq8ikWAM" value="{{ settings.get('tts', {}).get('elevenlabs_voice_id', '') }}">
        </div>
      </div>

      <!-- Edge TTS fields -->
      <div id="tts-edge-fields" style="display:none;">
        <div class="mb-3">
          <label class="block text-xs text-forge-muted mb-1">Voice</label>
          <select id="tts-edge-voice" class="search-input" style="max-width:24rem;">
            <option value="en-US-AriaNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice', 'en-US-AriaNeural') == 'en-US-AriaNeural' }}>en-US-AriaNeural (Female)</option>
            <option value="en-US-GuyNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice') == 'en-US-GuyNeural' }}>en-US-GuyNeural (Male)</option>
            <option value="en-US-JennyNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice') == 'en-US-JennyNeural' }}>en-US-JennyNeural (Female)</option>
            <option value="en-US-ChristopherNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice') == 'en-US-ChristopherNeural' }}>en-US-ChristopherNeural (Male)</option>
            <option value="en-GB-SoniaNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice') == 'en-GB-SoniaNeural' }}>en-GB-SoniaNeural (Female, British)</option>
            <option value="en-GB-RyanNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice') == 'en-GB-RyanNeural' }}>en-GB-RyanNeural (Male, British)</option>
            <option value="en-AU-NatashaNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice') == 'en-AU-NatashaNeural' }}>en-AU-NatashaNeural (Female, Australian)</option>
            <option value="en-IN-NeerjaNeural" {{ 'selected' if settings.get('tts', {}).get('edge_tts_voice') == 'en-IN-NeerjaNeural' }}>en-IN-NeerjaNeural (Female, Indian)</option>
          </select>
        </div>
      </div>
    </div>

    <button class="filter-btn active" onclick="saveVoiceSettings()" style="cursor:pointer;">Save Voice Settings</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 2 ‚Äî Chat
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="settings-panel {{ 'active' if tab == 'chat' }}" id="panel-chat">
    <div class="settings-section">
      <div class="settings-section-title">Chat Background</div>
      <div class="settings-section-desc">Set a custom background image for the chat view. Supported: PNG, JPG, WebP, GIF</div>

      <div class="bg-preview-zone {{ 'has-image' if settings.get('chat_background') }}"
           id="bg-preview-zone" onclick="document.getElementById('bg-file-input').click()">
        {% if settings.get('chat_background') %}
        <img src="{{ settings.chat_background }}" alt="Chat background" id="bg-preview-img">
        <span class="bg-overlay-text">Click to change</span>
        {% else %}
        <span style="font-size:2rem; opacity:0.3;">üñºÔ∏è</span>
        <span style="font-size:0.8125rem; color:rgba(241,245,249,0.35);">Click or drag an image here</span>
        <span style="font-size:0.7rem; color:rgba(241,245,249,0.2);">PNG, JPG, WebP, GIF</span>
        {% endif %}
      </div>
      <input type="file" id="bg-file-input" accept=".png,.jpg,.jpeg,.webp,.gif" style="display:none;" onchange="uploadChatBg(this)">

      <div class="bg-actions">
        <button class="filter-btn" onclick="document.getElementById('bg-file-input').click()" style="cursor:pointer;">
          üì∑ Upload Image
        </button>
        {% if settings.get('chat_background') %}
        <button class="filter-btn" onclick="removeChatBg()" style="cursor:pointer; color:#fca5a5;">
          ‚úï Remove Background
        </button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 3 ‚Äî General
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="settings-panel {{ 'active' if tab == 'general' }}" id="panel-general">
    <!-- Timezone -->
    <div class="settings-section">
      <div class="settings-section-title">Timezone</div>
      <div class="settings-section-desc">Controls how timestamps are displayed across the dashboard</div>

      <label style="font-size:0.8125rem; color:#d4d4d8; margin-bottom:0.5rem; display:block;">Timezone Mode</label>
      <div class="tz-mode-group">
        <button class="tz-mode-btn {{ 'active' if settings.get('timezone','auto') == 'auto' }}"
                onclick="setTzMode('auto')">Auto (Host)</button>
        <button class="tz-mode-btn {{ 'active' if settings.get('timezone') == 'named' }}"
                onclick="setTzMode('named')">Named Zone</button>
        <button class="tz-mode-btn {{ 'active' if settings.get('timezone') == 'offset' }}"
                onclick="setTzMode('offset')">UTC Offset</button>
      </div>

      <!-- Named zone picker (hidden unless mode=named) -->
      <div id="tz-named-row" style="display:{{ 'flex' if settings.get('timezone') == 'named' else 'none' }};
           gap:0.5rem; align-items:center; margin-bottom:1rem;">
        <label style="font-size:0.75rem; color:rgba(241,245,249,0.5); white-space:nowrap;">Zone:</label>
        <select id="tz-named-select" class="search-input" style="max-width:16rem;">
          <option value="">Select timezone...</option>
        </select>
      </div>

      <!-- UTC offset picker (hidden unless mode=offset) -->
      <div id="tz-offset-row" style="display:{{ 'flex' if settings.get('timezone') == 'offset' else 'none' }};
           gap:0.5rem; align-items:center; margin-bottom:1rem;">
        <label style="font-size:0.75rem; color:rgba(241,245,249,0.5); white-space:nowrap;">UTC Offset:</label>
        <select id="tz-offset-select" class="search-input" style="max-width:10rem;">
          {% for h in range(-12, 15) %}
          <option value="{{ h }}" {{ 'selected' if settings.get('timezone_offset_hours') == h }}>
            UTC{{ '+' if h >= 0 else '' }}{{ h }}:00
          </option>
          {% endfor %}
        </select>
      </div>

      <div style="font-size:0.75rem; color:rgba(241,245,249,0.4); margin-bottom:1rem;">
        Current display time: &nbsp;
        <code id="tz-current-time" style="color:#d4d4d8; font-size:0.8125rem;"></code>
      </div>

      <button class="filter-btn active" onclick="saveTimezone()" style="cursor:pointer;">Save Timezone</button>
    </div>

    <!-- General / Runtime -->
    <div class="settings-section">
      <div class="settings-section-title">General</div>
      <div class="settings-section-desc">Runtime configuration</div>
      <div class="p-4 rounded-lg border border-forge-border bg-forge-bg text-sm text-forge-muted">
        Additional settings modules can be added here. Currently managed via config/ YAML files.
      </div>
    </div>
  </div>
</div>

<!-- Connection Modal -->
<div id="conn-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden">
  <div class="bg-forge-card border border-forge-border rounded-xl p-6 w-full max-w-md shadow-2xl">
    <div class="flex items-center justify-between mb-5">
      <h2 id="modal-title" class="text-lg font-bold text-white">Add Connection</h2>
      <button onclick="closeModal()" class="text-forge-muted hover:text-white text-xl" style="cursor:pointer;">‚úï</button>
    </div>
    <form id="conn-form" onsubmit="saveConn(event)">
      <input type="hidden" id="conn-edit-id" value="">
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">Connection Type</label>
        <div class="flex gap-2">
          <button type="button" onclick="setType('external')" id="btn-external" class="filter-btn active flex-1 text-center">External</button>
          <button type="button" onclick="setType('local')" id="btn-local" class="filter-btn flex-1 text-center">Local</button>
        </div>
        <input type="hidden" id="conn-type" value="external">
      </div>
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">Name</label>
        <input id="conn-name" class="search-input w-full" placeholder="e.g. OpenAI, DeepSeek" required>
      </div>
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">Provider</label>
        <select id="conn-provider" class="search-input w-full">
          <option value="openai">OpenAI Compatible</option>
          <option value="ollama">Ollama</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">URL</label>
        <input id="conn-url" class="search-input w-full" placeholder="https://api.openai.com/v1" required>
      </div>
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">API Key <span class="text-zinc-600">(optional for local)</span></label>
        <input id="conn-apikey" type="password" class="search-input w-full" placeholder="sk-...">
      </div>
      <div class="mb-4">
        <label class="block text-xs text-forge-muted mb-1">Models</label>
        <div class="flex gap-2 mb-2">
          <input id="conn-models" class="search-input flex-1" placeholder="gpt-4o, gpt-4o-mini">
          <button type="button" id="btn-fetch-models" onclick="fetchModelsInModal()" class="filter-btn flex-shrink-0" style="cursor:pointer; min-width:80px;">
            <span id="fetch-label">Fetch</span>
          </button>
        </div>
        <!-- Model picker chips ‚Äî populated after fetch -->
        <div id="model-picker" class="hidden">
          <p class="text-xs text-forge-muted mb-2">Click models to add/remove them:</p>
          <div id="model-chips" class="flex flex-wrap gap-1.5 max-h-40 overflow-y-auto pr-1"></div>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button type="button" id="btn-delete" onclick="deleteFromModal()" class="filter-btn text-forge-danger hover:bg-red-900/30 hidden" style="cursor:pointer;">Delete</button>
        <div class="flex-1"></div>
        <button type="button" onclick="closeModal()" class="filter-btn" style="cursor:pointer;">Cancel</button>
        <button type="submit" class="filter-btn active" style="cursor:pointer;">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
let _conns = {{ connections | tojson }};
let _tzMode = '{{ settings.get("timezone", "auto") }}';

/* ‚îÄ‚îÄ API Keys ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function saveApiKeys() {
  const payload = {
    openai:       document.getElementById('key-openai').value,
    anthropic:    document.getElementById('key-anthropic').value,
    deepseek:     document.getElementById('key-deepseek').value,
    google_gemini:document.getElementById('key-google_gemini').value,
    ollama_url:   document.getElementById('key-ollama_url').value,
  };
  const resp = await fetch('/api/settings/api-keys', {
    method: 'PUT', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  const data = await resp.json();
  showToast(data.status === 'ok' ? 'API keys saved' : 'Error saving keys', data.status === 'ok' ? 'ok' : 'error');
}

/* ‚îÄ‚îÄ Voice (STT / TTS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function toggleSttFields() {
  const p = document.getElementById('stt-provider').value;
  document.getElementById('stt-whisper-fields').style.display = p === 'whisper' ? 'block' : 'none';
  document.getElementById('stt-whisper-local-fields').style.display = p === 'whisper_local' ? 'block' : 'none';
}
function toggleTtsFields() {
  const p = document.getElementById('tts-provider').value;
  document.getElementById('tts-elevenlabs-fields').style.display = p === 'elevenlabs' ? 'block' : 'none';
  document.getElementById('tts-edge-fields').style.display = p === 'edge_tts' ? 'block' : 'none';
}
// initialise on load
toggleSttFields();
toggleTtsFields();

async function saveVoiceSettings() {
  const payload = {
    stt: {
      provider:       document.getElementById('stt-provider').value,
      whisper_api_key:document.getElementById('stt-whisper-api-key').value,
      whisper_model:  document.getElementById('stt-whisper-model').value,
    },
    tts: {
      provider:           document.getElementById('tts-provider').value,
      elevenlabs_api_key: document.getElementById('tts-elevenlabs-api-key').value,
      elevenlabs_voice_id:document.getElementById('tts-elevenlabs-voice-id').value,
      edge_tts_voice:     document.getElementById('tts-edge-voice').value,
    },
  };
  const resp = await fetch('/api/settings/voice', {
    method: 'PUT', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload),
  });
  const data = await resp.json();
  showToast(data.status === 'ok' ? 'Voice settings saved' : 'Error saving voice settings', data.status === 'ok' ? 'ok' : 'error');
}

/* ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function switchSettingsTab(name) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  const panel = document.getElementById('panel-' + name);
  if (panel) panel.classList.add('active');
  // Update URL without reload
  history.replaceState(null, '', '/settings?tab=' + name);
}

/* ‚îÄ‚îÄ Timezone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const _TZ_NAMES = Intl.supportedValuesOf ? Intl.supportedValuesOf('timeZone') : [
  'America/New_York','America/Chicago','America/Denver','America/Los_Angeles',
  'America/Anchorage','Pacific/Honolulu','Europe/London','Europe/Paris',
  'Europe/Berlin','Asia/Tokyo','Asia/Shanghai','Asia/Kolkata',
  'Australia/Sydney','Pacific/Auckland','UTC',
];

(function populateTimezoneSelect() {
  const sel = document.getElementById('tz-named-select');
  if (!sel) return;
  const saved = '{{ settings.get("timezone_name", "") }}';
  _TZ_NAMES.forEach(tz => {
    const opt = document.createElement('option');
    opt.value = tz;
    opt.textContent = tz.replace(/_/g, ' ');
    if (tz === saved) opt.selected = true;
    sel.appendChild(opt);
  });
})();

function setTzMode(mode) {
  _tzMode = mode;
  document.querySelectorAll('.tz-mode-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tz-named-row').style.display = mode === 'named' ? 'flex' : 'none';
  document.getElementById('tz-offset-row').style.display = mode === 'offset' ? 'flex' : 'none';
  updateTzDisplay();
}

function updateTzDisplay() {
  const el = document.getElementById('tz-current-time');
  if (!el) return;
  let opts = { year: 'numeric', month: 'short', day: '2-digit',
               hour: '2-digit', minute: '2-digit', second: '2-digit',
               hour12: false };
  let dateStr;
  try {
    if (_tzMode === 'named') {
      const tz = document.getElementById('tz-named-select').value;
      if (tz) opts.timeZone = tz;
      dateStr = new Date().toLocaleString('en-US', opts) + ' ' + (tz || 'Auto');
    } else if (_tzMode === 'offset') {
      const off = parseInt(document.getElementById('tz-offset-select').value) || 0;
      const now = new Date();
      const utcMs = now.getTime() + now.getTimezoneOffset() * 60000;
      const local = new Date(utcMs + off * 3600000);
      dateStr = local.toLocaleString('en-US', opts) + ' UTC' + (off >= 0 ? '+' : '') + off;
    } else {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      opts.timeZoneName = 'short';
      dateStr = new Date().toLocaleString('en-US', opts);
    }
  } catch (e) {
    dateStr = new Date().toLocaleString();
  }
  el.textContent = dateStr;
}
updateTzDisplay();
setInterval(updateTzDisplay, 1000);

// Listen for select changes
document.getElementById('tz-named-select')?.addEventListener('change', updateTzDisplay);
document.getElementById('tz-offset-select')?.addEventListener('change', updateTzDisplay);

async function saveTimezone() {
  const body = { timezone: _tzMode };
  if (_tzMode === 'named') body.timezone_name = document.getElementById('tz-named-select').value;
  if (_tzMode === 'offset') body.timezone_offset_hours = parseInt(document.getElementById('tz-offset-select').value) || 0;
  const resp = await fetch('/api/settings/timezone', {
    method: 'PUT', headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body),
  });
  const data = await resp.json();
  if (data.status === 'ok') showToast('Timezone saved', 'ok');
  else showToast('Error saving timezone', 'error');
}

/* ‚îÄ‚îÄ Chat Background ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function uploadChatBg(input) {
  const file = input.files[0];
  if (!file) return;
  const form = new FormData();
  form.append('file', file);
  try {
    const resp = await fetch('/api/settings/chat-background', { method: 'POST', body: form });
    const data = await resp.json();
    if (data.error) { showToast(data.error, 'error'); return; }
    // Update preview
    const zone = document.getElementById('bg-preview-zone');
    zone.classList.add('has-image');
    zone.innerHTML = `<img src="${data.url}" alt="Chat background" id="bg-preview-img">
                      <span class="bg-overlay-text">Click to change</span>`;
    showToast('Background uploaded', 'ok');
    // Reload to get the remove button
    setTimeout(() => location.reload(), 500);
  } catch (e) {
    showToast('Upload failed: ' + e, 'error');
  }
}

async function removeChatBg() {
  if (!confirm('Remove chat background?')) return;
  try {
    const resp = await fetch('/api/settings/chat-background', { method: 'DELETE' });
    const data = await resp.json();
    if (data.status === 'ok') {
      showToast('Background removed', 'ok');
      setTimeout(() => location.reload(), 300);
    }
  } catch (e) {
    showToast('Remove failed: ' + e, 'error');
  }
}

/* ‚îÄ‚îÄ Connection management (unchanged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function openModal(editId) {
  document.getElementById('conn-modal').classList.remove('hidden');
  document.getElementById('conn-edit-id').value = '';
  document.getElementById('modal-title').textContent = 'Add Connection';
  document.getElementById('btn-delete').classList.add('hidden');
  document.getElementById('conn-form').reset();
  clearModelPicker();
  setType('external');
}

function closeModal() {
  document.getElementById('conn-modal').classList.add('hidden');
  clearModelPicker();
}

function clearModelPicker() {
  document.getElementById('model-picker').classList.add('hidden');
  document.getElementById('model-chips').innerHTML = '';
  document.getElementById('fetch-label').textContent = 'Fetch';
  document.getElementById('btn-fetch-models').disabled = false;
}

function setType(type) {
  document.getElementById('conn-type').value = type;
  document.getElementById('btn-external').className = 'filter-btn flex-1 text-center' + (type === 'external' ? ' active' : '');
  document.getElementById('btn-local').className = 'filter-btn flex-1 text-center' + (type === 'local' ? ' active' : '');
  if (type === 'local') {
    document.getElementById('conn-provider').value = 'ollama';
    document.getElementById('conn-url').placeholder = 'http://localhost:11434';
  } else {
    document.getElementById('conn-url').placeholder = 'https://api.openai.com/v1';
  }
}

function editConn(id) {
  const c = _conns.find(x => x.id === id);
  if (!c) return;
  document.getElementById('conn-modal').classList.remove('hidden');
  document.getElementById('conn-edit-id').value = c.id;
  document.getElementById('modal-title').textContent = 'Edit Connection';
  document.getElementById('btn-delete').classList.remove('hidden');
  document.getElementById('conn-name').value = c.name || '';
  document.getElementById('conn-provider').value = c.provider || 'openai';
  document.getElementById('conn-url').value = c.url || '';
  document.getElementById('conn-apikey').value = c.api_key || '';
  document.getElementById('conn-models').value = (c.models || []).join(', ');
  setType(c.type || 'external');
  // If there are already saved models, render them as chips
  clearModelPicker();
  if (c.models && c.models.length > 0) {
    renderModelChips(c.models, c.models);
  }
}

function getSelectedModels() {
  return document.getElementById('conn-models').value
    .split(',').map(s => s.trim()).filter(Boolean);
}

function renderModelChips(allModels, selectedModels) {
  const container = document.getElementById('model-chips');
  container.innerHTML = '';
  const selected = new Set(selectedModels);
  allModels.forEach(m => {
    const chip = document.createElement('button');
    chip.type = 'button';
    chip.dataset.model = m;
    chip.textContent = m;
    chip.style.cursor = 'pointer';
    chip.className = 'px-2 py-0.5 rounded text-xs border transition-colors ' +
      (selected.has(m)
        ? 'bg-forge-highlight/20 border-forge-highlight text-forge-highlight'
        : 'bg-forge-bg border-forge-border text-forge-muted hover:border-zinc-400');
    chip.onclick = () => toggleModelChip(chip, m);
    container.appendChild(chip);
  });
  document.getElementById('model-picker').classList.remove('hidden');
}

function toggleModelChip(chip, model) {
  const current = getSelectedModels();
  const idx = current.indexOf(model);
  if (idx === -1) {
    current.push(model);
    chip.className = chip.className.replace(
      'bg-forge-bg border-forge-border text-forge-muted hover:border-zinc-400',
      'bg-forge-highlight/20 border-forge-highlight text-forge-highlight');
  } else {
    current.splice(idx, 1);
    chip.className = chip.className.replace(
      'bg-forge-highlight/20 border-forge-highlight text-forge-highlight',
      'bg-forge-bg border-forge-border text-forge-muted hover:border-zinc-400');
  }
  document.getElementById('conn-models').value = current.join(', ');
}

async function fetchModelsInModal() {
  const editId = document.getElementById('conn-edit-id').value;
  const btn = document.getElementById('btn-fetch-models');
  const label = document.getElementById('fetch-label');

  // Build a temporary connection object from the form for unsaved connections
  const url = document.getElementById('conn-url').value.trim();
  const apiKey = document.getElementById('conn-apikey').value.trim();
  const provider = document.getElementById('conn-provider').value;

  if (!url) { showToast('Enter a URL first', 'error'); return; }

  label.textContent = '...';
  btn.disabled = true;

  let models = [];
  let error = null;

  try {
    if (editId) {
      // Already saved ‚Äî use the backend fetch endpoint which also saves the list
      const resp = await fetch(`/api/connections/${editId}/models`);
      const data = await resp.json();
      if (data.error) throw new Error(data.error);
      models = data.models;
      // Update local cache
      const c = _conns.find(x => x.id === editId);
      if (c) c.models = models;
    } else {
      // Not saved yet ‚Äî proxy through the backend to avoid CORS
      const resp = await fetch('/api/connections/probe-models', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ url, api_key: apiKey, provider }),
      });
      const data = await resp.json();
      if (data.error) throw new Error(data.error);
      models = data.models;
    }
  } catch (e) {
    error = e.message;
  }

  label.textContent = 'Fetch';
  btn.disabled = false;

  if (error) {
    showToast('Fetch failed: ' + error, 'error');
    return;
  }
  if (models.length === 0) {
    showToast('No models returned from API', 'warn');
    return;
  }

  const current = getSelectedModels();
  // Pre-select whatever is already in the input
  renderModelChips(models, current.length ? current : [models[0]]);
  // Update the input with pre-selected
  if (current.length === 0) {
    document.getElementById('conn-models').value = models[0];
  }
  showToast(`${models.length} models found`, 'ok');
}

// ‚îÄ‚îÄ List view ‚Üì button ‚Äî fetch & refresh inline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchModels(id, btn) {
  const orig = btn.textContent;
  btn.textContent = '‚Ä¶';
  btn.style.pointerEvents = 'none';
  try {
    const resp = await fetch(`/api/connections/${id}/models`);
    const data = await resp.json();
    if (data.error) { showToast('Error: ' + data.error, 'error'); return; }
    // Update the local display without full reload
    const c = _conns.find(x => x.id === id);
    if (c) {
      c.models = data.models;
      const row = document.getElementById('conn-' + id);
      if (row) {
        let modelEl = row.querySelector('.model-list');
        if (!modelEl) {
          modelEl = document.createElement('p');
          modelEl.className = 'model-list text-xs text-zinc-500 mt-0.5';
          row.querySelector('.flex-1 > div').appendChild(modelEl);
        }
        modelEl.textContent = 'Models: ' + data.models.join(', ');
      }
    }
    showToast(`${data.models.length} models fetched`, 'ok');
  } catch(e) {
    showToast('Failed: ' + e, 'error');
  } finally {
    btn.textContent = orig;
    btn.style.pointerEvents = '';
  }
}

// ‚îÄ‚îÄ Toast helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type='ok') {
  let el = document.getElementById('ss-toast');
  if (!el) {
    el = document.createElement('div');
    el.id = 'ss-toast';
    el.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;padding:10px 18px;' +
      'border-radius:8px;font-size:13px;font-weight:500;pointer-events:none;opacity:0;' +
      'transition:opacity .2s;max-width:320px;';
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.background = type === 'error' ? '#7f1d1d' : type === 'warn' ? '#78350f' : '#14532d';
  el.style.color = type === 'error' ? '#fca5a5' : type === 'warn' ? '#fcd34d' : '#86efac';
  el.style.border = `1px solid ${type === 'error' ? '#ef4444' : type === 'warn' ? '#f59e0b' : '#22c55e'}`;
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(() => { el.style.opacity = '0'; }, 3000);
}

async function saveConn(e) {
  e.preventDefault();
  const editId = document.getElementById('conn-edit-id').value;
  const payload = {
    name: document.getElementById('conn-name').value,
    type: document.getElementById('conn-type').value,
    provider: document.getElementById('conn-provider').value,
    url: document.getElementById('conn-url').value,
    api_key: document.getElementById('conn-apikey').value,
    models: getSelectedModels(),
    enabled: true,
  };
  const url = editId ? `/api/connections/${editId}` : '/api/connections';
  await fetch(url, {method: editId ? 'PUT' : 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  location.reload();
}

async function deleteConn(id) {
  if (!confirm('Delete this connection?')) return;
  await fetch(`/api/connections/${id}`, {method:'DELETE'});
  location.reload();
}

function deleteFromModal() {
  const id = document.getElementById('conn-edit-id').value;
  if (id) deleteConn(id);
}

async function toggleConn(id, enabled) {
  const c = _conns.find(x => x.id === id);
  if (!c) return;
  c.enabled = enabled;
  await fetch(`/api/connections/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(c)});
  location.reload();
}
</script>
{% endblock %}
