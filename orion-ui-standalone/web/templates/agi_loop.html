{% extends "base.html" %}
{% block title %}AGI Loop â€” Orion Forge{% endblock %}

{% block content %}
<style>
  /* â”€â”€ AGI-Loop-specific augments (everything else uses global card/badge/filter-btn) â”€â”€ */
  .tab-bar { display: flex; align-items: center; gap: 0; border-bottom: 1px solid #2a2a3a; margin-bottom: 1.5rem; }
  .tab-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; font-size: 0.875rem; font-weight: 600; color: #71717a; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; position: relative; top: 1px; }
  .tab-btn:hover { color: #a1a1aa; }
  .tab-btn.active { color: #fff; border-bottom-color: #6366f1; }
  .view-panel { display: none; animation: viewFade 0.2s ease; }
  .view-panel.active { display: block; }
  @keyframes viewFade { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* Status badge */
  .status-badge { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
  .status-idle    { background: rgba(113,113,122,0.15); color: #a1a1aa; border: 1px solid rgba(113,113,122,0.3); }
  .status-running { background: rgba(16,185,129,0.12);  color: #6ee7b7; border: 1px solid rgba(16,185,129,0.25); }
  .status-paused  { background: rgba(245,158,11,0.12);  color: #fcd34d; border: 1px solid rgba(245,158,11,0.25); }
  .status-waiting { background: rgba(99,102,241,0.12);  color: #a5b4fc; border: 1px solid rgba(99,102,241,0.3);  }
  .status-stopped { background: rgba(239,68,68,0.12);   color: #fca5a5; border: 1px solid rgba(239,68,68,0.25);  }
  .status-dot { width: 6px; height: 6px; border-radius: 50%; }
  .status-dot.idle    { background: #71717a; }
  .status-dot.running { background: #10b981; animation: pulse-dot 1.5s infinite; }
  .status-dot.paused  { background: #f59e0b; }
  .status-dot.waiting { background: #6366f1; animation: pulse-dot 2s infinite; }
  .status-dot.stopped { background: #ef4444; }

  /* Control buttons */
  .ctrl-btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: all 0.15s; }
  .ctrl-btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .btn-start  { background: rgba(16,185,129,0.15); color: #6ee7b7; border-color: rgba(16,185,129,0.3); }
  .btn-pause  { background: rgba(245,158,11,0.15); color: #fcd34d; border-color: rgba(245,158,11,0.3); }
  .btn-stop   { background: rgba(239,68,68,0.15);  color: #fca5a5; border-color: rgba(239,68,68,0.3); }
  .btn-resume { background: rgba(99,102,241,0.15); color: #a5b4fc; border-color: rgba(99,102,241,0.3); }

  /* Pipeline diagram */
  .pipeline { display: flex; align-items: stretch; gap: 0; margin: 1.5rem 0; overflow-x: auto; padding-bottom: 0.5rem; }
  .pipeline-stage { flex: 1; min-width: 140px; background: rgba(26,26,36,0.8); border: 1px solid rgba(42,42,58,0.6); padding: 1rem; text-align: center; transition: all 0.2s; }
  .pipeline-stage:first-child { border-radius: 0.75rem 0 0 0.75rem; }
  .pipeline-stage:last-child  { border-radius: 0 0.75rem 0.75rem 0; }
  .pipeline-stage:hover { border-color: rgba(99,102,241,0.4); background: rgba(26,26,36,1); }
  .pipeline-stage .stage-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
  .pipeline-stage .stage-name { font-size: 0.8125rem; font-weight: 700; color: #e4e4e7; }
  .pipeline-stage .stage-desc { font-size: 0.6875rem; color: #71717a; margin-top: 0.25rem; line-height: 1.4; }
  .pipeline-arrow { display: flex; align-items: center; color: #6366f1; font-size: 1.25rem; padding: 0 0.125rem; z-index: 2; flex-shrink: 0; }

  /* Tier table */
  .tier-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
  .tier-table th { text-align: left; padding: 0.5rem 0.75rem; color: #71717a; font-weight: 600; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.04em; border-bottom: 1px solid #2a2a3a; }
  .tier-table td { padding: 0.625rem 0.75rem; border-bottom: 1px solid rgba(42,42,58,0.3); color: #d4d4d8; }
  .tier-table tr:hover td { background: rgba(99,102,241,0.04); }
  .tier-badge { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.6875rem; font-weight: 700; }
  .tier-t0 { background: rgba(16,185,129,0.12); color: #6ee7b7; }
  .tier-t1 { background: rgba(34,211,238,0.12); color: #22d3ee; }
  .tier-t2 { background: rgba(99,102,241,0.12); color: #a5b4fc; }
  .tier-t3 { background: rgba(245,158,11,0.12); color: #fcd34d; }

  /* Timeline / log */
  .loop-timeline { max-height: 340px; overflow-y: auto; }
  .loop-entry { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(42,42,58,0.3); }
  .loop-entry:last-child { border-bottom: none; }
  .loop-entry-idx { font-size: 0.75rem; font-weight: 700; color: #6366f1; min-width: 2rem; text-align: right; padding-top: 0.125rem; }
  .loop-entry-body { flex: 1; }
  .loop-entry-summary { font-size: 0.8125rem; color: #d4d4d8; }
  .loop-entry-meta { font-size: 0.6875rem; color: #52525b; margin-top: 0.125rem; display: flex; gap: 0.75rem; }

  /* Budget bar */
  .budget-bar-wrap { background: rgba(15,15,20,0.6); border-radius: 0.375rem; height: 1.25rem; overflow: hidden; position: relative; border: 1px solid rgba(42,42,58,0.4); }
  .budget-bar-fill { height: 100%; border-radius: 0.375rem; transition: width 0.5s ease; }
  .budget-bar-text { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.6875rem; font-weight: 700; color: #fff; }

  /* Tool chips */
  .tool-chip { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.625rem; background: rgba(42,42,58,0.4); border: 1px solid rgba(42,42,58,0.6); border-radius: 0.375rem; font-size: 0.75rem; color: #a1a1aa; font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace; }

  /* Countdown */
  .countdown { font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace; font-size: 2rem; font-weight: 800; color: #818cf8; letter-spacing: 0.05em; }

  /* Toggle switch (matches settings) */
  .agi-toggle { width: 2.5rem; height: 1.25rem; border-radius: 9999px; position: relative; cursor: pointer; transition: background 0.2s; border: none; }
  .agi-toggle span { position: absolute; top: 0.125rem; width: 1rem; height: 1rem; background: #fff; border-radius: 50%; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  .agi-toggle.on  { background: #10b981; }
  .agi-toggle.on span  { right: 0.125rem; left: auto; }
  .agi-toggle.off { background: #52525b; }
  .agi-toggle.off span { left: 0.125rem; right: auto; }

  /* ── Tier Editor Modal ── */
  .tier-modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 1000;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    animation: tierFadeIn 0.15s ease;
  }
  .tier-modal-overlay.active { display: flex; align-items: center; justify-content: center; }
  @keyframes tierFadeIn { from { opacity: 0; } to { opacity: 1; } }

  .tier-modal {
    background: #13131a; border: 1px solid #2a2a3a; border-radius: 0.75rem;
    width: 100%; max-width: 56rem; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    animation: tierSlideIn 0.2s ease;
  }
  @keyframes tierSlideIn { from { opacity: 0; transform: translateY(12px) scale(0.98); } to { opacity: 1; transform: none; } }

  .tier-modal-head {
    display: flex; align-items: center; justify-content: space-between;
    padding: 1rem 1.25rem; border-bottom: 1px solid #2a2a3a;
  }
  .tier-modal-head-left { display: flex; align-items: center; gap: 0.75rem; }
  .tier-modal-badge {
    padding: 0.25rem 0.625rem; border-radius: 0.25rem; font-size: 0.75rem;
    font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
  }
  .tier-modal-title {
    font-size: 1rem; font-weight: 800; color: #fff;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
  }
  .tier-modal-head-right { display: flex; align-items: center; gap: 0.75rem; }
  .tier-modal-enabled { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8125rem; color: #a1a1aa; }
  .tier-modal-close {
    background: none; border: none; color: #52525b; font-size: 1.25rem;
    cursor: pointer; padding: 0.25rem; line-height: 1; transition: color 0.15s;
  }
  .tier-modal-close:hover { color: #fff; }

  .tier-modal-body { padding: 1.25rem; }

  .tier-form-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;
  }
  @media (max-width: 640px) { .tier-form-row { grid-template-columns: 1fr; } }

  .tier-form-group { display: flex; flex-direction: column; gap: 0.25rem; }
  .tier-form-label {
    font-size: 0.6875rem; font-weight: 700; color: #52525b;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  .tier-form-select, .tier-form-input {
    background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 0.5rem;
    color: #d4d4d8; font-size: 0.875rem; padding: 0.625rem 0.75rem;
    outline: none; transition: border-color 0.15s; width: 100%;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
  }
  .tier-form-select:focus, .tier-form-input:focus { border-color: #6366f1; }
  .tier-form-select option { background: #1a1a24; color: #d4d4d8; }

  .tier-params-row {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.25rem;
  }
  @media (max-width: 640px) { .tier-params-row { grid-template-columns: repeat(2, 1fr); } }
  .tier-param-card {
    background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 0.5rem;
    padding: 0.75rem 0.875rem;
  }
  .tier-param-label {
    font-size: 0.625rem; font-weight: 700; color: #52525b;
    text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.375rem;
  }
  .tier-param-input {
    width: 100%; background: transparent; border: none; outline: none;
    color: #fff; font-size: 1.125rem; font-weight: 700;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
  }

  /* Alt models section */
  .tier-alts-section {
    border-top: 1px solid #2a2a3a; padding-top: 1rem; margin-top: 0.5rem;
  }
  .tier-alts-header {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;
  }
  .tier-alts-title { font-size: 0.75rem; font-weight: 700; color: #71717a; text-transform: uppercase; letter-spacing: 0.05em; }
  .tier-alt-row {
    display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;
  }
  .tier-alt-label {
    font-size: 0.6875rem; font-weight: 700; color: #52525b;
    min-width: 2.5rem; text-transform: uppercase;
  }
  .tier-alt-remove {
    background: none; border: none; color: #52525b; cursor: pointer;
    font-size: 1rem; padding: 0.25rem; transition: color 0.15s;
  }
  .tier-alt-remove:hover { color: #fca5a5; }

  .tier-modal-footer {
    display: flex; align-items: center; justify-content: flex-end; gap: 0.75rem;
    padding: 1rem 1.25rem; border-top: 1px solid #2a2a3a;
  }
  .tier-btn {
    padding: 0.5rem 1.25rem; border-radius: 0.5rem; font-size: 0.8125rem;
    font-weight: 600; cursor: pointer; transition: all 0.15s; border: none;
  }
  .tier-btn-primary { background: #6366f1; color: #fff; }
  .tier-btn-primary:hover { background: #4f46e5; }
  .tier-btn-secondary { background: rgba(42,42,58,0.5); color: #a1a1aa; border: 1px solid #2a2a3a; }
  .tier-btn-secondary:hover { background: rgba(42,42,58,0.8); color: #e4e4e7; }
  .tier-btn-add {
    display: inline-flex; align-items: center; gap: 0.25rem;
    padding: 0.25rem 0.625rem; font-size: 0.75rem; font-weight: 600;
    background: rgba(99,102,241,0.1); color: #818cf8; border: 1px solid rgba(99,102,241,0.2);
    border-radius: 0.375rem; cursor: pointer; transition: all 0.15s;
  }
  .tier-btn-add:hover { background: rgba(99,102,241,0.2); }

  /* Clickable tier row */
  .tier-table tbody tr { cursor: pointer; transition: all 0.15s; }
  .tier-table tbody tr:hover { background: rgba(99,102,241,0.08); }
  .tier-table tbody tr:active { background: rgba(99,102,241,0.12); }
  .tier-enabled-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 0.375rem; }
  .tier-enabled-dot.on { background: #10b981; }
  .tier-enabled-dot.off { background: #52525b; }
  .tier-edit-hint { font-size: 0.6875rem; color: #3f3f46; margin-left: 0.5rem; opacity: 0; transition: opacity 0.15s; }
  .tier-table tbody tr:hover .tier-edit-hint { opacity: 1; }
</style>

<div>
  <!-- â”€â”€ Page Header â”€â”€ -->
  <div class="mb-6 flex items-center justify-between flex-wrap gap-3">
    <div>
      <h1 class="text-2xl font-bold text-white flex items-center gap-2">
        <span class="text-forge-accent">âˆž</span> AGI Loop
      </h1>
      <p class="text-sm text-forge-muted mt-1">Autonomous burst scheduling, tiered routing &amp; budget-aware execution</p>
    </div>
    <span class="status-badge status-idle" id="global-status">
      <span class="status-dot idle" id="global-dot"></span>
      <span id="global-status-text">Idle</span>
    </span>
  </div>

  <!-- Preview banner -->
  <div class="p-3 rounded-lg border border-yellow-700/40 bg-yellow-900/10 mb-5 flex items-center gap-2 text-sm text-yellow-300">
    <span>âš </span>
    <span><strong>Preview Mode</strong> â€” Settings below are saved locally. The backend at <code class="text-yellow-200">agent-runtime</code> is not connected.</span>
  </div>

  <!-- â”€â”€ Tabs â”€â”€ -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('config')">Configuration</button>
    <button class="tab-btn" onclick="switchTab('pipeline')">Pipeline</button>
    <button class="tab-btn" onclick="switchTab('routing')">Model Router</button>
    <button class="tab-btn" onclick="switchTab('budget')">Budget</button>
    <button class="tab-btn" onclick="switchTab('log')">Loop Log</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB: Dashboard                                                  -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-panel active" id="panel-dashboard">
    <!-- Stats -->
    <div class="grid grid-cols-4 gap-3 mb-5 max-md:grid-cols-2">
      <div class="card text-center">
        <div class="text-3xl font-extrabold text-white" id="stat-loops">0</div>
        <div class="text-xs text-forge-muted uppercase tracking-wider mt-0.5">Loops Completed</div>
      </div>
      <div class="card text-center">
        <div class="text-3xl font-extrabold text-white" id="stat-ticks">0</div>
        <div class="text-xs text-forge-muted uppercase tracking-wider mt-0.5">Total Ticks</div>
      </div>
      <div class="card text-center">
        <div class="text-3xl font-extrabold text-white" id="stat-errors">0</div>
        <div class="text-xs text-forge-muted uppercase tracking-wider mt-0.5">Errors</div>
      </div>
      <div class="card text-center">
        <div class="text-3xl font-extrabold text-white" id="stat-cost">$0.00</div>
        <div class="text-xs text-forge-muted uppercase tracking-wider mt-0.5">Total Cost</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card mb-5">
      <div class="flex items-center justify-between mb-4">
        <div>
          <span class="card-header mb-0">Loop Controls</span>
          <p class="text-xs text-forge-muted mt-1">Start, pause, resume, or stop the autonomous loop</p>
        </div>
        <span class="status-badge status-idle" id="ctrl-status">
          <span class="status-dot idle" id="ctrl-dot"></span>
          <span id="ctrl-status-text">Idle</span>
        </span>
      </div>
      <div class="flex gap-2 flex-wrap mb-4">
        <button class="ctrl-btn btn-start" onclick="demoAction('start')">â–¶ Start</button>
        <button class="ctrl-btn btn-pause" onclick="demoAction('pause')">â¸ Pause</button>
        <button class="ctrl-btn btn-resume" onclick="demoAction('resume')">âµ Resume</button>
        <button class="ctrl-btn btn-stop" onclick="demoAction('stop')">â¹ Stop</button>
      </div>
      <div class="flex items-center gap-6 flex-wrap">
        <div>
          <div class="text-xs text-forge-muted uppercase tracking-wider">Next Loop In</div>
          <div class="countdown" id="countdown-display">--:--:--</div>
        </div>
        <div class="flex-1 min-w-[160px]">
          <div class="text-xs text-forge-muted uppercase tracking-wider">Current Profile</div>
          <div class="text-base font-bold text-white mt-0.5" id="dash-profile">{{ config.profile }}</div>
        </div>
        <div>
          <div class="text-xs text-forge-muted uppercase tracking-wider">Mode</div>
          <div class="text-base font-bold text-forge-accent2 mt-0.5" id="dash-mode">{{ 'âˆž Infinite' if config.max_loops == 0 else config.max_loops ~ ' loops' }}</div>
        </div>
      </div>
    </div>

    <!-- Burst-Mode Allowed Tools -->
    <div class="card mb-5">
      <span class="card-header">Burst-Mode Allowed Tools</span>
      <p class="text-xs text-forge-muted mt-1 mb-3">Tools the agent can invoke autonomously during burst ticks. All sandboxed with boundary enforcement.</p>
      <div class="flex flex-wrap gap-1.5">
        <span class="tool-chip">memory.recall</span>
        <span class="tool-chip">memory.search</span>
        <span class="tool-chip">memory.add</span>
        <span class="tool-chip">memory.bulk_add</span>
        <span class="tool-chip">memory.update</span>
        <span class="tool-chip">memory.delete</span>
        <span class="tool-chip">memory.bulk_delete</span>
        <span class="tool-chip">inbox.send</span>
        <span class="tool-chip">directives.search</span>
        <span class="tool-chip">directives.list</span>
        <span class="tool-chip">directives.get</span>
        <span class="tool-chip">directives.manifest</span>
        <span class="tool-chip">directives.changes</span>
        <span class="tool-chip">task_inbox.add</span>
        <span class="tool-chip">task_inbox.next</span>
        <span class="tool-chip">task_inbox.ack</span>
        <span class="tool-chip">runtime_info</span>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB: Configuration  (Settings-style, fully working)            -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-panel" id="panel-config">

    <!-- Schedule Settings -->
    <div class="card mb-5">
      <div class="flex items-center justify-between mb-4">
        <div>
          <span class="card-header mb-0">Schedule Settings</span>
          <p class="text-xs text-forge-muted mt-1">Configure loop timing, tick count, and step limits</p>
        </div>
        <button onclick="saveConfig()" class="filter-btn active" style="cursor:pointer;" id="btn-save-schedule">Save</button>
      </div>
      <div class="space-y-4">
        <!-- Interval -->
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div>
              <div class="text-sm font-semibold text-white">Loop Interval</div>
              <p class="text-xs text-forge-muted mt-0.5">Time between burst cycles</p>
            </div>
            <div class="flex items-center gap-2">
              <input type="number" id="cfg-interval-hours" min="0" max="24"
                     value="{{ config.interval_hours }}"
                     class="search-input w-20 text-center" placeholder="0">
              <span class="text-xs text-forge-muted">h</span>
              <input type="number" id="cfg-interval-minutes" min="0" max="59"
                     value="{{ config.interval_minutes }}"
                     class="search-input w-20 text-center" placeholder="30">
              <span class="text-xs text-forge-muted">m</span>
            </div>
          </div>
        </div>
        <!-- Ticks / Steps row -->
        <div class="grid grid-cols-2 gap-3 max-md:grid-cols-1">
          <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold text-white">Ticks per Loop</div>
                <p class="text-xs text-forge-muted mt-0.5">Burst ticks executed each cycle</p>
              </div>
              <input type="number" id="cfg-ticks" min="1" max="50"
                     value="{{ config.ticks_per_loop }}"
                     class="search-input w-20 text-center">
            </div>
          </div>
          <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm font-semibold text-white">Max Steps per Tick</div>
                <p class="text-xs text-forge-muted mt-0.5">LLM calls allowed per tick</p>
              </div>
              <input type="number" id="cfg-steps" min="1" max="10"
                     value="{{ config.max_steps_per_tick }}"
                     class="search-input w-20 text-center">
            </div>
          </div>
        </div>
        <!-- Max loops -->
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div>
              <div class="text-sm font-semibold text-white">Max Loops</div>
              <p class="text-xs text-forge-muted mt-0.5">0 = infinite (runs until manually stopped)</p>
            </div>
            <input type="number" id="cfg-max-loops" min="0"
                   value="{{ config.max_loops }}"
                   class="search-input w-24 text-center">
          </div>
        </div>
        <!-- Profile -->
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div>
              <div class="text-sm font-semibold text-white">Agent Profile</div>
              <p class="text-xs text-forge-muted mt-0.5">Which agent runs the autonomous loop</p>
            </div>
            <select id="cfg-profile" class="search-input w-40">
              {% for agent in agents %}
              <option value="{{ agent }}" {{ 'selected' if agent == config.profile else '' }}>{{ agent }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <!-- Stimulus -->
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <div class="flex-1 min-w-[200px]">
              <div class="text-sm font-semibold text-white">Stimulus</div>
              <p class="text-xs text-forge-muted mt-0.5">Optional seed message injected into first user msg each tick</p>
            </div>
            <input type="text" id="cfg-stimulus"
                   value="{{ config.stimulus }}"
                   class="search-input flex-1 min-w-[200px]" placeholder="Optional seed messageâ€¦">
          </div>
        </div>
      </div>
    </div>

    <!-- Safety & Guardrails -->
    <div class="card mb-5">
      <div class="flex items-center justify-between mb-4">
        <div>
          <span class="card-header mb-0">Safety &amp; Guardrails</span>
          <p class="text-xs text-forge-muted mt-1">Auto-pause triggers and budget protection</p>
        </div>
        <button onclick="saveConfig()" class="filter-btn active" style="cursor:pointer;">Save</button>
      </div>
      <div class="space-y-3">
        <!-- Auto-pause on budget -->
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button onclick="toggleBudgetPause()" id="toggle-budget-pause"
                    class="agi-toggle {{ 'on' if config.auto_pause_on_budget else 'off' }}">
              <span></span>
            </button>
            <div>
              <div class="text-sm font-semibold text-white">Auto-Pause on Budget</div>
              <p class="text-xs text-forge-muted mt-0.5">Scheduler pauses when BudgetTracker reports hard limit hit</p>
            </div>
          </div>
          <span class="badge badge-scope">{{ 'Enabled' if config.auto_pause_on_budget else 'Disabled' }}</span>
        </div>
        <!-- Error streak -->
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg flex items-center justify-between flex-wrap gap-3">
          <div>
            <div class="text-sm font-semibold text-white">Error Streak Limit</div>
            <p class="text-xs text-forge-muted mt-0.5">Auto-pause after N consecutive errors (0 = disabled)</p>
          </div>
          <input type="number" id="cfg-error-streak" min="0" max="50"
                 value="{{ config.auto_pause_on_error_streak }}"
                 class="search-input w-20 text-center">
        </div>
      </div>
    </div>

    <!-- Lifecycle states reference -->
    <div class="card mb-5">
      <span class="card-header">Lifecycle States</span>
      <p class="text-xs text-forge-muted mt-1 mb-3">The scheduler transitions between these states automatically</p>
      <div class="space-y-2">
        <div class="flex items-center gap-3">
          <span class="status-badge status-idle"><span class="status-dot idle"></span> Idle</span>
          <span class="text-xs text-forge-muted">â€” Initial state, no schedule running</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="status-badge status-running"><span class="status-dot running"></span> Running</span>
          <span class="text-xs text-forge-muted">â€” Executing a burst cycle</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="status-badge status-waiting"><span class="status-dot waiting"></span> Waiting</span>
          <span class="text-xs text-forge-muted">â€” Countdown between loop cycles</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="status-badge status-paused"><span class="status-dot paused"></span> Paused</span>
          <span class="text-xs text-forge-muted">â€” Manual or auto-pause (budget/error streak)</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="status-badge status-stopped"><span class="status-dot stopped"></span> Stopped</span>
          <span class="text-xs text-forge-muted">â€” Terminated or max loops reached</span>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB: Pipeline                                                   -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-panel" id="panel-pipeline">
    <div class="card mb-5">
      <span class="card-header">Execution Pipeline</span>
      <p class="text-xs text-forge-muted mt-1 mb-4">Each loop fires a <strong class="text-zinc-300">burst</strong> of ticks. Each tick is a bounded mini-loop under strict policy control.</p>

      <div class="pipeline">
        <div class="pipeline-stage">
          <div class="stage-icon">ðŸ“…</div>
          <div class="stage-name">Scheduler</div>
          <div class="stage-desc">TickScheduler manages timing, pause/resume, finite/infinite loop control</div>
        </div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-stage">
          <div class="stage-icon">ðŸ’°</div>
          <div class="stage-name">Budget Gate</div>
          <div class="stage-desc">BudgetTracker checks monthly/session/tick caps before execution</div>
        </div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-stage">
          <div class="stage-icon">âš¡</div>
          <div class="stage-name">Burst Runner</div>
          <div class="stage-desc">Fires N ticks linearly, collecting outcomes and metering data</div>
        </div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-stage">
          <div class="stage-icon">ðŸ§ </div>
          <div class="stage-name">Tick Engine</div>
          <div class="stage-desc">Builds prompt (system + memory + directives + notes), runs steps</div>
        </div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-stage">
          <div class="stage-icon">ðŸ”€</div>
          <div class="stage-name">Model Router</div>
          <div class="stage-desc">Selects tier (T0â€“T3) based on task type, budget, and escalation</div>
        </div>
        <div class="pipeline-arrow">â†’</div>
        <div class="pipeline-stage">
          <div class="stage-icon">ðŸ“</div>
          <div class="stage-name">Context Mgr</div>
          <div class="stage-desc">Rolling window + working set. Compacts old messages to vault</div>
        </div>
      </div>
    </div>

    <!-- Tick anatomy -->
    <div class="card mb-5">
      <span class="card-header">Anatomy of a Tick</span>
      <p class="text-xs text-forge-muted mt-1 mb-4">Each tick is a bounded mini-loop. The agent must respond with structured JSON step objects.</p>

      <div class="grid grid-cols-3 gap-3 max-md:grid-cols-1 max-lg:grid-cols-2">
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="text-sm font-bold text-cyan-300 mb-1">1. Prompt Assembly</div>
          <p class="text-xs text-zinc-400 leading-relaxed">Base system prompt + FAISS memory injection + directive soul-scripts + always-on notes + working set state</p>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="text-sm font-bold text-indigo-300 mb-1">2. Step Loop</div>
          <p class="text-xs text-zinc-400 leading-relaxed">Up to <code class="text-indigo-300">max_steps_per_tick</code> LLM calls. Each outputs JSON: <code class="text-emerald-300">think</code>, <code class="text-cyan-300">tool</code>, or <code class="text-red-300">stop</code></p>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="text-sm font-bold text-emerald-300 mb-1">3. Tool Dispatch</div>
          <p class="text-xs text-zinc-400 leading-relaxed">Max <code class="text-indigo-300">max_tool_calls_per_tick</code> invocations. Boundary logger enforces safety. Stasis blocks all non-runtime_info</p>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="text-sm font-bold text-yellow-300 mb-1">4. Memory Flush</div>
          <p class="text-xs text-zinc-400 leading-relaxed">Proposed memories collected across steps are bulk-persisted to FAISS vault at end-of-tick with scope, category, and tags</p>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="text-sm font-bold text-red-300 mb-1">5. Metering &amp; Journaling</div>
          <p class="text-xs text-zinc-400 leading-relaxed">Token usage, estimated cost, step summaries logged. NarrativeWriter creates human-readable diary entries</p>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg">
          <div class="text-sm font-bold text-purple-300 mb-1">6. Outcome Report</div>
          <p class="text-xs text-zinc-400 leading-relaxed">Each tick returns a <code class="text-indigo-300">TickOutcome</code>: steps, tools, memories, errors, cost â€” aggregated at burst level</p>
        </div>
      </div>
    </div>

    <!-- Step Protocol -->
    <div class="card mb-5">
      <span class="card-header">Step Protocol Schema</span>
      <p class="text-xs text-forge-muted mt-1 mb-3">Every LLM response in burst mode must be exactly one JSON object:</p>
      <pre class="p-4 rounded-lg border border-forge-border bg-forge-bg text-xs text-zinc-300 overflow-x-auto leading-relaxed">{
  "step_summary": "1-2 sentence description",
  "action": "think" | "tool" | "stop",
  "tool_name": "memory | inbox | directives | runtime_info | task_inbox | null",
  "tool_args": { "action": "...", ... } | null,
  "proposed_memories": [
    { "text": "...", "scope": "shared|orion|elysia", "category": "...", "tags": [...] }
  ],
  "stop_reason": "why stopping, or null"
}</pre>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB: Model Router                                               -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-panel" id="panel-routing">
    <div class="card mb-5">
      <div class="flex items-center justify-between mb-4">
        <div>
          <span class="card-header mb-0">Tiered Model Router</span>
          <p class="text-xs text-forge-muted mt-1">Click any tier to edit its configuration. Automatically selects the cheapest capable tier per task.</p>
        </div>
        <button onclick="saveTiers()" class="filter-btn active" style="cursor:pointer;" id="btn-save-tiers">Save Tiers</button>
      </div>

      <table class="tier-table">
        <thead>
          <tr><th></th><th>Tier</th><th>Label</th><th>Connection / Model</th><th>Cost/Call</th><th>Default For</th></tr>
        </thead>
        <tbody id="tier-table-body"></tbody>
      </table>
      <div style="margin-top:0.75rem; text-align:right;">
        <button onclick="addNewTier()" class="tier-btn-add" title="Add a new tier">+ Add Tier</button>
      </div>
    </div>

    <!-- Tier Editor Modal -->
    <div class="tier-modal-overlay" id="tier-modal-overlay">
      <div class="tier-modal">
        <div class="tier-modal-head">
          <div class="tier-modal-head-left">
            <span class="tier-modal-badge" id="tm-badge">T0</span>
            <input type="text" id="tm-label" class="tier-form-input" style="width:14rem;font-size:0.875rem;font-weight:700;" placeholder="tier_label">
          </div>
          <div class="tier-modal-head-right">
            <label class="tier-modal-enabled">
              <button type="button" class="agi-toggle on" id="tm-enabled" onclick="toggleModalEnabled()">
                <span></span>
              </button>
              <span id="tm-enabled-text">Enabled</span>
            </label>
            <button class="tier-modal-close" onclick="closeTierModal()">&times;</button>
          </div>
        </div>
        <div class="tier-modal-body">
          <!-- Connection & Model row -->
          <div class="tier-form-row">
            <div class="tier-form-group">
              <label class="tier-form-label">Connection / API</label>
              <select id="tm-connection" class="tier-form-select" onchange="onConnectionChange()">
                <option value="">-- none (manual provider) --</option>
              </select>
            </div>
            <div class="tier-form-group">
              <label class="tier-form-label">Primary Model</label>
              <div style="display:flex;gap:0.5rem;">
                <select id="tm-model-select" class="tier-form-select" style="flex:1;" onchange="onModelSelectChange()">
                  <option value="">-- type custom --</option>
                </select>
                <input type="text" id="tm-model" class="tier-form-input" placeholder="model-name" style="flex:1;">
              </div>
            </div>
          </div>

          <!-- Params row -->
          <div class="tier-params-row">
            <div class="tier-param-card">
              <div class="tier-param-label">Temperature</div>
              <input type="number" step="0.1" min="0" max="2" id="tm-temperature" class="tier-param-input" value="0.6">
            </div>
            <div class="tier-param-card">
              <div class="tier-param-label">Max Output Tokens</div>
              <input type="number" step="256" min="0" id="tm-max-tokens" class="tier-param-input" value="2048">
            </div>
            <div class="tier-param-card">
              <div class="tier-param-label">Max Iterations</div>
              <input type="number" step="1" min="1" id="tm-max-iter" class="tier-param-input" value="8">
            </div>
            <div class="tier-param-card">
              <div class="tier-param-label">Retries Before Escalate</div>
              <input type="number" step="1" min="0" id="tm-retries" class="tier-param-input" value="3">
            </div>
          </div>

          <!-- Extra settings row -->
          <div class="tier-form-row">
            <div class="tier-form-group">
              <label class="tier-form-label">Default For (task types)</label>
              <input type="text" id="tm-default-for" class="tier-form-input" placeholder="e.g. Memory ops, reflection, summarization">
            </div>
            <div class="tier-form-group">
              <label class="tier-form-label">Cost Per Call (display)</label>
              <input type="text" id="tm-cost" class="tier-form-input" placeholder="e.g. ~$0.00">
            </div>
          </div>

          <!-- Alternate Models -->
          <div class="tier-alts-section">
            <div class="tier-alts-header">
              <span class="tier-alts-title">Alternate Models (fallbacks within this tier)</span>
              <button class="tier-btn-add" onclick="addAltModel()">+ Add</button>
            </div>
            <div id="tm-alt-list"></div>
          </div>
        </div>
        <div class="tier-modal-footer">
          <button class="tier-btn tier-btn-secondary" onclick="deleteTierFromModal()" id="tm-delete" style="margin-right:auto;color:#fca5a5;border-color:rgba(239,68,68,0.3);">Delete Tier</button>
          <button class="tier-btn tier-btn-secondary" onclick="closeTierModal()">Cancel</button>
          <button class="tier-btn tier-btn-primary" onclick="saveTierFromModal()">Apply</button>
        </div>
      </div>
    </div>

    <!-- Escalation -->
    <div class="card mb-5">
      <span class="card-header">Escalation Logic</span>
      <div class="grid grid-cols-2 gap-5 mt-3 max-md:grid-cols-1">
        <div>
          <div class="text-sm font-bold text-white mb-2">Routing Algorithm</div>
          <ol class="text-sm text-zinc-400 leading-loose pl-5 list-decimal">
            <li>Classify task type from metadata</li>
            <li>Start at lowest tier that handles the task class</li>
            <li>If verification fails, retry once at same tier</li>
            <li>If stuck (same error 3+ times), escalate one tier</li>
            <li>Enforce hard caps on iterations and tokens per tier</li>
            <li>Budget gates refuse escalation if budget exceeded</li>
          </ol>
        </div>
        <div>
          <div class="text-sm font-bold text-white mb-2">Task Classification Keywords</div>
          <div class="space-y-1 text-xs">
            <div><span class="text-cyan-300 font-semibold">Coding:</span> <span class="text-zinc-500">code, program, debug, implement, refactorâ€¦</span></div>
            <div><span class="text-emerald-300 font-semibold">Summarization:</span> <span class="text-zinc-500">summarize, recap, digest, tldrâ€¦</span></div>
            <div><span class="text-indigo-300 font-semibold">Planning:</span> <span class="text-zinc-500">plan, strategy, roadmap, architectureâ€¦</span></div>
            <div><span class="text-red-300 font-semibold">High Stakes:</span> <span class="text-zinc-500">critical, production, deploy, securityâ€¦</span></div>
            <div><span class="text-yellow-300 font-semibold">Final Polish:</span> <span class="text-zinc-500">final review, polish, ship it, releaseâ€¦</span></div>
            <div><span class="text-purple-300 font-semibold">Memory Ops:</span> <span class="text-zinc-500">remember, recall, vault, storeâ€¦</span></div>
            <div><span class="text-pink-300 font-semibold">Reflection:</span> <span class="text-zinc-500">reflect, introspect, think aboutâ€¦</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Context Manager -->
    <div class="card mb-5">
      <span class="card-header">Context Manager</span>
      <p class="text-xs text-forge-muted mt-1 mb-4">Rolling context window with budget-aware sizing. Compacts old messages into the memory vault.</p>
      <div class="grid grid-cols-3 gap-3 max-md:grid-cols-1">
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg text-center">
          <div class="text-2xl font-extrabold text-emerald-300">â‰¤4K</div>
          <div class="text-xs text-forge-muted uppercase tracking-wider mt-1">Small (local_cheap)</div>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg text-center">
          <div class="text-2xl font-extrabold text-indigo-300">â‰¤16K</div>
          <div class="text-xs text-forge-muted uppercase tracking-wider mt-1">Moderate (cheap_cloud)</div>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg text-center">
          <div class="text-2xl font-extrabold text-yellow-300">â‰¤64K</div>
          <div class="text-xs text-forge-muted uppercase tracking-wider mt-1">Large (expensive_cloud)</div>
        </div>
      </div>
      <p class="text-sm text-zinc-400 mt-4 leading-relaxed">
        <strong class="text-white">Working Set</strong> â€” Hot state object persisted across ticks: objectives, recent decisions, error context, and compaction summaries.
        Formatted as a system prompt section for continuity without re-reading full history.
      </p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB: Budget                                                     -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-panel" id="panel-budget">
    <!-- Budget Config -->
    <div class="card mb-5">
      <div class="flex items-center justify-between mb-4">
        <div>
          <span class="card-header mb-0">Budget Limits</span>
          <p class="text-xs text-forge-muted mt-1">Configure monthly, per-session, and per-tick spending caps</p>
        </div>
        <button onclick="saveConfig()" class="filter-btn active" style="cursor:pointer;">Save</button>
      </div>
      <div class="space-y-3">
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg flex items-center justify-between flex-wrap gap-3">
          <div>
            <div class="text-sm font-semibold text-white">Monthly Hard Cap</div>
            <p class="text-xs text-forge-muted mt-0.5">Maximum monthly spending â€” blocks all calls when hit</p>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-sm text-forge-muted">$</span>
            <input type="number" id="cfg-monthly-hard" min="0" step="0.50"
                   value="{{ config.monthly_hard_cap }}"
                   class="search-input w-24 text-center">
          </div>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg flex items-center justify-between flex-wrap gap-3">
          <div>
            <div class="text-sm font-semibold text-white">Monthly Soft Cap</div>
            <p class="text-xs text-forge-muted mt-0.5">Triggers tier demotion warnings (typically 80% of hard cap)</p>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-sm text-forge-muted">$</span>
            <input type="number" id="cfg-monthly-soft" min="0" step="0.50"
                   value="{{ config.monthly_soft_cap }}"
                   class="search-input w-24 text-center">
          </div>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg flex items-center justify-between flex-wrap gap-3">
          <div>
            <div class="text-sm font-semibold text-white">Per-Session Cap</div>
            <p class="text-xs text-forge-muted mt-0.5">Maximum spending per interactive session</p>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-sm text-forge-muted">$</span>
            <input type="number" id="cfg-session-cap" min="0" step="0.10"
                   value="{{ config.per_session_cap }}"
                   class="search-input w-24 text-center">
          </div>
        </div>
        <div class="p-4 rounded-lg border border-forge-border bg-forge-bg flex items-center justify-between flex-wrap gap-3">
          <div>
            <div class="text-sm font-semibold text-white">Per-Tick Cap</div>
            <p class="text-xs text-forge-muted mt-0.5">Maximum spending per burst tick</p>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-sm text-forge-muted">$</span>
            <input type="number" id="cfg-tick-cap" min="0" step="0.01"
                   value="{{ config.per_tick_cap }}"
                   class="search-input w-24 text-center">
          </div>
        </div>
      </div>
    </div>

    <!-- Budget progress (demo) -->
    <div class="card mb-5">
      <span class="card-header">Current Spending</span>
      <p class="text-xs text-forge-muted mt-1 mb-4">Live spending data will appear when the backend is connected</p>
      <div class="space-y-5">
        <div>
          <div class="flex justify-between mb-1">
            <span class="text-xs text-zinc-400 font-semibold">Monthly Spend</span>
            <span class="text-xs text-zinc-300">$0.00 / $<span id="budget-hard-display">{{ config.monthly_hard_cap }}</span></span>
          </div>
          <div class="budget-bar-wrap">
            <div class="budget-bar-fill" style="width: 0%; background: linear-gradient(90deg, #6366f1, #818cf8);"></div>
            <div class="budget-bar-text">0%</div>
          </div>
          <div class="flex justify-between mt-1">
            <span class="text-xs text-zinc-600">Soft: $<span id="budget-soft-display">{{ config.monthly_soft_cap }}</span></span>
            <span class="text-xs text-zinc-600">Hard: $<span id="budget-hard-display2">{{ config.monthly_hard_cap }}</span></span>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-1">
            <span class="text-xs text-zinc-400 font-semibold">Session Spend</span>
            <span class="text-xs text-zinc-300">$0.00 / $<span id="budget-session-display">{{ config.per_session_cap }}</span></span>
          </div>
          <div class="budget-bar-wrap">
            <div class="budget-bar-fill" style="width: 0%; background: linear-gradient(90deg, #22d3ee, #67e8f9);"></div>
            <div class="budget-bar-text">0%</div>
          </div>
        </div>
        <div>
          <div class="flex justify-between mb-1">
            <span class="text-xs text-zinc-400 font-semibold">Per-Tick Cap</span>
            <span class="text-xs text-zinc-300">$<span id="budget-tick-display">{{ config.per_tick_cap }}</span> max</span>
          </div>
          <div class="budget-bar-wrap">
            <div class="budget-bar-fill" style="width: 0%; background: linear-gradient(90deg, #10b981, #6ee7b7);"></div>
            <div class="budget-bar-text">0%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tier cost breakdown -->
    <div class="card mb-5">
      <span class="card-header">Tier Cost Breakdown</span>
      <p class="text-xs text-forge-muted mt-1 mb-3">Spending per model tier â€” populated when backend is connected</p>
      <table class="tier-table">
        <thead>
          <tr><th>Tier</th><th>Calls</th><th>Tokens</th><th>Cost</th><th>% of Budget</th></tr>
        </thead>
        <tbody>
          <tr>
            <td><span class="tier-badge tier-t0">T0 local_cheap</span></td>
            <td class="text-zinc-500">â€”</td><td class="text-zinc-500">â€”</td>
            <td class="text-emerald-300">$0.00</td><td class="text-zinc-500">0%</td>
          </tr>
          <tr>
            <td><span class="tier-badge tier-t1">T1 local_strong</span></td>
            <td class="text-zinc-500">â€”</td><td class="text-zinc-500">â€”</td>
            <td class="text-cyan-300">$0.00</td><td class="text-zinc-500">0%</td>
          </tr>
          <tr>
            <td><span class="tier-badge tier-t2">T2 cheap_cloud</span></td>
            <td class="text-zinc-500">â€”</td><td class="text-zinc-500">â€”</td>
            <td class="text-indigo-300">$0.00</td><td class="text-zinc-500">0%</td>
          </tr>
          <tr>
            <td><span class="tier-badge tier-t3">T3 expensive_cloud</span></td>
            <td class="text-zinc-500">â€”</td><td class="text-zinc-500">â€”</td>
            <td class="text-yellow-300">$0.00</td><td class="text-zinc-500">0%</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Budget rules -->
    <div class="card mb-5">
      <span class="card-header">Budget Rules</span>
      <div class="grid grid-cols-2 gap-3 mt-3 max-md:grid-cols-1">
        <div class="p-4 rounded-lg border border-yellow-700/30 bg-yellow-900/5">
          <div class="text-sm font-bold text-yellow-300 mb-2">Soft Limit (80%)</div>
          <ul class="text-xs text-zinc-400 leading-relaxed pl-4 list-disc">
            <li>Triggers warning in journal</li>
            <li>Forces tier demotion (T3â†’T2, T2â†’T1)</li>
            <li>Does not stop execution</li>
          </ul>
        </div>
        <div class="p-4 rounded-lg border border-red-700/30 bg-red-900/5">
          <div class="text-sm font-bold text-red-300 mb-2">Hard Limit (100%)</div>
          <ul class="text-xs text-zinc-400 leading-relaxed pl-4 list-disc">
            <li>Blocks all LLM calls immediately</li>
            <li>Scheduler auto-pauses</li>
            <li>Requires manual reset or new month</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!--  TAB: Loop Log                                                   -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view-panel" id="panel-log">
    <div class="card mb-5">
      <span class="card-header">Loop Execution Log</span>
      <p class="text-xs text-forge-muted mt-1 mb-3">Recent loop cycle outcomes. Full journal: <code class="text-zinc-400">data/{profile}/burst_journal.jsonl</code></p>

      <div class="loop-timeline" id="loop-log-list">
        <div class="loop-entry">
          <div class="loop-entry-idx">#5</div>
          <div class="loop-entry-body">
            <div class="loop-entry-summary">Agent reflected on current objectives. Recalled 3 relevant memories from vault. Updated working set with new goal.</div>
            <div class="loop-entry-meta">
              <span>15 ticks</span><span>0 errors</span>
              <span class="text-emerald-400">$0.0042</span>
              <span>2026-02-27T14:30:00Z</span>
            </div>
          </div>
        </div>
        <div class="loop-entry">
          <div class="loop-entry-idx">#4</div>
          <div class="loop-entry-body">
            <div class="loop-entry-summary">Processed task_inbox items from elysia. Added 2 memories (scope: shared). Sent inbox message about milestone completion.</div>
            <div class="loop-entry-meta">
              <span>15 ticks</span><span>0 errors</span>
              <span class="text-emerald-400">$0.0038</span>
              <span>2026-02-27T14:00:00Z</span>
            </div>
          </div>
        </div>
        <div class="loop-entry">
          <div class="loop-entry-idx">#3</div>
          <div class="loop-entry-body">
            <div class="loop-entry-summary">Reviewed directive changes. Found 1 new directive added since last manifest. Updated memory with directive awareness note.</div>
            <div class="loop-entry-meta">
              <span>15 ticks</span><span>1 error</span>
              <span class="text-emerald-400">$0.0051</span>
              <span>2026-02-27T13:30:00Z</span>
            </div>
          </div>
        </div>
        <div class="loop-entry">
          <div class="loop-entry-idx">#2</div>
          <div class="loop-entry-body">
            <div class="loop-entry-summary">Memory vault cleanup: bulk-deleted 4 outdated memories, updated 2 scope tags. Context compaction triggered at tick 8.</div>
            <div class="loop-entry-meta">
              <span>15 ticks</span><span>0 errors</span>
              <span class="text-emerald-400">$0.0029</span>
              <span>2026-02-27T13:00:00Z</span>
            </div>
          </div>
        </div>
        <div class="loop-entry">
          <div class="loop-entry-idx">#1</div>
          <div class="loop-entry-body">
            <div class="loop-entry-summary">Initial loop. Agent orientation â€” read runtime_info, reviewed directives manifest, recalled memory vault state.</div>
            <div class="loop-entry-meta">
              <span>15 ticks</span><span>0 errors</span>
              <span class="text-emerald-400">$0.0035</span>
              <span>2026-02-27T12:30:00Z</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Journal outputs -->
    <div class="card mb-5">
      <span class="card-header">Journal &amp; Narrative Outputs</span>
      <div class="grid grid-cols-2 gap-4 mt-3 max-md:grid-cols-1">
        <div>
          <div class="text-sm font-bold text-white mb-1">Machine Journal (JSONL)</div>
          <p class="text-xs text-zinc-400 leading-relaxed">
            Structured log: <code class="text-indigo-300">burst_start</code>, <code class="text-indigo-300">burst_tick</code>,
            <code class="text-indigo-300">burst_end</code>, tool calls, errors, metering. For programmatic analysis.
          </p>
          <code class="text-xs text-zinc-600 block mt-2">data/{profile}/burst_journal.jsonl</code>
        </div>
        <div>
          <div class="text-sm font-bold text-white mb-1">Human Narrative</div>
          <p class="text-xs text-zinc-400 leading-relaxed">
            Diary-style entries by <code class="text-indigo-300">NarrativeWriter</code>. Session start/end, tick summaries, and stats.
            Also appended via <code class="text-indigo-300">human_journal.append_entry()</code>.
          </p>
          <code class="text-xs text-zinc-600 block mt-2">data/{profile}/narrative.md</code>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/*  Configuration persistence (real save/load via API)               */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let _cfg = {{ config | tojson }};

function _gatherConfig() {
  return {
    interval_hours:             parseInt(document.getElementById('cfg-interval-hours').value) || 0,
    interval_minutes:           parseInt(document.getElementById('cfg-interval-minutes').value) || 30,
    max_loops:                  parseInt(document.getElementById('cfg-max-loops').value) || 0,
    ticks_per_loop:             parseInt(document.getElementById('cfg-ticks').value) || 15,
    max_steps_per_tick:         parseInt(document.getElementById('cfg-steps').value) || 3,
    stimulus:                   document.getElementById('cfg-stimulus').value,
    profile:                    document.getElementById('cfg-profile').value,
    auto_pause_on_budget:       document.getElementById('toggle-budget-pause').classList.contains('on'),
    auto_pause_on_error_streak: parseInt(document.getElementById('cfg-error-streak').value) || 0,
    monthly_hard_cap:           parseFloat(document.getElementById('cfg-monthly-hard').value) || 20,
    monthly_soft_cap:           parseFloat(document.getElementById('cfg-monthly-soft').value) || 16,
    per_session_cap:            parseFloat(document.getElementById('cfg-session-cap').value) || 2,
    per_tick_cap:               parseFloat(document.getElementById('cfg-tick-cap').value) || 0.10,
  };
}

async function saveConfig() {
  const cfg = _gatherConfig();
  try {
    const resp = await fetch('/api/agi-loop/config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(cfg),
    });
    const data = await resp.json();
    if (data.ok) {
      _cfg = cfg;
      _refreshDashboard();
      showToast('Configuration saved', 'ok');
    } else {
      showToast('Save failed', 'error');
    }
  } catch (e) {
    showToast('Save error: ' + e.message, 'error');
  }
}

function _refreshDashboard() {
  document.getElementById('dash-profile').textContent = _cfg.profile;
  const mode = _cfg.max_loops === 0 ? 'âˆž Infinite' : _cfg.max_loops + ' loops';
  document.getElementById('dash-mode').textContent = mode;
  // Update budget displays
  const hardEl = document.getElementById('budget-hard-display');
  const softEl = document.getElementById('budget-soft-display');
  const hard2 = document.getElementById('budget-hard-display2');
  const sessEl = document.getElementById('budget-session-display');
  const tickEl = document.getElementById('budget-tick-display');
  if (hardEl) hardEl.textContent = _cfg.monthly_hard_cap;
  if (softEl) softEl.textContent = _cfg.monthly_soft_cap;
  if (hard2)  hard2.textContent = _cfg.monthly_hard_cap;
  if (sessEl) sessEl.textContent = _cfg.per_session_cap;
  if (tickEl) tickEl.textContent = _cfg.per_tick_cap;
}

function toggleBudgetPause() {
  const el = document.getElementById('toggle-budget-pause');
  const isOn = el.classList.contains('on');
  el.classList.toggle('on', !isOn);
  el.classList.toggle('off', isOn);
  // Update the badge next to it
  const badge = el.closest('.flex').querySelector('.badge');
  if (badge) badge.textContent = isOn ? 'Disabled' : 'Enabled';
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/*  Tab switching                                                    */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function switchTab(id) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
  event.currentTarget.classList.add('active');
  const panel = document.getElementById('panel-' + id);
  if (panel) panel.classList.add('active');
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/*  Demo controls (no backend connected)                             */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const STATUS_MAP = {
  start:  { text: 'Running',  css: 'status-running',  dot: 'running'  },
  pause:  { text: 'Paused',   css: 'status-paused',   dot: 'paused'   },
  resume: { text: 'Running',  css: 'status-running',  dot: 'running'  },
  stop:   { text: 'Stopped',  css: 'status-stopped',  dot: 'stopped'  },
};

let demoInterval = null;
let demoCountdown = 0;
let demoLoops = 0;
let demoTicks = 0;

function _setStatus(action) {
  const s = STATUS_MAP[action];
  if (!s) return;
  ['global', 'ctrl'].forEach(prefix => {
    const badge = document.getElementById(prefix + '-status');
    const dot   = document.getElementById(prefix + '-dot');
    const text  = document.getElementById(prefix + '-status-text');
    if (badge) badge.className = 'status-badge ' + s.css;
    if (dot)   dot.className   = 'status-dot ' + s.dot;
    if (text)  text.textContent = s.text;
  });
}

function demoAction(action) {
  _setStatus(action);
  if (action === 'start' || action === 'resume') {
    const cfg = _gatherConfig();
    demoCountdown = (cfg.interval_hours * 3600) + (cfg.interval_minutes * 60);
    _startCountdown();
    _simulateLoop();
  } else if (action === 'pause') {
    _stopCountdown();
  } else if (action === 'stop') {
    _stopCountdown();
    document.getElementById('countdown-display').textContent = '--:--:--';
  }
}

function _startCountdown() {
  _stopCountdown();
  demoInterval = setInterval(() => {
    if (demoCountdown <= 0) {
      _simulateLoop();
      const cfg = _gatherConfig();
      demoCountdown = (cfg.interval_hours * 3600) + (cfg.interval_minutes * 60);
    }
    const h   = String(Math.floor(demoCountdown / 3600)).padStart(2, '0');
    const m   = String(Math.floor((demoCountdown % 3600) / 60)).padStart(2, '0');
    const sec = String(demoCountdown % 60).padStart(2, '0');
    document.getElementById('countdown-display').textContent = h + ':' + m + ':' + sec;
    demoCountdown--;
  }, 1000);
}

function _stopCountdown() {
  if (demoInterval) { clearInterval(demoInterval); demoInterval = null; }
}

function _simulateLoop() {
  const ticks = parseInt(document.getElementById('cfg-ticks').value) || 15;
  demoLoops++;
  demoTicks += ticks;
  document.getElementById('stat-loops').textContent = demoLoops;
  document.getElementById('stat-ticks').textContent = demoTicks;
  document.getElementById('stat-cost').textContent = '$' + (demoLoops * 0.0038).toFixed(4);
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/*  Toast helper                                                     */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function showToast(msg, type) {
  let el = document.getElementById('ss-toast');
  if (!el) {
    el = document.createElement('div');
    el.id = 'ss-toast';
    el.style.cssText = 'position:fixed;bottom:24px;right:24px;z-index:9999;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:500;pointer-events:none;opacity:0;transition:opacity .2s;max-width:320px;';
    document.body.appendChild(el);
  }
  el.textContent = msg;
  const colors = { error: ['#7f1d1d','#fca5a5','#ef4444'], warn: ['#78350f','#fcd34d','#f59e0b'], ok: ['#14532d','#86efac','#22c55e'] };
  const c = colors[type] || colors.ok;
  el.style.background = c[0]; el.style.color = c[1]; el.style.border = '1px solid ' + c[2];
  el.style.opacity = '1';
  clearTimeout(el._t);
  el._t = setTimeout(() => { el.style.opacity = '0'; }, 3000);
}


/* ═══════════════════════════════════════════════════════════════════ */
/*  Tiered Model Router – dynamic table + modal editor               */
/* ═══════════════════════════════════════════════════════════════════ */

const _connections = {{ connections | tojson }};
let _tiers = (_cfg.tiers && _cfg.tiers.length) ? JSON.parse(JSON.stringify(_cfg.tiers)) : [];

const TIER_COLORS = {
  t0: { bg: 'rgba(16,185,129,0.12)', fg: '#6ee7b7' },
  t1: { bg: 'rgba(34,211,238,0.12)', fg: '#22d3ee' },
  t2: { bg: 'rgba(99,102,241,0.12)', fg: '#a5b4fc' },
  t3: { bg: 'rgba(245,158,11,0.12)', fg: '#fcd34d' },
  t4: { bg: 'rgba(236,72,153,0.12)', fg: '#f472b6' },
  t5: { bg: 'rgba(168,85,247,0.12)', fg: '#c084fc' },
};
function _tierColor(id) { return TIER_COLORS[id] || { bg: 'rgba(99,102,241,0.12)', fg: '#a5b4fc' }; }

/* ── Render tier table rows ── */
function renderTierTable() {
  const tbody = document.getElementById('tier-table-body');
  if (!tbody) return;
  tbody.innerHTML = '';
  _tiers.forEach((t, idx) => {
    const c = _tierColor(t.id);
    const connName = _connectionLabel(t.connection_id, t.provider);
    const modelStr = t.primary_model || '—';
    const alts = (t.alt_models || []).length;
    const altsHint = alts ? ` <span style="color:#52525b;font-size:0.6875rem;">+${alts} alt${alts>1?'s':''}</span>` : '';
    const tr = document.createElement('tr');
    tr.onclick = () => openTierEditor(idx);
    tr.innerHTML = `
      <td><span class="tier-enabled-dot ${t.enabled?'on':'off'}"></span></td>
      <td><span class="tier-badge" style="background:${c.bg};color:${c.fg};">${t.id.toUpperCase()}</span></td>
      <td class="font-semibold">${_esc(t.label)}</td>
      <td class="text-xs">${_esc(connName)} / ${_esc(modelStr)}${altsHint}</td>
      <td class="text-yellow-300">${_esc(t.cost_per_call || '—')}</td>
      <td class="text-xs">${_esc(t.default_for || '—')}<span class="tier-edit-hint">✎ click to edit</span></td>
    `;
    tbody.appendChild(tr);
  });
}

function _connectionLabel(connId, fallbackProvider) {
  if (connId) {
    const c = _connections.find(x => x.id === connId);
    if (c) return `${c.name} (${c.provider || c.type})`;
  }
  return fallbackProvider || '—';
}

function _esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

/* ── Modal open / close ── */
let _editingTierIdx = -1;

function openTierEditor(idx) {
  _editingTierIdx = idx;
  const t = _tiers[idx];
  if (!t) return;

  const c = _tierColor(t.id);
  document.getElementById('tm-badge').textContent = t.id.toUpperCase();
  document.getElementById('tm-badge').style.background = c.bg;
  document.getElementById('tm-badge').style.color = c.fg;
  document.getElementById('tm-label').value = t.label || '';

  // Enabled toggle
  const tog = document.getElementById('tm-enabled');
  tog.classList.toggle('on', t.enabled !== false);
  tog.classList.toggle('off', t.enabled === false);
  document.getElementById('tm-enabled-text').textContent = t.enabled !== false ? 'Enabled' : 'Disabled';

  // Connection dropdown
  _populateConnectionDropdown(t.connection_id);

  // Model
  _populateModelDropdown(t.connection_id, t.primary_model);
  document.getElementById('tm-model').value = t.primary_model || '';

  // Params
  document.getElementById('tm-temperature').value = t.temperature ?? 0.6;
  document.getElementById('tm-max-tokens').value = t.max_output_tokens ?? 2048;
  document.getElementById('tm-max-iter').value = t.max_iterations ?? 8;
  document.getElementById('tm-retries').value = t.retries_before_escalate ?? 3;

  // Extra
  document.getElementById('tm-default-for').value = t.default_for || '';
  document.getElementById('tm-cost').value = t.cost_per_call || '';

  // Alt models
  _renderAltModels(t.alt_models || []);

  // Show delete button only if more than 1 tier
  document.getElementById('tm-delete').style.display = _tiers.length > 1 ? '' : 'none';

  // Show modal
  document.getElementById('tier-modal-overlay').classList.add('active');
}

function closeTierModal() {
  document.getElementById('tier-modal-overlay').classList.remove('active');
  _editingTierIdx = -1;
}

// Close on overlay click
document.addEventListener('click', (e) => {
  if (e.target.id === 'tier-modal-overlay') closeTierModal();
});
// Close on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('tier-modal-overlay').classList.contains('active')) {
    closeTierModal();
  }
});

function toggleModalEnabled() {
  const tog = document.getElementById('tm-enabled');
  const isOn = tog.classList.contains('on');
  tog.classList.toggle('on', !isOn);
  tog.classList.toggle('off', isOn);
  document.getElementById('tm-enabled-text').textContent = isOn ? 'Disabled' : 'Enabled';
}

/* ── Connection & model dropdowns ── */
function _populateConnectionDropdown(selectedId) {
  const sel = document.getElementById('tm-connection');
  sel.innerHTML = '<option value="">-- none (manual provider) --</option>';
  _connections.forEach(c => {
    if (!c.enabled) return;
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = `${c.name} (${c.provider || c.type})`;
    if (c.id === selectedId) opt.selected = true;
    sel.appendChild(opt);
  });
}

function _populateModelDropdown(connId, selectedModel) {
  const sel = document.getElementById('tm-model-select');
  sel.innerHTML = '<option value="">-- type custom --</option>';
  if (connId) {
    const conn = _connections.find(c => c.id === connId);
    if (conn && conn.models && conn.models.length) {
      conn.models.forEach(m => {
        const name = typeof m === 'string' ? m : m.id || m.name || '';
        if (!name) return;
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === selectedModel) opt.selected = true;
        sel.appendChild(opt);
      });
    }
  }
}

function onConnectionChange() {
  const connId = document.getElementById('tm-connection').value;
  const currentModel = document.getElementById('tm-model').value;
  _populateModelDropdown(connId, currentModel);
}

function onModelSelectChange() {
  const val = document.getElementById('tm-model-select').value;
  if (val) document.getElementById('tm-model').value = val;
}

/* ── Alternate models ── */
function _renderAltModels(alts) {
  const container = document.getElementById('tm-alt-list');
  container.innerHTML = '';
  (alts || []).forEach((model, i) => {
    const row = document.createElement('div');
    row.className = 'tier-alt-row';
    row.innerHTML = `
      <span class="tier-alt-label">ALT ${i + 1}</span>
      <input type="text" class="tier-form-input tm-alt-input" value="${_esc(model)}" placeholder="model-name" style="flex:1;">
      <button class="tier-alt-remove" onclick="removeAltModel(${i})" title="Remove">&times;</button>
    `;
    container.appendChild(row);
  });
}

function addAltModel() {
  const container = document.getElementById('tm-alt-list');
  const idx = container.querySelectorAll('.tier-alt-row').length;
  const row = document.createElement('div');
  row.className = 'tier-alt-row';
  row.innerHTML = `
    <span class="tier-alt-label">ALT ${idx + 1}</span>
    <input type="text" class="tier-form-input tm-alt-input" value="" placeholder="model-name" style="flex:1;">
    <button class="tier-alt-remove" onclick="removeAltModel(${idx})" title="Remove">&times;</button>
  `;
  container.appendChild(row);
}

function removeAltModel(idx) {
  const alts = _gatherAltModels();
  alts.splice(idx, 1);
  _renderAltModels(alts);
}

function _gatherAltModels() {
  return Array.from(document.querySelectorAll('.tm-alt-input')).map(el => el.value.trim()).filter(Boolean);
}

/* ── Save tier from modal back into _tiers array ── */
function saveTierFromModal() {
  if (_editingTierIdx < 0 || _editingTierIdx >= _tiers.length) return;

  const t = _tiers[_editingTierIdx];
  t.label = document.getElementById('tm-label').value.trim() || t.label;
  t.enabled = document.getElementById('tm-enabled').classList.contains('on');

  const connId = document.getElementById('tm-connection').value;
  t.connection_id = connId;
  if (connId) {
    const conn = _connections.find(c => c.id === connId);
    t.provider = conn ? (conn.provider || conn.type) : t.provider;
  }

  t.primary_model = document.getElementById('tm-model').value.trim();
  t.temperature = parseFloat(document.getElementById('tm-temperature').value) || 0.6;
  t.max_output_tokens = parseInt(document.getElementById('tm-max-tokens').value) || 2048;
  t.max_iterations = parseInt(document.getElementById('tm-max-iter').value) || 8;
  t.retries_before_escalate = parseInt(document.getElementById('tm-retries').value) || 3;
  t.default_for = document.getElementById('tm-default-for').value.trim();
  t.cost_per_call = document.getElementById('tm-cost').value.trim();
  t.alt_models = _gatherAltModels();

  closeTierModal();
  renderTierTable();
  showToast('Tier updated — click Save Tiers to persist', 'ok');
}

/* ── Delete tier ── */
function deleteTierFromModal() {
  if (_editingTierIdx < 0 || _tiers.length <= 1) return;
  if (!confirm('Delete tier ' + _tiers[_editingTierIdx].id.toUpperCase() + '?')) return;
  _tiers.splice(_editingTierIdx, 1);
  closeTierModal();
  renderTierTable();
  showToast('Tier removed — click Save Tiers to persist', 'warn');
}

/* ── Add new tier ── */
function addNewTier() {
  const nextIdx = _tiers.length;
  const id = 't' + nextIdx;
  _tiers.push({
    id: id,
    label: 'new_tier_' + nextIdx,
    enabled: true,
    connection_id: '',
    provider: '',
    primary_model: '',
    temperature: 0.6,
    max_output_tokens: 2048,
    max_iterations: 8,
    retries_before_escalate: 3,
    alt_models: [],
    default_for: '',
    cost_per_call: '~$0.00',
  });
  renderTierTable();
  openTierEditor(nextIdx);
}

/* ── Persist all tiers to backend ── */
async function saveTiers() {
  const cfg = _gatherConfig();
  cfg.tiers = _tiers;
  try {
    const resp = await fetch('/api/agi-loop/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(cfg),
    });
    const data = await resp.json();
    if (data.ok) {
      _cfg.tiers = JSON.parse(JSON.stringify(_tiers));
      showToast('Tiers saved', 'ok');
    } else {
      showToast('Save failed', 'error');
    }
  } catch (e) {
    showToast('Save error: ' + e.message, 'error');
  }
}

/* ── Initialize tier table on page load ── */
renderTierTable();
</script>
{% endblock %}
