{% extends "base.html" %}
{% block title %}Agent Profiles ‚Äî SoulScript Engine{% endblock %}

{% block content %}
<style>
  /* ‚îÄ‚îÄ Shell ‚îÄ‚îÄ */
  .profiles-shell { max-width: 100%; margin: 0 auto; padding: 0 1rem; }

  /* ‚îÄ‚îÄ Tab Bar ‚îÄ‚îÄ */
  .tab-bar {
    display: flex; align-items: center; gap: 0; border-bottom: 1px solid #2a2a3a;
    margin-bottom: 1.5rem;
  }
  .tab-btn {
    display: inline-flex; align-items: center; gap: 0.5rem;
    padding: 0.75rem 1.25rem; font-size: 0.875rem; font-weight: 600;
    color: #71717a; background: none; border: none; cursor: pointer;
    border-bottom: 2px solid transparent; transition: all 0.15s;
    position: relative; top: 1px;
  }
  .tab-btn:hover { color: #a1a1aa; }
  .tab-btn.active { color: #fff; border-bottom-color: #6366f1; }
  .tab-count {
    font-size: 0.75rem; font-weight: 700; color: #71717a;
    background: rgba(42,42,58,0.6); padding: 0.0625rem 0.4rem;
    border-radius: 9999px; min-width: 1.25rem; text-align: center;
  }
  .tab-btn.active .tab-count { color: #a5b4fc; background: rgba(99,102,241,0.15); }

  /* ‚îÄ‚îÄ View switching ‚îÄ‚îÄ */
  .view-panel { display: none; animation: viewFade 0.2s ease; }
  .view-panel.active { display: block; }
  @keyframes viewFade {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ User Profile Card ‚îÄ‚îÄ */
  .user-card {
    display: inline-flex; align-items: center; gap: 1.25rem;
    background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 0.75rem;
    padding: 1rem 1.5rem; margin-bottom: 2rem;
  }
  .user-avatar {
    width: 3.5rem; height: 3.5rem; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.375rem; font-weight: 800; color: #fff;
    flex-shrink: 0; position: relative; cursor: pointer;
    transition: transform 0.15s;
  }
  .user-avatar:hover { transform: scale(1.06); }
  .user-avatar img {
    width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
    position: absolute; inset: 0;
  }
  .user-avatar .cam-badge {
    position: absolute; bottom: -2px; right: -2px;
    background: #1a1a24; border: 2px solid #2a2a3a; border-radius: 50%;
    width: 1.25rem; height: 1.25rem; display: flex; align-items: center; justify-content: center;
    font-size: 0.5rem;
  }
  .user-meta { flex: 1; }
  .user-name-input {
    background: transparent; border: none; color: #fff;
    font-size: 1.125rem; font-weight: 700; outline: none;
    border-bottom: 1px solid transparent; transition: border-color 0.15s;
    padding: 0.125rem 0; max-width: 14rem;
  }
  .user-name-input:focus { border-bottom-color: #6366f1; }

  /* ‚îÄ‚îÄ Color picker ‚îÄ‚îÄ */
  .color-picker-wrap { position: relative; display: inline-block; }
  .color-trigger {
    width: 1.15rem; height: 1.15rem; border-radius: 50%; cursor: pointer;
    border: 2px solid rgba(255,255,255,0.25); transition: transform 0.15s, border-color 0.15s;
    background: conic-gradient(#ef4444, #f59e0b, #eab308, #10b981, #06b6d4, #3b82f6, #6366f1, #9333ea, #db2777, #ef4444);
  }
  .color-trigger:hover { transform: scale(1.18); border-color: rgba(255,255,255,0.6); }
  .color-dropdown {
    display: none; position: absolute; top: calc(100% + 6px); left: 0;
    background: #1a1a24; border: 1px solid rgba(99,102,241,0.25); border-radius: 0.625rem;
    padding: 0.625rem; z-index: 60; min-width: 11rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }
  .color-dropdown.open { display: block; }
  .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.35rem; }
  .color-swatch {
    width: 1.5rem; height: 1.5rem; border-radius: 50%; cursor: pointer;
    border: 2px solid transparent; transition: border-color 0.15s, transform 0.15s;
  }
  .color-swatch:hover { transform: scale(1.18); }
  .color-swatch.active { border-color: #fff; box-shadow: 0 0 0 1px rgba(255,255,255,0.3); }
  .color-custom-row {
    margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.06);
    display: flex; align-items: center; gap: 0.5rem;
  }
  .color-custom-row label { font-size: 0.7rem; color: #71717a; cursor: pointer; white-space: nowrap; }
  .color-custom-row input[type=color] {
    width: 1.5rem; height: 1.5rem; border: none; background: none;
    cursor: pointer; border-radius: 50%; padding: 0;
  }

  /* ‚îÄ‚îÄ Avatar context menu ‚îÄ‚îÄ */
  .avatar-menu {
    display: none; position: absolute; top: calc(100% + 6px); left: 50%;
    transform: translateX(-50%); background: #1a1a24;
    border: 1px solid rgba(99,102,241,0.25); border-radius: 0.5rem;
    padding: 0.25rem 0; z-index: 9999; min-width: 10rem;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  }
  .avatar-menu.open { display: block; }
  .avatar-menu-item {
    display: flex; align-items: center; gap: 0.5rem;
    padding: 0.5rem 0.875rem; font-size: 0.8125rem; color: #d4d4d8;
    cursor: pointer; transition: background 0.1s; white-space: nowrap;
    border: none; background: none; width: 100%; text-align: left;
  }
  .avatar-menu-item:hover { background: rgba(99,102,241,0.1); }
  .avatar-menu-item.danger { color: #fca5a5; }
  .avatar-menu-item.danger:hover { background: rgba(239,68,68,0.1); }

  /* ‚îÄ‚îÄ Agent List ‚îÄ‚îÄ */
  .list-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 1.5rem;
  }
  .list-header h2 { font-size: 1.25rem; font-weight: 700; color: #fff; }

  .agents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.25rem; margin-bottom: 2rem;
  }
  @media (max-width: 768px) { .agents-grid { grid-template-columns: 1fr; } }

  /* ‚îÄ‚îÄ "Meet the Agent" style card ‚îÄ‚îÄ */
  .agent-card {
    background: rgba(13, 18, 36, 0.7);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 1rem;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    display: flex; flex-direction: column;
  }
  .agent-card:hover {
    border-color: rgba(99,102,241,0.3);
    transform: translateY(-6px);
    box-shadow: 0 20px 60px rgba(99, 102, 241, 0.15);
  }

  /* Header / picture block */
  .agent-card-header {
    height: 130px;
    display: flex; align-items: center; justify-content: center;
    position: relative; overflow: hidden;
  }
  .agent-card-header::before {
    content: ''; position: absolute; inset: 0;
    opacity: 0.35;
  }
  .agent-card-header .agent-icon {
    font-size: 3rem; z-index: 2; position: relative;
    filter: drop-shadow(0 0 20px currentColor);
    color: inherit;
  }
  .agent-card-header .agent-photo {
    width: 100%; height: 100%;
    object-fit: cover; position: absolute; inset: 0;
    z-index: 2;
  }
  /* Status badge */
  .agent-card-status {
    position: absolute; top: 12px; right: 12px;
    display: flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: 50px;
    font-size: 0.65rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
    z-index: 3;
    background: rgba(34,197,94,0.15); color: #4ade80;
    border: 1px solid rgba(34,197,94,0.3);
  }
  .agent-card-status::before {
    content: ''; width: 5px; height: 5px;
    border-radius: 50%; background: #4ade80;
    animation: agentPulse 2s infinite;
  }
  @keyframes agentPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Body */
  .agent-card-body {
    padding: 1.25rem 1.25rem 1rem; flex: 1;
    display: flex; flex-direction: column;
  }
  .agent-card-name {
    font-size: 1.15rem; font-weight: 700; color: #f1f5f9;
    text-transform: capitalize; margin-bottom: 0.2rem;
  }
  .agent-card-role {
    font-size: 0.8rem; color: #818cf8; font-weight: 500;
    margin-bottom: 0.6rem;
  }
  .agent-card-desc {
    font-size: 0.85rem; color: rgba(241,245,249,0.55);
    line-height: 1.55; margin-bottom: 0.875rem;
    display: -webkit-box; -webkit-line-clamp: 3;
    -webkit-box-orient: vertical; overflow: hidden;
    flex: 1;
  }

  /* Footer with LLM bubble */
  .agent-card-footer {
    display: flex; align-items: center; gap: 0.5rem;
    margin-top: auto; padding-top: 0.5rem;
  }
  .agent-tag-llm {
    display: inline-flex; align-items: center; gap: 0.35rem;
    padding: 4px 12px; border-radius: 50px;
    font-size: 0.7rem; font-weight: 600;
    background: rgba(34,211,238,0.1); color: #22d3ee;
    border: 1px solid rgba(34,211,238,0.15);
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    letter-spacing: -0.01em;
  }
  .agent-tag-llm i {
    font-size: 0.6rem; opacity: 0.7;
  }
  .agent-tag-tools {
    display: inline-flex; align-items: center; gap: 0.35rem;
    padding: 4px 10px; border-radius: 50px;
    font-size: 0.65rem; font-weight: 600;
    background: rgba(99,102,241,0.1); color: #818cf8;
    border: 1px solid rgba(99,102,241,0.15);
  }

  .agent-add-card {
    border: 1px dashed #3a3a4a; color: #52525b;
    display: flex; align-items: center; justify-content: center; gap: 0.5rem;
    min-height: 220px; border-radius: 1rem; cursor: pointer;
    transition: all 0.2s; font-size: 0.9rem; font-weight: 600;
  }
  .agent-add-card:hover { border-color: #6366f1; color: #818cf8; }

  /* ‚îÄ‚îÄ Editor View ‚îÄ‚îÄ */
  .editor-view { display: none; animation: viewFade 0.2s ease; }
  .editor-view.active { display: block; }

  /* ‚îÄ‚îÄ Modal-style agent detail panel (matches website popup) ‚îÄ‚îÄ */
  .agent-detail-panel {
    background: #0d1224;
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 1rem;
    overflow: visible;
    box-shadow: 0 40px 80px rgba(0,0,0,0.3);
    margin-bottom: 1.25rem;
    animation: modalIn 0.3s ease-out;
  }
  @keyframes modalIn {
    from { opacity: 0; transform: scale(0.97) translateY(8px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  /* Modal header ‚Äî gradient banner with avatar + name */
  .agent-detail-header {
    padding: 2rem 2rem 1.5rem;
    position: relative;
    overflow: visible;
    border-radius: 1rem 1rem 0 0;
    display: flex; align-items: flex-start; gap: 1.5rem;
  }
  .agent-detail-header::before {
    content: ''; position: absolute; inset: 0;
    opacity: 0.35; z-index: 0;
    border-radius: 1rem 1rem 0 0;
    overflow: hidden;
  }
  .prof-avatar {
    width: 5rem; height: 5rem; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem; font-weight: 800; color: #fff;
    flex-shrink: 0; position: relative; cursor: pointer;
    transition: transform 0.15s; z-index: 2;
    border: 3px solid rgba(255,255,255,0.15);
  }
  .prof-avatar:hover { transform: scale(1.06); }
  .prof-avatar img {
    width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
    position: absolute; inset: 0;
  }
  .prof-avatar .cam-badge {
    position: absolute; bottom: -2px; right: -2px;
    background: #1a1a24; border: 2px solid #2a2a3a; border-radius: 50%;
    width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center;
    font-size: 0.625rem;
  }
  .prof-header-info {
    flex: 1; min-width: 0; z-index: 2;
  }
  .prof-name-row {
    display: flex; align-items: center; gap: 1rem; margin-bottom: 0.25rem;
  }
  .prof-name-input {
    background: transparent; border: none; color: #fff;
    font-size: 1.5rem; font-weight: 800; outline: none;
    border-bottom: 1px solid transparent; transition: border-color 0.15s;
    padding: 0.125rem 0; width: 100%; max-width: 100%;
    text-transform: capitalize;
  }
  .prof-name-input:focus { border-bottom-color: #818cf8; }
  .prof-desc-input {
    background: transparent; border: none; color: rgba(241,245,249,0.6);
    font-size: 0.875rem; outline: none; padding: 0.2rem 0;
    resize: none; line-height: 1.6; overflow: hidden;
    font-family: inherit; width: 100%;
    min-height: 1.4em;
  }
  .prof-desc-input:focus { color: #d4d4d8; }
  .prof-desc-input::placeholder { color: rgba(241,245,249,0.35); }

  /* Modal body ‚Äî sections below header */
  .agent-detail-body {
    padding: 1.5rem 2rem 2rem;
  }

  /* Section title (matches website popup) */
  .modal-section-title {
    font-size: 0.8rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1.5px;
    color: #818cf8; margin: 1.75rem 0 0.75rem;
  }
  .modal-section-title:first-child { margin-top: 0; }

  /* Trait / tool tag pills */
  .modal-traits { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .modal-trait {
    padding: 6px 14px; border-radius: 50px;
    font-size: 0.8rem; font-weight: 500;
    background: rgba(99,102,241,0.08);
    color: rgba(241,245,249,0.6);
    border: 1px solid rgba(255,255,255,0.06);
    transition: all 0.15s;
  }

  /* ‚îÄ‚îÄ Config grid (model, voice, etc.) ‚îÄ‚îÄ */
  .config-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;
    margin-top: 0.5rem;
  }
  @media (max-width: 640px) { .config-grid { grid-template-columns: 1fr; } }
  .config-cell {
    padding: 0.875rem 1rem;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 0.625rem;
    transition: border-color 0.15s;
    position: relative;
  }
  .config-cell:hover { border-color: rgba(99,102,241,0.25); }
  .config-cell-label {
    font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.06em; color: rgba(241,245,249,0.35);
    margin-bottom: 0.375rem; display: flex; align-items: center; gap: 0.3rem;
  }
  .config-cell-value {
    font-size: 0.875rem; font-weight: 600; color: #f1f5f9;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .config-cell select {
    position: absolute; inset: 0; width: 100%; height: 100%;
    opacity: 0; cursor: pointer; z-index: 2;
  }

  /* ‚îÄ‚îÄ Tools toggles ‚îÄ‚îÄ */
  .tools-toggle-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.625rem; margin-top: 0.5rem;
  }
  .tool-toggle-card {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.75rem 1rem;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 0.625rem;
    transition: all 0.15s;
    cursor: pointer;
  }
  .tool-toggle-card:hover { border-color: rgba(99,102,241,0.25); }
  .tool-toggle-card.enabled { border-color: rgba(99,102,241,0.35); background: rgba(99,102,241,0.05); }
  .tool-toggle-icon {
    font-size: 1.25rem; flex-shrink: 0;
    width: 2.25rem; height: 2.25rem;
    display: flex; align-items: center; justify-content: center;
    border-radius: 0.5rem;
  }
  .tool-toggle-info { flex: 1; min-width: 0; }
  .tool-toggle-name {
    font-size: 0.8125rem; font-weight: 600; color: #f1f5f9;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
  }
  .tool-toggle-desc {
    font-size: 0.7rem; color: rgba(241,245,249,0.4);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .tool-toggle-switch {
    position: relative; width: 2.5rem; height: 1.25rem;
    background: #27272a; border-radius: 9999px;
    transition: background 0.2s; flex-shrink: 0;
  }
  .tool-toggle-switch.on { background: #6366f1; }
  .tool-toggle-switch .knob {
    position: absolute; top: 2px; left: 2px;
    width: 1rem; height: 1rem; border-radius: 50%;
    background: #fff; transition: transform 0.2s;
  }
  .tool-toggle-switch.on .knob { transform: translateX(1.25rem); }

  .tool-status-badge {
    font-size: 0.55rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.5px; padding: 1px 6px; border-radius: 50px;
    flex-shrink: 0;
  }
  .tool-status-badge.ready { color: #4ade80; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); }
  .tool-status-badge.planned { color: #fbbf24; background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.2); }
  .tool-status-badge.concept { color: #71717a; background: rgba(113,113,122,0.1); border: 1px solid rgba(113,113,122,0.2); }

  /* ‚îÄ‚îÄ Section Cards ‚îÄ‚îÄ */
  .section-card {
    background: #1a1a24; border: 1px solid #2a2a3a;
    border-radius: 0.75rem; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem;
  }
  .section-title {
    font-size: 0.8125rem; font-weight: 700; color: #e4e4e7;
    margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;
  }
  .section-title .sec-icon { font-size: 0.875rem; opacity: 0.6; }

  .field-hint { font-size: 0.6875rem; color: #52525b; margin-top: 0.25rem; }

  /* ‚îÄ‚îÄ System Prompt ‚îÄ‚îÄ */
  .textarea-prompt {
    width: 100%; min-height: 20rem; background: #13131a;
    border: 1px solid #2a2a3a; border-radius: 0.5rem;
    padding: 0.75rem; font-size: 0.8125rem; color: #d4d4d8;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    line-height: 1.6; outline: none; resize: vertical;
    transition: border-color 0.15s;
  }
  .textarea-prompt:focus { border-color: #6366f1; }
  .textarea-prompt::placeholder { color: #3f3f46; }

  /* ‚îÄ‚îÄ Notes ‚îÄ‚îÄ */
  .notes-grid { display: flex; flex-wrap: wrap; gap: 0.5rem; }
  .note-card {
    display: inline-flex; align-items: center; gap: 0.5rem;
    background: rgba(19,19,26,0.6); border: 1px solid #2a2a3a;
    border-radius: 0.375rem; padding: 0.375rem 0.625rem;
    transition: border-color 0.15s; flex: 0 0 auto; max-width: 22rem;
  }
  .note-card:hover { border-color: rgba(99,102,241,0.25); }
  .note-name {
    font-size: 0.75rem; color: #d4d4d8; font-weight: 500;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 8rem;
  }
  .note-source {
    font-size: 0.625rem; color: #52525b;
    background: rgba(42,42,58,0.4); padding: 0.0625rem 0.375rem;
    border-radius: 0.25rem; flex-shrink: 0;
  }
  .note-remove-btn {
    background: none; border: none; color: #52525b; cursor: pointer;
    font-size: 0.75rem; padding: 0.125rem 0.25rem; line-height: 1;
    transition: color 0.15s; flex-shrink: 0;
  }
  .note-remove-btn:hover { color: #fca5a5; }
  .mode-toggle {
    position: relative; width: 2.25rem; height: 1.125rem;
    background: #27272a; border-radius: 9999px; cursor: pointer;
    transition: background 0.2s; flex-shrink: 0;
  }
  .mode-toggle.active { background: #6366f1; }
  .mode-toggle .toggle-knob {
    position: absolute; top: 2px; left: 2px;
    width: 0.875rem; height: 0.875rem; border-radius: 50%;
    background: #fff; transition: transform 0.2s;
  }
  .mode-toggle.active .toggle-knob { transform: translateX(1.125rem); }
  .mode-label {
    font-size: 0.625rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.04em; white-space: nowrap;
  }
  .mode-label.always { color: #10b981; }
  .mode-label.directive { color: #818cf8; }
  .add-notes-btn {
    display: inline-flex; align-items: center; gap: 0.375rem;
    padding: 0.5rem 1rem; border-radius: 0.5rem;
    background: rgba(99,102,241,0.08); border: 1px dashed rgba(99,102,241,0.3);
    color: #818cf8; font-size: 0.8125rem; font-weight: 600;
    cursor: pointer; transition: all 0.15s; margin-top: 0.75rem;
  }
  .add-notes-btn:hover { background: rgba(99,102,241,0.16); border-color: #6366f1; }
  .notes-empty {
    padding: 1.5rem; text-align: center; color: #3f3f46;
    font-size: 0.8125rem; border: 1px dashed #2a2a3a; border-radius: 0.5rem;
  }

  /* ‚îÄ‚îÄ Action Bar ‚îÄ‚îÄ */
  .action-bar {
    display: flex; justify-content: flex-end; gap: 0.75rem;
    padding-top: 1rem; border-top: 1px solid #2a2a3a; margin-top: 0.5rem;
  }
  .btn { padding: 0.5rem 1.25rem; border-radius: 0.5rem; font-size: 0.8125rem;
    font-weight: 600; cursor: pointer; transition: all 0.15s; border: none; }
  .btn-primary { background: #6366f1; color: #fff; }
  .btn-primary:hover { background: #4f46e5; }
  .btn-secondary { background: rgba(42,42,58,0.5); color: #a1a1aa; border: 1px solid #2a2a3a; }
  .btn-secondary:hover { background: rgba(42,42,58,0.8); color: #e4e4e7; }

  /* ‚îÄ‚îÄ New Agent Button ‚îÄ‚îÄ */
  .new-agent-btn {
    display: inline-flex; align-items: center; gap: 0.375rem;
    padding: 0.4rem 1rem; border-radius: 0.5rem;
    background: #6366f1; color: #fff; border: none;
    font-size: 0.8125rem; font-weight: 600; cursor: pointer;
    transition: background 0.15s;
  }
  .new-agent-btn:hover { background: #4f46e5; }

  /* ‚îÄ‚îÄ Modals ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    display: none; align-items: center; justify-content: center; z-index: 100;
  }
  .modal-overlay.open { display: flex; }
  .modal-box {
    background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 0.75rem;
    padding: 1.5rem; width: 28rem; max-width: 90vw; max-height: 80vh;
    display: flex; flex-direction: column;
  }
  .modal-title { font-size: 1rem; font-weight: 700; color: #fff; margin-bottom: 1rem; }
  .modal-note-list {
    flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .modal-note-row {
    display: flex; align-items: center; gap: 0.75rem;
    background: rgba(19,19,26,0.6); border: 1px solid #2a2a3a;
    border-radius: 0.5rem; padding: 0.625rem 0.875rem;
    cursor: pointer; transition: all 0.15s;
  }
  .modal-note-row:hover { border-color: rgba(99,102,241,0.35); }
  .modal-note-row.already-attached { opacity: 0.4; pointer-events: none; }
  .modal-note-row .note-check { accent-color: #6366f1; width: 1rem; height: 1rem; cursor: pointer; }

  .field-label {
    display: block; font-size: 0.75rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.05em;
    color: #71717a; margin-bottom: 0.375rem;
  }
  .text-input, .select-input {
    width: 100%; background: #13131a; border: 1px solid #2a2a3a;
    border-radius: 0.5rem; padding: 0.5rem 0.75rem;
    font-size: 0.875rem; color: #e4e4e7; outline: none;
    transition: border-color 0.15s;
  }
  .text-input:focus, .select-input:focus { border-color: #6366f1; }
  .text-input::placeholder { color: #3f3f46; }
  .select-input { cursor: pointer; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 0.75rem center;
    padding-right: 2rem;
  }
</style>

{% set _COLORS = ['#4f46e5','#6366f1','#818cf8','#9333ea','#a855f7','#db2777','#ec4899','#ef4444','#f97316','#ea580c','#f59e0b','#eab308','#10b981','#059669','#0891b2','#06b6d4','#3b82f6','#2563eb','#71717a','#a1a1aa'] %}

<div class="profiles-shell">

  <!-- ‚ïê‚ïê‚ïê TAB BAR ‚ïê‚ïê‚ïê -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tab-btn-agents" onclick="showAgentsList()">
      Agents <span class="tab-count">{{ agents | length }}</span>
    </button>
  </div>

  <!-- ‚ïê‚ïê‚ïê VIEW: AGENTS LIST ‚ïê‚ïê‚ïê -->
  <div class="view-panel active" id="view-agents">

    <!-- User Profile Card -->
    {% set up = user_profile %}
    {% set user_color = up.get('color', '#10b981') %}
    <div class="user-card">
      <div class="user-avatar" id="avatar-_user"
           style="background: {{ user_color }};"
           onclick="toggleUserAvatarMenu(event)">
        {% if up.get('image') %}
        <img src="{{ up.image }}" alt="You">
        {% else %}
        {{ (up.get('name', 'You'))[0] | upper }}
        {% endif %}
        <span class="cam-badge">üì∑</span>
        <input type="file" id="file-_user" accept="image/*" style="display:none;"
               onchange="uploadAvatar('_user', this)">
        <div class="avatar-menu" id="avatar-menu-_user">
          <button class="avatar-menu-item" onclick="document.getElementById('file-_user').click(); closeAvatarMenu('_user')">
            üì∑ Change Picture
          </button>
          <button class="avatar-menu-item danger" onclick="clearImage('_user'); closeAvatarMenu('_user')">
            ‚úï Remove Picture
          </button>
        </div>
      </div>
      <div class="user-meta">
        <div style="display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap;">
          <input type="text" class="user-name-input" id="name-_user"
                 value="{{ up.get('name', 'You') }}"
                 placeholder="Your display name"
                 onchange="saveUserField('name', this.value)">
          <span class="text-xs text-zinc-500">How you appear in chat conversations</span>
        </div>
        <div class="color-picker-wrap" id="cpw-_user" style="margin-top:0.5rem;">
          <div class="color-trigger" onclick="toggleColorDropdown('_user')" title="Change color"></div>
          <div class="color-dropdown" id="cd-_user">
            <div class="color-grid">
              {% for c in _COLORS %}
              <div class="color-swatch {{ 'active' if c == user_color else '' }}"
                   style="background: {{ c }};"
                   onclick="setUserColor('{{ c }}', this)"></div>
              {% endfor %}
            </div>
            <div class="color-custom-row">
              <input type="color" id="custom-color-_user" value="{{ user_color }}"
                     onchange="setUserColor(this.value, null, true)">
              <label onclick="document.getElementById('custom-color-_user').click()">Custom color‚Ä¶</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Agent List Header -->
    <div class="list-header">
      <h2>All Agents</h2>
      <button class="new-agent-btn" onclick="openNewAgentModal()">Ôºã New Agent</button>
    </div>

    <!-- Agent Grid -->
    <div class="agents-grid" id="agents-grid">
      {% for name in agents %}
      {% set ad = agent_data[name] %}
      {% set av = avatar_map.get(name, {}) %}
      {% set agent_color = av.get('color', '#6366f1') %}
      {% set model_name = ad.config.get('model', ad.profile.get('model', '')) %}
      {% set tool_count = (ad.profile.get('allowed_tools', []) | length) %}
      {% set profile_desc = ad.profile.get('description', '') %}
      <div class="agent-card" data-agent="{{ name }}" onclick="openEditor('{{ name }}')">
        <!-- Header / picture block -->
        <div class="agent-card-header"
             style="background: linear-gradient(135deg, {{ agent_color }}33, {{ agent_color }}0d);">
          {% if av.get('image') %}
          <img class="agent-photo" src="{{ av.image }}" alt="{{ name }}">
          {% else %}
          <i class="fas fa-user-astronaut agent-icon" style="color: {{ agent_color }};"></i>
          {% endif %}
          <div class="agent-card-status">Active</div>
        </div>
        <!-- Body -->
        <div class="agent-card-body">
          <div class="agent-card-name">{{ ad.display_name or name }}</div>
          {% set summary = ad.description or profile_desc %}
          {% if summary %}
          <div class="agent-card-role">{{ summary[:80] }}{% if summary|length > 80 %}‚Ä¶{% endif %}</div>
          {% endif %}
          {% set narrative = profile_desc if (ad.description and profile_desc) else '' %}
          {% if narrative %}
          <div class="agent-card-desc">{{ narrative }}</div>
          {% elif not summary %}
          <div class="agent-card-desc" style="color:#3f3f46; font-style:italic;">No description yet ‚Äî click to configure.</div>
          {% endif %}
          <div class="agent-card-footer">
            {% if model_name %}
            <span class="agent-tag-llm"><i class="fas fa-microchip"></i> {{ model_name }}</span>
            {% endif %}
            {% if tool_count > 0 %}
            <span class="agent-tag-tools">{{ tool_count }} tools</span>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê VIEW: AGENT EDITORS (one per agent) ‚ïê‚ïê‚ïê -->
  {% for name in agents %}
  {% set ad = agent_data[name] %}
  {% set av = avatar_map.get(name, {}) %}
  {% set agent_color = av.get('color', '#6366f1') %}
  {% set cfg = ad.config %}
  {% set current_model = cfg.get('model', ad.profile.get('model', '')) %}
  {% set current_voice = cfg.get('voice_id', ad.profile.get('voice_id', '')) %}
  {% set current_edge_voice = cfg.get('edge_voice', ad.profile.get('edge_voice', 'alloy')) %}
  {% set current_tools = ad.profile.get('allowed_tools', []) %}
  <div class="editor-view" id="editor-{{ name }}">

    <!-- ‚ïê‚ïê‚ïê Modal-style Agent Detail Panel ‚ïê‚ïê‚ïê -->
    <div class="agent-detail-panel">

      <!-- Header ‚Äî gradient banner + avatar + name/desc -->
      <div class="agent-detail-header"
           style="background: linear-gradient(135deg, {{ agent_color }}22 0%, {{ agent_color }}08 60%, transparent 100%);">
        <div class="prof-avatar" id="avatar-{{ name }}"
             style="background: {{ agent_color }};"
             onclick="toggleAvatarMenu('{{ name }}', event)">
          {% if av.get('image') %}
          <img src="{{ av.image }}" alt="{{ name }}">
          {% else %}
          {{ name[0] | upper }}
          {% endif %}
          <span class="cam-badge">üì∑</span>
          <input type="file" id="file-{{ name }}" accept="image/*" style="display:none;"
                 onchange="uploadAvatar('{{ name }}', this)">
          <div class="avatar-menu" id="avatar-menu-{{ name }}">
            <button class="avatar-menu-item" onclick="document.getElementById('file-{{ name }}').click(); closeAvatarMenu('{{ name }}')">
              üì∑ Change Picture
            </button>
            <button class="avatar-menu-item danger" onclick="clearImage('{{ name }}'); closeAvatarMenu('{{ name }}')">
              ‚úï Remove Picture
            </button>
          </div>
          <!-- Color picker -->
          <div class="color-picker-wrap" id="cpw-{{ name }}" style="position:absolute;top:-4px;left:-4px;z-index:10;" onclick="event.stopPropagation()">
            <div class="color-trigger" onclick="toggleColorDropdown('{{ name }}')" title="Change color"></div>
            <div class="color-dropdown" id="cd-{{ name }}">
              <div class="color-grid">
                {% for c in _COLORS %}
                <div class="color-swatch {{ 'active' if c == agent_color else '' }}"
                     style="background: {{ c }};"
                     onclick="setColor('{{ name }}', '{{ c }}', this)"></div>
                {% endfor %}
              </div>
              <div class="color-custom-row">
                <input type="color" id="custom-color-{{ name }}" value="{{ agent_color }}"
                       onchange="setColor('{{ name }}', this.value, null, true)">
                <label onclick="document.getElementById('custom-color-{{ name }}').click()">Custom color‚Ä¶</label>
              </div>
            </div>
          </div>
        </div>

        <div class="prof-header-info">
          <div class="prof-name-row">
            <input type="text" class="prof-name-input" id="name-{{ name }}"
                   value="{{ ad.display_name or name }}"
                   placeholder="Name"
                   maxlength="30"
                   onchange="saveField('{{ name }}', 'display_name', this.value)">
          </div>
          <textarea class="prof-desc-input" id="desc-{{ name }}"
                    placeholder="Short description ‚Äî what does this agent do?"
                    maxlength="200" rows="2"
                    oninput="autoResizeDesc(this)"
                    onchange="saveField('{{ name }}', 'description', this.value)">{{ ad.description or '' }}</textarea>
        </div>
      </div>

      <!-- Body ‚Äî all config sections -->
      <div class="agent-detail-body">

        <!-- ‚îÄ‚îÄ Default Model ‚îÄ‚îÄ -->
        <div class="modal-section-title">‚ö° Default Model</div>
        <div class="config-grid" style="grid-template-columns: 1fr;">
          <div class="config-cell">
            <div class="config-cell-label"><i class="fas fa-microchip" style="font-size:0.65rem;"></i> Preferred LLM</div>
            <div class="config-cell-value" id="model-display-{{ name }}">{{ current_model or '‚Äî Select Model ‚Äî' }}</div>
            <select id="model-{{ name }}" data-current="{{ current_model }}"
                    onchange="onModelSelect('{{ name }}', this)">
              <option value="">‚Äî Select Model ‚Äî</option>
            </select>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ TTS / Voice ‚îÄ‚îÄ -->
        <div class="modal-section-title">üîä Voice & TTS</div>
        <div class="config-grid">
          <div class="config-cell">
            <div class="config-cell-label">üí∞ Paid TTS (ElevenLabs)</div>
            <div class="config-cell-value" id="voice-paid-display-{{ name }}">{{ current_voice or 'Not set' }}</div>
            <select id="voice-paid-{{ name }}" data-current="{{ current_voice }}"
                    onchange="onVoiceSelect('{{ name }}', 'paid', this)">
              <option value="">‚Äî Select Voice ‚Äî</option>
            </select>
          </div>
          <div class="config-cell">
            <div class="config-cell-label">üÜì Free TTS (Edge-TTS / Piper)</div>
            <div class="config-cell-value" id="voice-free-display-{{ name }}">{{ current_edge_voice or 'alloy' }}</div>
            <select id="voice-free-{{ name }}" data-current="{{ current_edge_voice }}"
                    onchange="onVoiceSelect('{{ name }}', 'free', this)">
              <option value="">‚Äî Select Voice ‚Äî</option>
              <optgroup label="Piper (CPU ¬∑ fast)">
                <option value="alloy" {{ 'selected' if current_edge_voice == 'alloy' else '' }}>alloy</option>
                <option value="echo" {{ 'selected' if current_edge_voice == 'echo' else '' }}>echo</option>
                <option value="echo-alt" {{ 'selected' if current_edge_voice == 'echo-alt' else '' }}>echo-alt</option>
                <option value="fable" {{ 'selected' if current_edge_voice == 'fable' else '' }}>fable</option>
                <option value="onyx" {{ 'selected' if current_edge_voice == 'onyx' else '' }}>onyx</option>
                <option value="nova" {{ 'selected' if current_edge_voice == 'nova' else '' }}>nova</option>
                <option value="shimmer" {{ 'selected' if current_edge_voice == 'shimmer' else '' }}>shimmer</option>
              </optgroup>
              <optgroup label="XTTS v2 (GPU ¬∑ HD)">
                <option value="alloy-hd" {{ 'selected' if current_edge_voice == 'alloy-hd' else '' }}>alloy (HD)</option>
                <option value="echo-hd" {{ 'selected' if current_edge_voice == 'echo-hd' else '' }}>echo (HD)</option>
                <option value="fable-hd" {{ 'selected' if current_edge_voice == 'fable-hd' else '' }}>fable (HD)</option>
                <option value="onyx-hd" {{ 'selected' if current_edge_voice == 'onyx-hd' else '' }}>onyx (HD)</option>
                <option value="nova-hd" {{ 'selected' if current_edge_voice == 'nova-hd' else '' }}>nova (HD)</option>
                <option value="shimmer-hd" {{ 'selected' if current_edge_voice == 'shimmer-hd' else '' }}>shimmer (HD)</option>
              </optgroup>
            </select>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Tools ‚îÄ‚îÄ -->
        <div class="modal-section-title" style="display:flex; align-items:center; justify-content:space-between;">
          <span>üõ†Ô∏è Available Tools</span>
          <span style="font-size:0.7rem; font-weight:500; color:rgba(241,245,249,0.35); text-transform:none; letter-spacing:0;">
            <span id="tool-count-{{ name }}">{{ current_tools | length }}</span> / {{ all_tool_names | length }} enabled
          </span>
        </div>
        <div class="tools-toggle-grid" id="tools-grid-{{ name }}">
          {% for tool_name in all_tool_names %}
          {% set td = tool_display.get(tool_name, {}) %}
          {% set is_on = tool_name in current_tools %}
          <div class="tool-toggle-card {{ 'enabled' if is_on else '' }}"
               id="tool-card-{{ name }}-{{ tool_name }}"
               onclick="toggleTool('{{ name }}', '{{ tool_name }}', this)">
            <div class="tool-toggle-icon" style="background:{{ td.get('icon_bg', 'rgba(99,102,241,0.08)') or 'rgba(99,102,241,0.08)' }};">
              {{ td.get('icon', 'üîß') }}
            </div>
            <div class="tool-toggle-info">
              <div class="tool-toggle-name">{{ tool_name }}</div>
              {% if td.get('description') %}
              <div class="tool-toggle-desc">{{ td.description[:80] }}{% if td.description|length > 80 %}‚Ä¶{% endif %}</div>
              {% endif %}
            </div>
            <span class="tool-status-badge {{ td.get('status', 'planned') }}">{{ td.get('status', 'planned') }}</span>
            <div class="tool-toggle-switch {{ 'on' if is_on else '' }}" id="tool-sw-{{ name }}-{{ tool_name }}">
              <span class="knob"></span>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- ‚îÄ‚îÄ System Prompt ‚îÄ‚îÄ -->
        <div class="modal-section-title">‚ú¶ System Prompt</div>
        <textarea class="textarea-prompt" id="prompt-{{ name }}"
                  placeholder="Write the system prompt for this agent‚Ä¶"
                  onchange="saveField('{{ name }}', 'system_prompt_text', this.value)"
        >{{ ad.system_prompt }}</textarea>
        <div class="field-hint">The foundational instruction set that defines behavior, personality, and role.</div>

        <!-- ‚îÄ‚îÄ Soul Script & Knowledge ‚îÄ‚îÄ -->
        <div class="modal-section-title">üß¨ Soul Script & Knowledge</div>
        <p class="field-hint" style="margin-bottom:0.75rem;">
          Attached notes are injected into the agent's context.
          <span class="mode-label always">Always</span> = every session &nbsp;|&nbsp;
          <span class="mode-label directive">Directive</span> = on-demand via directive engine.
        </p>
        <div class="notes-grid" id="notes-grid-{{ name }}">
          {% for note_id in cfg.get('attached_notes', []) %}
          {% set mode = cfg.get('note_modes', {}).get(note_id, 'always') %}
          <div class="note-card" id="note-user-{{ name }}-{{ note_id }}">
            <span class="note-name">üìù {{ note_id }}</span>
            <span class="note-source">user note</span>
            <div style="display:flex; align-items:center; gap:0.375rem;">
              <span class="mode-label {{ mode }}"
                    id="ml-{{ name }}-{{ note_id }}">
                {{ mode | upper }}
              </span>
              <div class="mode-toggle {{ 'active' if mode == 'directive' else '' }}"
                   id="mt-{{ name }}-{{ note_id }}"
                   onclick="toggleNoteMode('{{ name }}', '{{ note_id }}', this)">
                <span class="toggle-knob"></span>
              </div>
            </div>
            <button class="note-remove-btn" title="Detach" onclick="detachUserNote('{{ name }}', '{{ note_id }}')">‚úï</button>
          </div>
          {% endfor %}
        </div>

        <div class="notes-empty" id="notes-empty-{{ name }}"
             style="{{ 'display:none;' if cfg.get('attached_notes') else '' }}">
          No soul scripts attached. Click "Add Notes" to connect knowledge sources.
        </div>

        <button class="add-notes-btn" onclick="openAddNotesModal('{{ name }}')">
          Ôºã Add Notes
        </button>
      </div>
    </div>

    <!-- Save -->
    <div class="action-bar">
      <button class="btn btn-secondary" onclick="showAgentsList()">Back</button>
      <button class="btn btn-primary" onclick="saveAll('{{ name }}')">Save &amp; Apply</button>
    </div>
  </div>
  {% endfor %}

</div>

<!-- ‚ïê‚ïê‚ïê ADD NOTES MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="add-notes-modal">
  <div class="modal-box">
    <div class="modal-title">Add Notes</div>
    <p class="field-hint" style="margin-bottom:0.75rem;">Select notes to attach to this agent. Already-attached notes are dimmed.</p>
    <div class="modal-note-list" id="add-notes-list"></div>
    <div style="display:flex; justify-content:flex-end; gap:0.75rem;">
      <button class="btn btn-secondary" onclick="closeAddNotesModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAddNotes()">Attach Selected</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê NEW AGENT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="new-agent-modal">
  <div class="modal-box">
    <div class="modal-title">Create New Agent</div>
    <div style="margin-bottom:1rem;">
      <label class="field-label">Agent Name</label>
      <input type="text" class="text-input" id="new-agent-name" placeholder="e.g. atlas, nova, sage">
      <div class="field-hint">Lowercase, no spaces ‚Äî this becomes the profile filename.</div>
    </div>
    <div style="margin-bottom:1rem;">
      <label class="field-label">Base Model</label>
      <select class="select-input" id="new-agent-model">
        <option value="">Select a base model</option>
      </select>
    </div>
    <div style="margin-bottom:1rem;">
      <label class="field-label">Description</label>
      <input type="text" class="text-input" id="new-agent-desc" placeholder="What does this agent do?" maxlength="150">
    </div>
    <div style="display:flex; justify-content:flex-end; gap:0.75rem; margin-top:1rem;">
      <button class="btn btn-secondary" onclick="closeNewAgentModal()">Cancel</button>
      <button class="btn btn-primary" onclick="createNewAgent()">Create Agent</button>
    </div>
  </div>
</div>


<script>
  // ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
  const _allNotes = {{ notes | tojson }};
  const _connections = {{ connections | tojson }};
  const _allToolNames = {{ all_tool_names | tojson }};

  let _currentEditor = null;
  let _addNotesAgent = null;

  // ‚îÄ‚îÄ Model dropdown population ‚îÄ‚îÄ
  function populateModelDropdowns() {
    const selectors = document.querySelectorAll('select[id^="model-"]');
    const newAgentSel = document.getElementById('new-agent-model');
    const allSels = [...selectors];
    if (newAgentSel) allSels.push(newAgentSel);

    allSels.forEach(sel => {
      const current = sel.dataset.current || '';
      const isNew = sel.id === 'new-agent-model';
      sel.innerHTML = isNew ? '<option value="">Select a base model</option>' : '<option value="">‚Äî Select Model ‚Äî</option>';
      let selectedText = '‚Äî';

      _connections.forEach(conn => {
        if (!conn.models || conn.models.length === 0) return;
        const grp = document.createElement('optgroup');
        grp.label = conn.name;
        conn.models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = m;
          if (m === current) { opt.selected = true; selectedText = m; }
          grp.appendChild(opt);
        });
        sel.appendChild(grp);
      });

      if (!isNew) {
        const agName = sel.id.replace('model-', '');
        const disp = document.getElementById('model-display-' + agName);
        if (disp) disp.textContent = selectedText;
      }
    });
  }

  // ‚îÄ‚îÄ Auto-resize description textarea ‚îÄ‚îÄ
  function autoResizeDesc(el) {
    el.style.height = 'auto';
    el.style.height = Math.max(20, Math.min(el.scrollHeight, 60)) + 'px';
  }
  document.querySelectorAll('.prof-desc-input').forEach(autoResizeDesc);

  // ‚îÄ‚îÄ View Navigation ‚îÄ‚îÄ
  function showAgentsList() {
    document.querySelectorAll('.editor-view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-agents').classList.add('active');
    const btn = document.getElementById('tab-btn-agents');
    btn.innerHTML = 'Agents <span class="tab-count">{{ agents | length }}</span>';
    btn.classList.add('active');
    _currentEditor = null;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function openEditor(name) {
    document.getElementById('view-agents').classList.remove('active');
    document.querySelectorAll('.editor-view').forEach(v => v.classList.remove('active'));
    const editor = document.getElementById('editor-' + name);
    if (editor) {
      editor.classList.add('active');
      _currentEditor = name;
      const displayName = document.getElementById('name-' + name)?.value || name;
      document.getElementById('tab-btn-agents').innerHTML =
        '<span style="opacity:0.6">Agents</span> <span style="color:#3f3f46;margin:0 0.25rem;">‚Ä∫</span> ' + _esc(displayName);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  // ‚îÄ‚îÄ Avatar / Color ‚îÄ‚îÄ
  function toggleColorDropdown(id) {
    document.querySelectorAll('.color-dropdown.open').forEach(d => {
      if (d.id !== 'cd-' + id) d.classList.remove('open');
    });
    document.getElementById('cd-' + id).classList.toggle('open');
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.color-picker-wrap')) {
      document.querySelectorAll('.color-dropdown.open').forEach(d => d.classList.remove('open'));
    }
    if (!e.target.closest('.prof-avatar') && !e.target.closest('.user-avatar')) {
      document.querySelectorAll('.avatar-menu.open').forEach(m => m.classList.remove('open'));
    }
  });

  function toggleAvatarMenu(agent, e) {
    e.stopPropagation();
    document.querySelectorAll('.avatar-menu.open').forEach(m => {
      if (m.id !== 'avatar-menu-' + agent) m.classList.remove('open');
    });
    const menu = document.getElementById('avatar-menu-' + agent);
    if (menu) menu.classList.toggle('open');
  }
  function closeAvatarMenu(agent) {
    const menu = document.getElementById('avatar-menu-' + agent);
    if (menu) menu.classList.remove('open');
  }
  function toggleUserAvatarMenu(e) {
    e.stopPropagation();
    document.querySelectorAll('.avatar-menu.open').forEach(m => {
      if (m.id !== 'avatar-menu-_user') m.classList.remove('open');
    });
    const menu = document.getElementById('avatar-menu-_user');
    if (menu) menu.classList.toggle('open');
  }

  async function setColor(agent, color, el, isCustom) {
    const preview = document.getElementById('avatar-' + agent);
    if (preview) preview.style.background = color;
    const grid = document.querySelector('#cd-' + agent + ' .color-grid');
    if (grid) grid.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    if (el && !isCustom) el.classList.add('active');
    const customInput = document.getElementById('custom-color-' + agent);
    if (customInput) customInput.value = color;
    const card = document.querySelector(`.agent-card[data-agent="${agent}"] .agent-card-avatar`);
    if (card) card.style.background = color;
    const dd = document.getElementById('cd-' + agent);
    if (dd) dd.classList.remove('open');
    await fetch(`/api/profiles/${agent}/avatar`, {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({color}),
    });
  }

  async function uploadAvatar(agent, input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      const dataUrl = e.target.result;
      const preview = document.getElementById('avatar-' + agent);
      let img = preview.querySelector('img');
      if (!img) { img = document.createElement('img'); img.alt = agent; preview.appendChild(img); }
      img.src = dataUrl;
      const endpoint = agent === '_user' ? '/api/profiles/user' : `/api/profiles/${agent}/avatar`;
      await fetch(endpoint, {
        method: 'PUT', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({image: dataUrl}),
      });
    };
    reader.readAsDataURL(file);
  }

  async function clearImage(agent) {
    const preview = document.getElementById('avatar-' + agent);
    const img = preview.querySelector('img');
    if (img) img.remove();
    if (agent === '_user') {
      const nm = document.getElementById('name-_user')?.value || 'You';
      Array.from(preview.childNodes).forEach(n => { if (n.nodeType === 3) n.remove(); });
      preview.insertBefore(document.createTextNode(nm.charAt(0).toUpperCase()), preview.querySelector('.cam-badge'));
      await fetch('/api/profiles/user', {
        method: 'PUT', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({image: ''}),
      });
    } else {
      Array.from(preview.childNodes).forEach(n => { if (n.nodeType === 3) n.remove(); });
      preview.insertBefore(document.createTextNode(agent.charAt(0).toUpperCase()), preview.querySelector('.cam-badge'));
      await fetch(`/api/profiles/${agent}/avatar`, {
        method: 'PUT', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({image: ''}),
      });
    }
  }

  async function setUserColor(color, el, isCustom) {
    const preview = document.getElementById('avatar-_user');
    if (preview) preview.style.background = color;
    const grid = document.querySelector('#cd-_user .color-grid');
    if (grid) grid.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    if (el && !isCustom) el.classList.add('active');
    const customInput = document.getElementById('custom-color-_user');
    if (customInput) customInput.value = color;
    const dd = document.getElementById('cd-_user');
    if (dd) dd.classList.remove('open');
    await fetch('/api/profiles/user', {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({color}),
    });
  }

  // ‚îÄ‚îÄ Inline config select handlers ‚îÄ‚îÄ
  function onModelSelect(agent, sel) {
    const display = document.getElementById('model-display-' + agent);
    if (display) display.textContent = sel.value || '‚Äî Select Model ‚Äî';
    saveField(agent, 'model', sel.value);
  }

  // ‚îÄ‚îÄ Voice / TTS handlers ‚îÄ‚îÄ
  function onVoiceSelect(agent, type, sel) {
    if (type === 'paid') {
      const display = document.getElementById('voice-paid-display-' + agent);
      if (display) display.textContent = sel.value || 'Not set';
      saveField(agent, 'voice_id', sel.value);
    } else {
      const display = document.getElementById('voice-free-display-' + agent);
      if (display) display.textContent = sel.value || 'alloy';
      saveField(agent, 'edge_voice', sel.value);
    }
  }

  // Fetch ElevenLabs voices and populate paid TTS dropdowns
  async function populateElevenLabsVoices() {
    try {
      const resp = await fetch('/api/tts/voices');
      const data = await resp.json();
      if (!data.voices || data.voices.length === 0) return;
      document.querySelectorAll('select[id^="voice-paid-"]').forEach(sel => {
        const current = sel.dataset.current || '';
        let selectedText = 'Not set';
        const grp = document.createElement('optgroup');
        grp.label = 'ElevenLabs';
        data.voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.voice_id;
          opt.textContent = v.name + (v.category ? ` (${v.category})` : '');
          if (v.voice_id === current) { opt.selected = true; selectedText = v.name; }
          grp.appendChild(opt);
        });
        sel.appendChild(grp);
        const agName = sel.id.replace('voice-paid-', '');
        const disp = document.getElementById('voice-paid-display-' + agName);
        if (disp && current) disp.textContent = selectedText;
      });
    } catch (e) { /* ElevenLabs not configured */ }
  }

  // Fetch Edge-TTS voices and populate free TTS dropdowns
  async function populateEdgeTTSVoices() {
    try {
      const resp = await fetch('/api/tts/edge/voices');
      const data = await resp.json();
      if (!data.voices || data.voices.length === 0) return;
      // Group by engine
      const byEngine = {};
      data.voices.forEach(v => {
        const label = v.engine_label || v.engine || 'Edge-TTS';
        if (!byEngine[label]) byEngine[label] = [];
        byEngine[label].push(v);
      });
      document.querySelectorAll('select[id^="voice-free-"]').forEach(sel => {
        const current = sel.dataset.current || 'alloy';
        // Clear existing and rebuild with live data
        sel.innerHTML = '<option value="">‚Äî Select Voice ‚Äî</option>';
        let selectedText = current;
        for (const [engineLabel, voices] of Object.entries(byEngine)) {
          const grp = document.createElement('optgroup');
          grp.label = engineLabel;
          voices.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voice_id;
            opt.textContent = v.name;
            if (v.voice_id === current) { opt.selected = true; selectedText = v.name; }
            grp.appendChild(opt);
          });
          sel.appendChild(grp);
        }
        const agName = sel.id.replace('voice-free-', '');
        const disp = document.getElementById('voice-free-display-' + agName);
        if (disp) disp.textContent = selectedText;
      });
    } catch (e) { /* Edge-TTS not configured ‚Äî keep hardcoded fallback */ }
  }

  // ‚îÄ‚îÄ Tool toggle handler ‚îÄ‚îÄ
  function toggleTool(agent, toolName, cardEl) {
    const sw = document.getElementById('tool-sw-' + agent + '-' + toolName);
    const isOn = sw.classList.toggle('on');
    cardEl.classList.toggle('enabled', isOn);

    // Collect all enabled tool names
    const enabled = [];
    document.querySelectorAll(`#tools-grid-${agent} .tool-toggle-switch.on`).forEach(s => {
      const id = s.id.replace('tool-sw-' + agent + '-', '');
      enabled.push(id);
    });

    // Update count
    const counter = document.getElementById('tool-count-' + agent);
    if (counter) counter.textContent = enabled.length;

    // Also update the agent card footer tool count
    const card = document.querySelector(`.agent-card[data-agent="${agent}"]`);
    if (card) {
      const toolTag = card.querySelector('.agent-tag-tools');
      if (enabled.length > 0) {
        if (toolTag) {
          toolTag.textContent = enabled.length + ' tools';
        } else {
          const footer = card.querySelector('.agent-card-footer');
          if (footer) footer.insertAdjacentHTML('beforeend',
            `<span class="agent-tag-tools">${enabled.length} tools</span>`);
        }
      } else if (toolTag) {
        toolTag.remove();
      }
    }

    // Save
    saveField(agent, 'allowed_tools', enabled);
  }

  // ‚îÄ‚îÄ Save field ‚îÄ‚îÄ
  async function saveField(agent, field, value) {
    await fetch(`/api/profiles/${agent}/config`, {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({[field]: value}),
    });
  }

  async function saveUserField(field, value) {
    await fetch('/api/profiles/user', {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({[field]: value}),
    });
  }

  // ‚îÄ‚îÄ Notes ‚îÄ‚îÄ
  async function toggleNoteMode(agent, noteId, el) {
    const isActive = el.classList.toggle('active');
    const mode = isActive ? 'directive' : 'always';
    const label = document.getElementById('ml-' + agent + '-' + noteId);
    if (label) {
      label.textContent = mode.toUpperCase();
      label.className = 'mode-label ' + mode;
    }
    // Re-save all attached notes with updated mode
    const grid = document.getElementById('notes-grid-' + agent);
    const attached = [];
    const modes = {};
    grid.querySelectorAll('.note-card').forEach(card => {
      const id = card.id.replace('note-user-' + agent + '-', '');
      attached.push(id);
      const lbl = card.querySelector('.mode-label');
      modes[id] = lbl && lbl.textContent.trim().toLowerCase() === 'directive' ? 'directive' : 'always';
    });
    await fetch(`/api/profiles/${agent}/knowledge`, {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({attached_notes: attached, note_modes: modes}),
    });
  }

  async function detachUserNote(agent, noteId) {
    const el = document.getElementById('note-user-' + agent + '-' + noteId);
    if (el) el.remove();
    checkNotesEmpty(agent);
    // Re-save without this note
    const grid = document.getElementById('notes-grid-' + agent);
    const attached = [];
    const modes = {};
    grid.querySelectorAll('.note-card').forEach(card => {
      const id = card.id.replace('note-user-' + agent + '-', '');
      attached.push(id);
      const lbl = card.querySelector('.mode-label');
      modes[id] = lbl && lbl.textContent.trim().toLowerCase() === 'directive' ? 'directive' : 'always';
    });
    await fetch(`/api/profiles/${agent}/knowledge`, {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({attached_notes: attached, note_modes: modes}),
    });
  }

  function checkNotesEmpty(agent) {
    const grid = document.getElementById('notes-grid-' + agent);
    const empty = document.getElementById('notes-empty-' + agent);
    if (grid && empty) {
      empty.style.display = grid.children.length === 0 ? '' : 'none';
    }
  }

  // ‚îÄ‚îÄ Add Notes Modal ‚îÄ‚îÄ
  function openAddNotesModal(agent) {
    _addNotesAgent = agent;
    const list = document.getElementById('add-notes-list');
    list.innerHTML = '';

    const attachedIds = new Set();
    document.querySelectorAll(`#notes-grid-${agent} .note-card`).forEach(card => {
      const id = card.id.replace('note-user-' + agent + '-', '');
      attachedIds.add(id);
    });

    (_allNotes || []).forEach(note => {
      const attached = attachedIds.has(note.id);
      list.innerHTML += `
        <div class="modal-note-row ${attached ? 'already-attached' : ''}" data-type="user" data-id="${note.id}">
          <input type="checkbox" class="note-check" ${attached ? 'checked disabled' : ''}>
          <span class="note-name" style="flex:1;">${note.emoji || 'üìù'} ${note.title}</span>
          <span class="note-source">user note</span>
        </div>`;
    });

    if (list.children.length === 0) {
      list.innerHTML = '<p class="text-xs text-zinc-600 text-center py-4">No notes available. Create them in the <a href="/knowledge" class="text-forge-accent2 hover:underline">Knowledge</a> section.</p>';
    }

    document.getElementById('add-notes-modal').classList.add('open');
  }

  function closeAddNotesModal() {
    document.getElementById('add-notes-modal').classList.remove('open');
    _addNotesAgent = null;
  }

  async function confirmAddNotes() {
    if (!_addNotesAgent) return;
    const agent = _addNotesAgent;
    const rows = document.querySelectorAll('#add-notes-list .modal-note-row:not(.already-attached)');
    const grid = document.getElementById('notes-grid-' + agent);

    // Collect already-attached
    const attached = [];
    const modes = {};
    grid.querySelectorAll('.note-card').forEach(card => {
      const id = card.id.replace('note-user-' + agent + '-', '');
      attached.push(id);
      const lbl = card.querySelector('.mode-label');
      modes[id] = lbl && lbl.textContent.trim().toLowerCase() === 'directive' ? 'directive' : 'always';
    });

    for (const row of rows) {
      const check = row.querySelector('.note-check');
      if (!check.checked) continue;
      const id = row.dataset.id;
      attached.push(id);
      modes[id] = 'always';
      const noteData = _allNotes.find(n => n.id === id);
      const emoji = noteData?.emoji || 'üìù';
      const title = noteData?.title || id;
      grid.insertAdjacentHTML('beforeend', `
        <div class="note-card" id="note-user-${agent}-${id}">
          <span class="note-name">${emoji} ${title}</span>
          <span class="note-source">user note</span>
          <div style="display:flex; align-items:center; gap:0.375rem;">
            <span class="mode-label always" id="ml-${agent}-${id}">ALWAYS</span>
            <div class="mode-toggle" id="mt-${agent}-${id}"
                 onclick="toggleNoteMode('${agent}', '${id}', this)">
              <span class="toggle-knob"></span>
            </div>
          </div>
          <button class="note-remove-btn" title="Detach" onclick="detachUserNote('${agent}', '${id}')">‚úï</button>
        </div>`);
    }

    // Save to backend
    await fetch(`/api/profiles/${agent}/knowledge`, {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({attached_notes: attached, note_modes: modes}),
    });

    checkNotesEmpty(agent);
    document.getElementById('notes-empty-' + agent).style.display = 'none';
    closeAddNotesModal();
  }

  function _esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  populateModelDropdowns();
  populateElevenLabsVoices();
  populateEdgeTTSVoices();

  // ‚îÄ‚îÄ Save All ‚îÄ‚îÄ
  async function saveAll(agent) {
    // Collect enabled tools
    const enabledTools = [];
    document.querySelectorAll(`#tools-grid-${agent} .tool-toggle-switch.on`).forEach(s => {
      const id = s.id.replace('tool-sw-' + agent + '-', '');
      enabledTools.push(id);
    });

    const data = {
      display_name: document.getElementById('name-' + agent)?.value || agent,
      description: document.getElementById('desc-' + agent)?.value || '',
      model: document.getElementById('model-' + agent)?.value || '',
      system_prompt_text: document.getElementById('prompt-' + agent)?.value || '',
      voice_id: document.getElementById('voice-paid-' + agent)?.value || '',
      edge_voice: document.getElementById('voice-free-' + agent)?.value || 'alloy',
      allowed_tools: enabledTools,
    };

    const resp = await fetch(`/api/profiles/${agent}/config`, {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data),
    });
    if (resp.ok) {
      showToast('Profile saved');
      const card = document.querySelector(`.agent-card[data-agent="${agent}"]`);
      if (card) {
        const cardName = card.querySelector('.agent-card-name');
        if (cardName) cardName.textContent = data.display_name;
        // Update the description/narrative in the card body
        let cardDesc = card.querySelector('.agent-card-desc');
        if (cardDesc) {
          if (data.description) {
            cardDesc.textContent = data.description;
            cardDesc.style.cssText = '';
          } else {
            cardDesc.textContent = 'No description set ‚Äî click to edit.';
            cardDesc.style.color = '#3f3f46';
            cardDesc.style.fontStyle = 'italic';
          }
        }
        // Update model bubble
        const footer = card.querySelector('.agent-card-footer');
        if (footer) {
          const llmTag = footer.querySelector('.agent-tag-llm');
          if (data.model) {
            if (llmTag) {
              llmTag.innerHTML = '<i class="fas fa-microchip"></i> ' + _esc(data.model);
            } else {
              footer.insertAdjacentHTML('afterbegin',
                `<span class="agent-tag-llm"><i class="fas fa-microchip"></i> ${_esc(data.model)}</span>`);
            }
          } else if (llmTag) {
            llmTag.remove();
          }
        }
      }
      // Update tab breadcrumb
      document.getElementById('tab-btn-agents').innerHTML =
        '<span style="opacity:0.6">Agents</span> <span style="color:#3f3f46;margin:0 0.25rem;">‚Ä∫</span> ' + _esc(data.display_name);
    } else {
      showToast('Save failed', true);
    }
  }

  // ‚îÄ‚îÄ New agent ‚îÄ‚îÄ
  function openNewAgentModal() {
    document.getElementById('new-agent-modal').classList.add('open');
    document.getElementById('new-agent-name').focus();
  }
  function closeNewAgentModal() {
    document.getElementById('new-agent-modal').classList.remove('open');
  }
  async function createNewAgent() {
    const name = document.getElementById('new-agent-name').value.trim().toLowerCase().replace(/\s+/g, '_');
    const model = document.getElementById('new-agent-model').value.trim() || '';
    const desc = document.getElementById('new-agent-desc')?.value.trim() || '';
    if (!name) return;
    const resp = await fetch('/api/profiles/create', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({name, model, description: desc}),
    });
    if (resp.ok) {
      location.reload();
    } else {
      const err = await resp.json();
      alert(err.error || 'Failed to create agent');
    }
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
  function showToast(msg, isError) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = `position:fixed;bottom:1.5rem;right:1.5rem;padding:0.625rem 1.25rem;border-radius:0.5rem;font-size:0.8125rem;font-weight:600;color:#fff;z-index:200;animation:viewFade 0.2s ease;${isError ? 'background:#ef4444;' : 'background:#6366f1;'}`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }
</script>
{% endblock %}
