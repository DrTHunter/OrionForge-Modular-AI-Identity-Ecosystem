{% extends "base.html" %}
{% block title %}Tools â€” Orion Forge{% endblock %}

{% block content %}
<style>
  /* â”€â”€ Shell & view switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tools-shell { max-width: 100%; margin: 0 auto; padding: 0 1rem; }

  .tab-bar { display: flex; align-items: center; gap: 0; border-bottom: 1px solid #2a2a3a; margin-bottom: 1.5rem; }
  .tab-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; font-size: 0.875rem; font-weight: 600; color: #71717a; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; position: relative; top: 1px; }
  .tab-btn:hover { color: #a1a1aa; }
  .tab-btn.active { color: #fff; border-bottom-color: #6366f1; }
  .tab-count { font-size: 0.75rem; font-weight: 700; color: #71717a; background: rgba(42,42,58,0.6); padding: 0.0625rem 0.4rem; border-radius: 9999px; min-width: 1.25rem; text-align: center; }
  .tab-btn.active .tab-count { color: #a5b4fc; background: rgba(99,102,241,0.15); }

  .view-panel { display: none; animation: viewFade 0.2s ease; }
  .view-panel.active { display: block; }
  .editor-view { display: none; animation: viewFade 0.2s ease; }
  .editor-view.active { display: block; }
  @keyframes viewFade { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* â”€â”€ List view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tools-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
  @media (max-width: 768px) { .tools-grid { grid-template-columns: 1fr; } }

  .tool-card {
    background: rgba(26,26,36,0.8);
    border: 1px solid rgba(42,42,58,0.6);
    border-radius: 0.75rem;
    padding: 1.25rem 1.5rem;
    transition: all 0.2s ease;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    position: relative;
  }
  .tool-card:hover {
    border-color: rgba(99,102,241,0.4);
    background: rgba(26,26,36,1);
    box-shadow: 0 0 20px rgba(99,102,241,0.06);
    transform: translateY(-2px);
  }
  .tool-card-icon {
    width: 2.5rem; height: 2.5rem; border-radius: 0.5rem;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; flex-shrink: 0;
  }
  .tool-card-info { flex: 1; min-width: 0; }
  .tool-card-name {
    font-size: 0.9375rem; font-weight: 700; color: #e4e4e7;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
  }
  .tool-card-desc {
    font-size: 0.75rem; color: #a1a1aa; line-height: 1.4; margin-top: 0.25rem;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .tool-card-meta {
    display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;
  }
  .meta-chip {
    font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
    padding: 0.125rem 0.5rem; border-radius: 9999px;
  }
  .meta-chip.params { background: rgba(34,211,238,0.1); color: #22d3ee; }
  .meta-chip.status-ready { background: rgba(16,185,129,0.12); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.25); }
  .meta-chip.status-planned { background: rgba(99,102,241,0.15); color: #a5b4fc; border: 1px solid rgba(99,102,241,0.3); }
  .meta-chip.status-concept { background: rgba(245,158,11,0.12); color: #fcd34d; border: 1px solid rgba(245,158,11,0.25); }

  /* â”€â”€ Stats row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
  @media (max-width: 768px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
  .stat-card {
    background: rgba(26,26,36,0.6); border: 1px solid rgba(42,42,58,0.5);
    border-radius: 0.5rem; padding: 1rem 1.25rem; text-align: center;
  }
  .stat-value { font-size: 1.75rem; font-weight: 800; color: #fff; }
  .stat-label { font-size: 0.6875rem; color: #71717a; text-transform: uppercase; letter-spacing: 0.06em; margin-top: 0.125rem; }

  /* â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .filter-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; }
  .filter-btn {
    padding: 0.25rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem;
    border: 1px solid rgba(42,42,58,0.5); background: none; color: #71717a; cursor: pointer; transition: all 0.15s;
  }
  .filter-btn:hover { color: #a1a1aa; background: rgba(42,42,58,0.3); }
  .filter-btn.active { background: rgba(99,102,241,0.15); color: #818cf8; border-color: rgba(99,102,241,0.3); }
  .search-input {
    background: rgba(24,24,27,0.6); border: 1px solid rgba(42,42,58,0.5);
    border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.8125rem;
    color: #d4d4d8; outline: none; width: 100%; max-width: 20rem; transition: border-color 0.15s;
  }
  .search-input:focus { border-color: rgba(99,102,241,0.5); }
  .search-input::placeholder { color: #52525b; }

  /* â”€â”€ Editor / detail view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-card {
    background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 0.75rem;
    padding: 1.25rem 1.5rem; margin-bottom: 1.25rem;
  }
  .section-title {
    font-size: 0.8125rem; font-weight: 700; color: #e4e4e7;
    margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;
  }
  .sec-icon { font-size: 0.875rem; }

  .param-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; }
  .param-table th {
    text-align: left; color: #71717a; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; padding: 0.375rem 0.5rem;
    border-bottom: 1px solid rgba(42,42,58,0.6); font-size: 0.625rem;
  }
  .param-table td {
    padding: 0.375rem 0.5rem; color: #d4d4d8;
    border-bottom: 1px solid rgba(42,42,58,0.3); vertical-align: top;
  }
  .param-table tr:last-child td { border-bottom: none; }
  .param-name {
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    color: #818cf8; font-weight: 600; white-space: nowrap;
  }
  .param-type {
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    color: #22d3ee; font-size: 0.6875rem;
  }
  .param-required {
    display: inline-block; font-size: 0.5625rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.05em;
    padding: 0.125rem 0.375rem; border-radius: 0.25rem;
    background: rgba(239,68,68,0.15); color: #fca5a5;
  }
  .param-optional {
    display: inline-block; font-size: 0.5625rem; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.05em;
    padding: 0.125rem 0.375rem; border-radius: 0.25rem;
    background: rgba(113,113,122,0.15); color: #71717a;
  }
  .enum-values { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem; }
  .enum-chip {
    font-size: 0.625rem;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    background: rgba(99,102,241,0.1); color: #a5b4fc;
    padding: 0.0625rem 0.375rem; border-radius: 0.25rem;
    border: 1px solid rgba(99,102,241,0.2);
  }

  /* â”€â”€ Action bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .action-bar {
    display: flex; justify-content: flex-end; gap: 0.75rem;
    padding-top: 1rem; border-top: 1px solid #2a2a3a; margin-top: 0.5rem;
  }
  .btn {
    padding: 0.5rem 1.25rem; border-radius: 0.5rem;
    font-size: 0.8125rem; font-weight: 600; cursor: pointer;
    transition: all 0.15s; border: none;
  }
  .btn-primary { background: #6366f1; color: #fff; }
  .btn-primary:hover { background: #4f46e5; }
  .btn-secondary { background: rgba(42,42,58,0.5); color: #a1a1aa; border: 1px solid #2a2a3a; }
  .btn-secondary:hover { background: rgba(42,42,58,0.8); color: #e4e4e7; }

  .tool-detail-header {
    display: flex; align-items: center; gap: 1rem; margin-bottom: 1.25rem;
  }
  .tool-detail-icon {
    width: 3rem; height: 3rem; border-radius: 0.625rem;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.35rem; flex-shrink: 0;
  }
  .tool-detail-title { font-size: 1.25rem; font-weight: 800; color: #fff;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace; }
  .tool-detail-desc { font-size: 0.8125rem; color: #a1a1aa; line-height: 1.5; margin-top: 0.25rem; }

  .tool-status-badge {
    display: inline-flex; align-items: center; gap: 0.25rem;
    font-size: 0.6875rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.04em; padding: 0.125rem 0.5rem; border-radius: 9999px;
    margin-top: 0.5rem;
  }
  .badge-ready { background: rgba(16,185,129,0.12); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.25); }
  .badge-planned { background: rgba(99,102,241,0.15); color: #a5b4fc; border: 1px solid rgba(99,102,241,0.3); }
  .badge-concept { background: rgba(245,158,11,0.12); color: #fcd34d; border: 1px solid rgba(245,158,11,0.25); }

  .empty-state {
    text-align: center; padding: 3rem 1rem; color: #52525b;
  }
  .empty-state p { margin: 0.25rem 0; }

  /* â”€â”€ Cost Tracker styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ct-overview { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.25rem; margin-top: 1.25rem; }
  @media (max-width: 768px) { .ct-overview { grid-template-columns: 1fr; } }
  .ct-card {
    background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 0.75rem;
    padding: 1.125rem 1.25rem;
  }
  .ct-card-label { font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: #52525b; margin-bottom: 0.25rem; }
  .ct-card-value { font-size: 1.5rem; font-weight: 800; color: #fff; font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace; }
  .ct-card-sub { font-size: 0.75rem; color: #52525b; margin-top: 0.25rem; }
  .ct-accent { color: #10b981; }

  .ct-status-bar {
    display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 1rem;
    background: rgba(16,185,129,0.06); border: 1px solid rgba(16,185,129,0.15);
    border-radius: 0.5rem; margin-bottom: 1.25rem; font-size: 0.8125rem; color: #6ee7b7;
  }
  .ct-status-bar.warn { background: rgba(245,158,11,0.06); border-color: rgba(245,158,11,0.15); color: #fcd34d; }
  .ct-status-dot { width: 0.5rem; height: 0.5rem; border-radius: 50%; flex-shrink: 0; }
  .ct-status-dot.ok { background: #10b981; }
  .ct-status-dot.warn { background: #f59e0b; }

  .ct-prov-tabs { display: flex; gap: 0; border-bottom: 1px solid #2a2a3a; margin-bottom: 1.25rem; }
  .ct-prov-tab {
    padding: 0.625rem 1.25rem; font-size: 0.8125rem; font-weight: 600;
    color: #71717a; background: none; border: none; cursor: pointer;
    border-bottom: 2px solid transparent; transition: all 0.15s;
    position: relative; top: 1px; text-transform: capitalize;
  }
  .ct-prov-tab:hover { color: #a1a1aa; }
  .ct-prov-tab.active { color: #fff; border-bottom-color: #6366f1; }
  .ct-prov-tab .ct-prov-count {
    font-size: 0.6875rem; font-weight: 700; color: #52525b;
    background: rgba(42,42,58,0.6); padding: 0.0625rem 0.375rem;
    border-radius: 9999px; margin-left: 0.375rem;
  }
  .ct-prov-tab.active .ct-prov-count { color: #a5b4fc; background: rgba(99,102,241,0.15); }

  .ct-table-wrap {
    background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 0.75rem;
    overflow: hidden; margin-bottom: 1.5rem;
  }
  .ct-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
  .ct-table thead th {
    padding: 0.75rem 1rem; text-align: left;
    font-size: 0.6875rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.05em; color: #52525b; border-bottom: 1px solid #2a2a3a;
    background: rgba(19,19,26,0.4);
  }
  .ct-table thead th:not(:first-child) { text-align: right; }
  .ct-table tbody tr { border-bottom: 1px solid rgba(42,42,58,0.5); transition: background 0.1s; }
  .ct-table tbody tr:hover { background: rgba(99,102,241,0.04); }
  .ct-table tbody tr:last-child { border-bottom: none; }
  .ct-table td { padding: 0.625rem 1rem; color: #d4d4d8; vertical-align: middle; }
  .ct-table td:not(:first-child) { text-align: right; }

  .ct-model-name {
    font-weight: 600; color: #e4e4e7;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    font-size: 0.8125rem;
  }
  .ct-model-provider { font-size: 0.6875rem; color: #52525b; text-transform: capitalize; }
  .ct-default-tag {
    font-size: 0.5625rem; font-weight: 700; color: #818cf8;
    background: rgba(99,102,241,0.1); padding: 0.0625rem 0.375rem;
    border-radius: 0.25rem; margin-left: 0.375rem; text-transform: uppercase;
  }

  .ct-price-input {
    width: 7rem; text-align: right; background: transparent;
    border: 1px solid transparent; border-radius: 0.25rem;
    color: #d4d4d8; font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    font-size: 0.8125rem; padding: 0.25rem 0.5rem; outline: none;
    transition: border-color 0.15s, background 0.15s;
  }
  .ct-price-input:hover { border-color: #2a2a3a; }
  .ct-price-input:focus { border-color: #6366f1; background: rgba(19,19,26,0.6); }
  .ct-price-prefix { color: #52525b; font-size: 0.75rem; margin-right: 0.125rem; }

  .ct-refresh-btn {
    display: inline-flex; align-items: center; gap: 0.375rem;
    padding: 0.4rem 1rem; border-radius: 0.5rem;
    background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.2);
    color: #818cf8; font-size: 0.8125rem; font-weight: 600;
    cursor: pointer; transition: all 0.15s;
  }
  .ct-refresh-btn:hover { background: rgba(99,102,241,0.16); border-color: #6366f1; }

  .ct-add-row {
    display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
    background: rgba(19,19,26,0.3); border-top: 1px solid #2a2a3a;
  }
  .ct-add-input {
    flex: 1; background: #13131a; border: 1px solid #2a2a3a; border-radius: 0.375rem;
    color: #d4d4d8; font-size: 0.8125rem; padding: 0.375rem 0.625rem; outline: none;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    transition: border-color 0.15s;
  }
  .ct-add-input:focus { border-color: #6366f1; }
  .ct-add-input::placeholder { color: #3f3f46; }

  .ct-empty { padding: 3rem; text-align: center; color: #3f3f46; font-size: 0.875rem; }

  .ct-row-del {
    background: none; border: none; color: #52525b; cursor: pointer;
    font-size: 0.75rem; padding: 0.125rem 0.25rem; transition: color 0.15s;
  }
  .ct-row-del:hover { color: #fca5a5; }

  /* â”€â”€ Tool Config: toggle, fields, grid, mode cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toggle-row {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.75rem 0; border-bottom: 1px solid rgba(42,42,58,0.4);
  }
  .toggle-row:last-child { border-bottom: none; }
  .toggle-label { flex: 1; }
  .toggle-label-title { font-size: 0.8125rem; font-weight: 600; color: #e4e4e7; }
  .toggle-label-desc { font-size: 0.6875rem; color: #71717a; margin-top: 0.125rem; }
  .toggle-switch {
    position: relative; width: 2.5rem; height: 1.375rem;
    cursor: pointer; flex-shrink: 0;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-track {
    position: absolute; inset: 0; border-radius: 9999px;
    background: rgba(42,42,58,0.8); transition: background 0.2s;
  }
  .toggle-track::after {
    content: ''; position: absolute; top: 2px; left: 2px;
    width: 1rem; height: 1rem; border-radius: 50%;
    background: #71717a; transition: all 0.2s;
  }
  .toggle-switch input:checked + .toggle-track {
    background: rgba(99,102,241,0.6);
  }
  .toggle-switch input:checked + .toggle-track::after {
    transform: translateX(1.125rem); background: #a5b4fc;
  }

  .config-field { margin-bottom: 0.625rem; }
  .config-field:last-child { margin-bottom: 0; }
  .config-label {
    font-size: 0.6875rem; font-weight: 600; color: #71717a;
    text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.25rem;
  }
  .config-input {
    width: 100%; background: rgba(24,24,27,0.8); border: 1px solid rgba(42,42,58,0.5);
    border-radius: 0.375rem; padding: 0.375rem 0.625rem; font-size: 0.8125rem;
    color: #d4d4d8; outline: none; transition: border-color 0.15s;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
  }
  .config-input:focus { border-color: rgba(99,102,241,0.5); }
  .config-input-wide {
    width: 100%; background: rgba(24,24,27,0.8); border: 1px solid rgba(42,42,58,0.5);
    border-radius: 0.375rem; padding: 0.375rem 0.625rem; font-size: 0.8125rem;
    color: #d4d4d8; outline: none; transition: border-color 0.15s;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
  }
  .config-input-wide:focus { border-color: rgba(99,102,241,0.5); }
  .config-hint { font-size: 0.6875rem; color: #52525b; margin-top: 0.25rem; }

  .config-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
  @media (max-width: 768px) { .config-grid { grid-template-columns: 1fr; } }
  .mode-card {
    background: rgba(24,24,27,0.5); border: 1px solid rgba(42,42,58,0.5);
    border-radius: 0.625rem; padding: 1rem;
  }
  .mode-card-title {
    font-size: 0.8125rem; font-weight: 700; color: #e4e4e7;
    margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.375rem;
  }
  .mode-card-title .mode-icon { font-size: 0.75rem; }

  .meta-chip.configurable { background: rgba(251,191,36,0.12); color: #fbbf24; }

  /* â”€â”€ About section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .about-text { font-size: 0.8125rem; color: #a1a1aa; line-height: 1.65; margin-bottom: 0.75rem; }
  .about-text:last-child { margin-bottom: 0; }
  .about-sub {
    font-size: 0.6875rem; font-weight: 700; color: #71717a;
    text-transform: uppercase; letter-spacing: 0.05em;
    margin: 1rem 0 0.5rem; padding-top: 0.75rem;
    border-top: 1px solid rgba(42,42,58,0.4);
  }
  .about-sub:first-child { margin-top: 0; padding-top: 0; border-top: none; }
  .about-commands { display: flex; flex-direction: column; gap: 0.375rem; }
  .about-cmd {
    display: flex; align-items: flex-start; gap: 0.625rem;
    padding: 0.5rem 0.75rem; border-radius: 0.5rem;
    background: rgba(24,24,27,0.5); border: 1px solid rgba(42,42,58,0.4);
  }
  .about-cmd-name {
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    font-size: 0.75rem; font-weight: 700; color: #818cf8;
    white-space: nowrap; min-width: 5.5rem; padding-top: 0.0625rem;
  }
  .about-cmd-desc { font-size: 0.75rem; color: #a1a1aa; line-height: 1.5; }
  .about-cmd-desc code {
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, monospace;
    font-size: 0.6875rem; color: #22d3ee; background: rgba(34,211,238,0.08);
    padding: 0.0625rem 0.3rem; border-radius: 0.1875rem;
  }
</style>

<div class="tools-shell p-6 md:p-10">
  <!-- â•â•â• TAB BAR â•â•â• -->
  <div class="tab-bar">
    <button class="tab-btn active" id="tab-btn-tools" onclick="showToolsList()">
      Tools <span class="tab-count">{{ total }}</span>
    </button>
  </div>

  <!-- â•â•â• LIST VIEW â•â•â• -->
  <div class="view-panel active" id="view-tools">
    <!-- Stats Row -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-value" style="color:#818cf8;">{{ total }}</div>
        <div class="stat-label">Total Tools</div>
      </div>
      <div class="stat-card">
        {% set ready_count = [] %}
        {% for t in tools %}{% if t.status == 'ready' %}{% if ready_count.append(1) %}{% endif %}{% endif %}{% endfor %}
        <div class="stat-value" style="color:#6ee7b7;">{{ ready_count|length }}</div>
        <div class="stat-label">Ready</div>
      </div>
      <div class="stat-card">
        {% set planned_count = [] %}
        {% for t in tools %}{% if t.status == 'planned' %}{% if planned_count.append(1) %}{% endif %}{% endif %}{% endfor %}
        <div class="stat-value" style="color:#a5b4fc;">{{ planned_count|length }}</div>
        <div class="stat-label">Planned</div>
      </div>
      <div class="stat-card">
        {% set param_total = [] %}
        {% for t in tools %}{% for p in t.parameters %}{% if param_total.append(1) %}{% endif %}{% endfor %}{% endfor %}
        <div class="stat-value" style="color:#22d3ee;">{{ param_total|length }}</div>
        <div class="stat-label">Total Parameters</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
      <input type="text" class="search-input" id="tool-search" placeholder="Search tools..." oninput="filterTools()">
      <div style="display:flex;gap:0.5rem;">
        <button class="filter-btn active" onclick="setFilter('all', this)" data-filter="all">All</button>
        <button class="filter-btn" onclick="setFilter('ready', this)" data-filter="ready">Ready</button>
        <button class="filter-btn" onclick="setFilter('planned', this)" data-filter="planned">Planned</button>
        <button class="filter-btn" onclick="setFilter('concept', this)" data-filter="concept">Concept</button>
      </div>
    </div>

    <!-- Tools Grid -->
    <div class="tools-grid" id="tools-grid">
      {% for tool in tools %}
      <div class="tool-card"
           data-tool-name="{{ tool.name }}"
           data-tool-desc="{{ tool.description|lower }}"
           data-tool-status="{{ tool.status }}"
           onclick="openToolEditor('{{ tool.name }}')">
        <div class="tool-card-icon" style="background:{{ tool.icon_bg }};color:{{ tool.icon_color }};">
          {{ tool.icon }}
        </div>
        <div class="tool-card-info">
          <div class="tool-card-name">{{ tool.display_name|default(tool.name) }}</div>
          <div class="tool-card-desc">{{ tool.description }}</div>
          <div class="tool-card-meta">
            <span class="meta-chip params">{{ tool.parameters|length }} param{{ "s" if tool.parameters|length != 1 }}</span>
            {% if tool.name == 'web_search' %}
            <span class="meta-chip configurable">&#9881; Configurable</span>
            {% endif %}
            <span class="meta-chip status-{{ tool.status }}">
              {% if tool.status == 'ready' %}&#10004; Ready{% elif tool.status == 'planned' %}&#9678; Planned{% else %}&#9671; Concept{% endif %}
            </span>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% if not tools %}
    <div class="empty-state">
      <p style="font-size:1rem;color:#71717a;">No tools registered</p>
      <p style="font-size:0.75rem;">Add tools to the catalogue in <code>app.py</code></p>
    </div>
    {% endif %}
  </div>

  <!-- â•â•â• EDITOR / DETAIL VIEWS (one per tool) â•â•â• -->
  {% for tool in tools %}
  {% if tool.name != 'cost_tracker' %}
  <div class="editor-view" id="editor-{{ tool.name }}">

    <!-- Header -->
    <div class="tool-detail-header">
      <div class="tool-detail-icon" style="background:{{ tool.icon_bg }};color:{{ tool.icon_color }};">
        {{ tool.icon }}
      </div>
      <div>
        <div class="tool-detail-title">{{ tool.display_name|default(tool.name) }}</div>
        <div class="tool-detail-desc">{{ tool.description }}</div>
        <div class="tool-status-badge badge-{{ tool.status }}">
          {% if tool.status == 'ready' %}&#10004; Ready{% elif tool.status == 'planned' %}&#9678; Planned{% else %}&#9671; Concept{% endif %}
        </div>
      </div>
    </div>

    <!-- Parameters Section -->
    {% if tool.parameters %}
    <div class="section-card">
      <div class="section-title"><span class="sec-icon">&#128203;</span> Parameters</div>
      <table class="param-table">
        <thead>
          <tr>
            <th>Parameter</th>
            <th>Type</th>
            <th>Required</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {% for param in tool.parameters %}
          <tr>
            <td><span class="param-name">{{ param.name }}</span></td>
            <td><span class="param-type">{{ param.type }}</span></td>
            <td>
              {% if param.required %}
                <span class="param-required">required</span>
              {% else %}
                <span class="param-optional">optional</span>
              {% endif %}
            </td>
            <td>
              <span style="color:#a1a1aa;font-size:0.75rem;">{{ param.description }}</span>
              {% if param.enum %}
              <div class="enum-values">
                {% for val in param.enum %}
                <span class="enum-chip">{{ val }}</span>
                {% endfor %}
              </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <!-- About Section -->
    <div class="section-card">
      <div class="section-title"><span class="sec-icon">&#128218;</span> About</div>

      {% if tool.name == 'web_search' %}
      <div class="about-text">
        Provides internet access through a self-hosted SearXNG instance. The agent can search for information or scrape a specific URL. A knowledge gate can require the agent to justify why it needs the internet before executing.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">search</span>
          <span class="about-cmd-desc">Query the web via SearXNG. Requires <code>query</code> and <code>reason</code>. Optional <code>mode</code> (<code>fast</code>, <code>normal</code>, <code>deep</code>) controls how many pages are scraped and how much text is returned. The <code>knowledge_check</code> field lets the agent state what it already knows.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">scrape</span>
          <span class="about-cmd-desc">Fetch and extract readable content from a specific <code>url</code>. Returns the page text trimmed to the active mode&rsquo;s word limit. Useful when the agent already has a link and needs the full content.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        When the agent encounters a question it cannot answer from memory, it calls <code>search</code> with a query and a reason. If the knowledge gate is enabled and no reason is provided, the tool bounces the request back, telling the agent to use its own knowledge first. On success, the agent receives a list of results with titles, URLs, and scraped snippets. It can then call <code>scrape</code> on any URL to get the full page content.
      </div>

      {% elif tool.name == 'email' %}
      <div class="about-text">
        Draft, preview, and send emails through SMTP. A confirmation gate ensures the user can review every email before it is actually sent.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">send</span>
          <span class="about-cmd-desc">Compose an email with <code>to</code>, <code>subject</code>, and <code>body</code>. The first call returns a preview. The agent must call again with <code>confirmation=&quot;confirmed&quot;</code> after user approval to actually send.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        When asked to send an email, the agent drafts the message and calls the tool. The tool returns a preview for the user to review. Only after explicit approval does the agent re-call with the confirmation flag to dispatch the email via SMTP.
      </div>

      {% elif tool.name == 'memory' %}
      <div class="about-text">
        Read from and write to the agent&rsquo;s persistent FAISS-backed memory vault. Memories are embedded with <code>all-mpnet-base-v2</code> and stored in <code>vault.jsonl</code> for semantic retrieval.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">search</span>
          <span class="about-cmd-desc">Semantic search across all stored memories. Provide <code>text</code> as the query. Returns the top matching entries with similarity scores.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">add</span>
          <span class="about-cmd-desc">Store a new memory. Requires <code>text</code> and an optional <code>category</code> (bio, preference, project, lore, session, meta, health, self, other).</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">delete</span>
          <span class="about-cmd-desc">Remove a memory entry by its ID.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">list</span>
          <span class="about-cmd-desc">List all stored memories, optionally filtered by <code>category</code>.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        The agent searches memory at the start of conversations to recall context about the user. During chat, it adds important facts, preferences, or project details to the vault so they persist across sessions.
      </div>

      {% elif tool.name == 'echo' %}
      <div class="about-text">
        A minimal diagnostic tool that returns whatever text is sent to it. Used to verify that the tool dispatch pipeline is working correctly end-to-end.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">echo</span>
          <span class="about-cmd-desc">Send <code>text</code> and receive it back unchanged. No side effects.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        The agent does not call this tool during normal conversations. It exists for operators to test that tool calls are being dispatched and returned correctly through the execution loop.
      </div>

      {% elif tool.name == 'directives' %}
      <div class="about-text">
        Manage runtime directives &mdash; the living governance documents that shape agent behavior, boundaries, and personality. Directives are loaded per-agent from markdown files.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">read</span>
          <span class="about-cmd-desc">Read a specific directive by <code>directive_id</code>. Returns the full markdown content.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">update</span>
          <span class="about-cmd-desc">Update a directive&rsquo;s <code>content</code>. Requires <code>directive_id</code> and the new markdown text.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">list</span>
          <span class="about-cmd-desc">List all available directives with their IDs and summaries.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        The agent reads its directives at startup to understand its behavioral boundaries. During a session, it may query directives to confirm whether an action is within scope or update them when the operator grants new permissions.
      </div>

      {% elif tool.name == 'task_inbox' %}
      <div class="about-text">
        A shared task queue that enables multi-agent coordination and operator-to-agent task assignment. Messages persist until cleared.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">read</span>
          <span class="about-cmd-desc">Read all pending tasks from the inbox.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">write</span>
          <span class="about-cmd-desc">Post a new task <code>message</code> to the inbox for another agent or the operator to pick up.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">clear</span>
          <span class="about-cmd-desc">Clear all tasks from the inbox after they have been processed.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        When an agent identifies a task outside its expertise, it writes a message to the inbox for the appropriate agent. Agents can also check the inbox at the start of each session for operator-assigned work.
      </div>

      {% elif tool.name == 'continuation_update' %}
      <div class="about-text">
        Signals progress during multi-step workflows. Allows the agent to post status updates so the runtime can track long-running operations and decide whether to continue, pause, or escalate.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">update</span>
          <span class="about-cmd-desc">Post an <code>update</code> message describing current progress. Optional <code>status</code> field: <code>in_progress</code>, <code>completed</code>, or <code>blocked</code>.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        During multi-step tasks (research, code generation, analysis), the agent calls this tool between steps to report what it has done and what comes next. If it gets stuck, it sets status to <code>blocked</code> so the runtime can intervene.
      </div>

      {% elif tool.name == 'runtime_info' %}
      <div class="about-text">
        Introspection tool that lets the agent query its own runtime environment &mdash; loaded profiles, active tools, memory statistics, configuration, and uptime.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">status</span>
          <span class="about-cmd-desc">Returns runtime health: uptime, active agent, error counts.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">config</span>
          <span class="about-cmd-desc">Returns the current configuration: connections, model settings, feature flags.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">tools</span>
          <span class="about-cmd-desc">Lists all registered tools and their status (ready, planned, concept).</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">memory</span>
          <span class="about-cmd-desc">Returns memory vault statistics: entry count, index size, categories.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">all</span>
          <span class="about-cmd-desc">Returns everything above in a single response.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        The agent can query this tool to understand its own capabilities before attempting an action, or to answer user questions about the system&rsquo;s state and configuration.
      </div>

      {% elif tool.name == 'inbox' %}
      <div class="about-text">
        A direct communication channel to the user (the operator). Used when the agent needs human input, wants to flag something important, or requires approval for a sensitive action.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">message</span>
          <span class="about-cmd-desc">Send a <code>message</code> to the operator. Optional <code>priority</code>: <code>low</code>, <code>normal</code>, <code>high</code>, or <code>critical</code>.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        When the agent encounters a decision it cannot make alone &mdash; approving a purchase, confirming a sensitive action, or reporting an unexpected error &mdash; it sends a message to the operator&rsquo;s inbox with the appropriate priority level.
      </div>

      {% elif tool.name == 'computer_use' %}
      <div class="about-text">
        Desktop automation tool that gives the agent direct control over the computer &mdash; taking screenshots, moving the mouse, clicking, typing, and pressing keys.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">screenshot</span>
          <span class="about-cmd-desc">Capture the current screen. Returns an image the agent can analyze.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">click</span>
          <span class="about-cmd-desc">Click at coordinates (<code>x</code>, <code>y</code>) on screen.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">type</span>
          <span class="about-cmd-desc">Type <code>text</code> at the current cursor position.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">move</span>
          <span class="about-cmd-desc">Move the mouse cursor to (<code>x</code>, <code>y</code>) without clicking.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">scroll</span>
          <span class="about-cmd-desc">Scroll the mouse wheel at the current position.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">key</span>
          <span class="about-cmd-desc">Press a keyboard key or combination (e.g. <code>ctrl+c</code>, <code>enter</code>).</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        The agent takes a screenshot to see the current state, identifies UI elements, then issues click/type/key commands to interact with desktop applications. It loops screenshot &rarr; action &rarr; screenshot to verify each step succeeded.
      </div>

      {% elif tool.name == 'cost_tracker' %}
      <div class="about-text">
        Manages token pricing and tracks spending across all LLM API calls. The agent can query costs, update per-model rates, and monitor budget usage in real time.
      </div>
      <div class="about-sub">Commands</div>
      <div class="about-commands">
        <div class="about-cmd">
          <span class="about-cmd-name">get_pricing</span>
          <span class="about-cmd-desc">Get current pricing for a <code>provider</code> and <code>model</code>.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">set_pricing</span>
          <span class="about-cmd-desc">Update per-million-token rates for a specific model.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">list_models</span>
          <span class="about-cmd-desc">List all models with configured pricing.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">cost_summary</span>
          <span class="about-cmd-desc">Aggregate spending for a <code>period</code>: today, this_week, this_month, or all_time.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">cost_log</span>
          <span class="about-cmd-desc">Return the recent cost event log with per-call breakdowns.</span>
        </div>
        <div class="about-cmd">
          <span class="about-cmd-name">session_cost</span>
          <span class="about-cmd-desc">Get the running cost total for the current session only.</span>
        </div>
      </div>
      <div class="about-sub">How the AI uses this tool</div>
      <div class="about-text">
        The agent may check session cost or budget remaining before performing expensive operations. It can also report spending summaries to the user on request.
      </div>

      {% else %}
      <div class="about-text">
        {{ tool.description }}
      </div>
      {% endif %}
    </div>

    <!-- Configurable Settings (web_search only) -->
    {% if tool.name == 'web_search' %}
    <div class="section-card">
      <div class="section-title"><span class="sec-icon">&#129504;</span> Knowledge Gate</div>
      <div class="toggle-row">
        <div class="toggle-label">
          <div class="toggle-label-title">Require Justification</div>
          <div class="toggle-label-desc">
            When enabled, the agent must explain what it already knows and WHY it needs
            the internet before executing a search. Searches without justification are
            bounced back, telling the agent to use its own knowledge first.
          </div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="cfg-require-justification"
                 {% if web_search_config.require_justification %}checked{% endif %}>
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title"><span class="sec-icon">&#9881;</span> Configuration</div>

      <!-- SearXNG URL -->
      <div class="config-field" style="margin-bottom:1rem;">
        <div class="config-label">SearXNG URL</div>
        <input type="text" class="config-input-wide" id="cfg-searxng-url"
               value="{{ web_search_config.searxng_url }}"
               placeholder="http://localhost:3000/search">
        <div class="config-hint">The SearXNG instance endpoint for web searches</div>
      </div>

      <!-- Mode Presets -->
      <div class="config-label" style="margin-bottom:0.75rem;">Mode Presets</div>
      <div class="config-grid">
        {% for mode_name in ['fast', 'normal', 'deep'] %}
        {% set mode = web_search_config.modes[mode_name] %}
        <div class="mode-card">
          <div class="mode-card-title">
            <span class="mode-icon">
              {% if mode_name == 'fast' %}&#9889;{% elif mode_name == 'normal' %}&#9878;{% else %}&#128300;{% endif %}
            </span>
            {{ mode_name|capitalize }}
          </div>
          <div class="config-field">
            <div class="config-label">Pages to scrape</div>
            <input type="number" class="config-input" id="cfg-{{ mode_name }}-pages"
                   value="{{ mode.pages }}" min="1" max="20">
          </div>
          <div class="config-field">
            <div class="config-label">Results to return</div>
            <input type="number" class="config-input" id="cfg-{{ mode_name }}-return"
                   value="{{ mode.return_count }}" min="1" max="20">
          </div>
          <div class="config-field">
            <div class="config-label">Word limit</div>
            <input type="number" class="config-input" id="cfg-{{ mode_name }}-words"
                   value="{{ mode.word_limit }}" min="100" max="10000" step="100">
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Action Bar -->
    <div class="action-bar">
      <button class="btn btn-secondary" onclick="showToolsList()">&larr; Back to Tools</button>
      {% if tool.name == 'web_search' %}
      <button class="btn btn-primary" onclick="saveToolConfig('web_search')">Save Configuration</button>
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% endfor %}

  <!-- â•â•â• COST TRACKER â€” Custom Editor View â•â•â• -->
  <div class="editor-view" id="editor-cost_tracker">

    <!-- Header -->
    <div class="tool-detail-header">
      <div class="tool-detail-icon" style="background:rgba(16,185,129,0.12);color:#10b981;">ðŸ’°</div>
      <div>
        <div class="tool-detail-title">cost_tracker</div>
        <div class="tool-detail-desc">Manage token pricing, track costs per model, and view spending across all LLM API calls.</div>
        <div class="tool-status-badge badge-ready">&#10004; Ready</div>
      </div>
    </div>

    <!-- Cost Overview Cards -->
    <div class="ct-overview">
      <div class="ct-card">
        <div class="ct-card-label">Today</div>
        <div class="ct-card-value ct-accent" id="ct-cost-today">
          ${{ "%.6f" | format(cost_stats.today.get('total_cost', 0)) }}
        </div>
        <div class="ct-card-sub" id="ct-cost-today-calls">{{ cost_stats.today.get('num_calls', 0) }} API calls</div>
      </div>
      <div class="ct-card">
        <div class="ct-card-label">This Month (30d)</div>
        <div class="ct-card-value" id="ct-cost-month">
          ${{ "%.6f" | format(cost_stats.this_month.get('total_cost', 0)) }}
        </div>
        <div class="ct-card-sub" id="ct-cost-month-calls">{{ cost_stats.this_month.get('num_calls', 0) }} API calls</div>
      </div>
      <div class="ct-card">
        <div class="ct-card-label">All Time</div>
        <div class="ct-card-value" id="ct-cost-all">
          ${{ "%.6f" | format(cost_stats.all_time.get('total_cost', 0)) }}
        </div>
        <div class="ct-card-sub" id="ct-cost-all-calls">{{ cost_stats.all_time.get('num_calls', 0) }} API calls Â· {{ "{:,}".format(cost_stats.all_time.get('total_tokens', 0)) }} tokens</div>
      </div>
    </div>

    <!-- Status bar -->
    {% if connections %}
    <div class="ct-status-bar">
      <span class="ct-status-dot ok"></span>
      {{ connections | length }} connection{{ 's' if connections | length != 1 else '' }} active &mdash; prices auto-applied to all chat messages
    </div>
    {% else %}
    <div class="ct-status-bar warn">
      <span class="ct-status-dot warn"></span>
      No API connections configured. <a href="/settings" style="color:#818cf8; text-decoration:underline;">Add one in Settings</a> to see models.
    </div>
    {% endif %}

    <!-- Section: Model Pricing -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; margin-top:1.5rem;">
      <h3 style="font-size:1.0625rem; font-weight:700; color:#fff; margin:0;">Model Pricing</h3>
      <div style="display:flex; gap:0.5rem;">
        <button class="ct-refresh-btn" onclick="ctRefreshModels()">â†» Refresh Models</button>
        <button class="btn btn-primary btn-sm" onclick="ctSaveAll()">Save All</button>
      </div>
    </div>

    <!-- Provider Tabs -->
    <div class="ct-prov-tabs" id="ct-provider-tabs"></div>

    <!-- Pricing Table -->
    <div class="ct-table-wrap">
      <table class="ct-table">
        <thead>
          <tr>
            <th style="min-width:14rem;">Model</th>
            <th>Input<br><span style="font-weight:400;text-transform:none;color:#3f3f46;">$ / 1M tokens</span></th>
            <th>Cached Input<br><span style="font-weight:400;text-transform:none;color:#3f3f46;">$ / 1M tokens</span></th>
            <th>Output<br><span style="font-weight:400;text-transform:none;color:#3f3f46;">$ / 1M tokens</span></th>
            <th>Training<br><span style="font-weight:400;text-transform:none;color:#3f3f46;">$ / 1M tokens</span></th>
            <th style="width:4rem;"></th>
          </tr>
        </thead>
        <tbody id="ct-pricing-tbody"></tbody>
      </table>
      <div class="ct-add-row">
        <select class="ct-add-input" id="ct-add-provider" style="flex:0 0 8rem;">
          <option value="openai">openai</option>
          <option value="anthropic">anthropic</option>
          <option value="deepseek">deepseek</option>
          <option value="ollama">ollama</option>
        </select>
        <input type="text" class="ct-add-input" id="ct-add-model-name" placeholder="model-name (e.g. gpt-4o-mini)">
        <button class="btn btn-sm btn-primary" onclick="ctAddModel()">+ Add</button>
      </div>
    </div>

    <!-- Section: Recent Cost Log -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; margin-top:2rem;">
      <h3 style="font-size:1.0625rem; font-weight:700; color:#fff; margin:0;">Recent Cost Log</h3>
      <button class="btn btn-secondary btn-sm" onclick="ctRefreshLog()">â†» Refresh</button>
    </div>
    <div class="ct-table-wrap">
      <table class="ct-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Agent</th>
            <th>Model</th>
            <th>Tokens</th>
            <th>Cost</th>
          </tr>
        </thead>
        <tbody id="ct-log-tbody">
          <tr><td colspan="5" class="ct-empty"><span style="font-size:2rem;display:block;margin-bottom:0.5rem;">ðŸ“Š</span>No cost events yet. Send a chat message to start tracking.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <button class="btn btn-secondary" onclick="showToolsList()">&larr; Back to Tools</button>
    </div>
  </div>
</div>

<script>
  let currentFilter = 'all';
  let _currentToolEditor = null;

  /* â”€â”€ List helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function filterTools() {
    const query = document.getElementById('tool-search').value.toLowerCase().trim();
    document.querySelectorAll('#tools-grid .tool-card').forEach(card => {
      const name   = card.dataset.toolName.toLowerCase();
      const desc   = card.dataset.toolDesc;
      const status = card.dataset.toolStatus;
      const matchesSearch = !query || name.includes(query) || desc.includes(query);
      const matchesFilter = currentFilter === 'all' || status === currentFilter;
      card.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
    });
  }

  function setFilter(filter, btn) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    filterTools();
  }

  /* â”€â”€ View switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showToolsList() {
    document.querySelectorAll('.editor-view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-tools').classList.add('active');
    const btn = document.getElementById('tab-btn-tools');
    btn.innerHTML = 'Tools <span class="tab-count">{{ total }}</span>';
    btn.classList.add('active');
    _currentToolEditor = null;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function openToolEditor(name) {
    document.getElementById('view-tools').classList.remove('active');
    document.querySelectorAll('.editor-view').forEach(v => v.classList.remove('active'));
    const editor = document.getElementById('editor-' + name);
    if (editor) {
      editor.classList.add('active');
      _currentToolEditor = name;
      document.getElementById('tab-btn-tools').innerHTML =
        '<span style="opacity:0.6">Tools</span> <span style="color:#3f3f46;margin:0 0.25rem;">&rsaquo;</span> ' + _esc(name);
      window.scrollTo({ top: 0, behavior: 'smooth' });
      // Initialize pricing data when opening cost_tracker
      if (name === 'cost_tracker' && !_ctInitialized) {
        ctBuildModelList(); ctRenderTabs(); ctRenderTable(); ctRefreshLog();
        _ctInitialized = true;
      }
    }
  }

  function _esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  function showToast(msg, isError) {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = 'position:fixed;bottom:1.5rem;right:1.5rem;padding:0.625rem 1.25rem;border-radius:0.5rem;font-size:0.8125rem;font-weight:600;color:#fff;z-index:200;animation:viewFade 0.2s ease;' +
      (isError ? 'background:#ef4444;' : 'background:#6366f1;');
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }

  /* â”€â”€ Save tool config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function saveToolConfig(toolName) {
    let url, body;

    if (toolName === 'web_search') {
      url = '/api/tools/web_search/config';
      body = {
        searxng_url: document.getElementById('cfg-searxng-url').value.trim(),
        require_justification: document.getElementById('cfg-require-justification').checked,
        modes: {}
      };
      for (const mode of ['fast', 'normal', 'deep']) {
        body.modes[mode] = {
          pages:        parseInt(document.getElementById('cfg-' + mode + '-pages').value)  || 2,
          return_count: parseInt(document.getElementById('cfg-' + mode + '-return').value) || 2,
          word_limit:   parseInt(document.getElementById('cfg-' + mode + '-words').value)  || 1500,
        };
      }
    } else {
      return;
    }

    try {
      const resp = await fetch(url, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      if (resp.ok) {
        showToast(toolName + ' config saved');
      } else {
        showToast('Save failed', true);
      }
    } catch (e) {
      showToast('Save failed: ' + e.message, true);
    }
  }

  /* â•â•â• Cost Tracker â€” Pricing Management â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const _ctPricing = {{ pricing | tojson }};
  const _ctConnections = {{ connections | tojson }};
  let _ctModels = [];
  let _ctProviders = new Set();
  let _ctActiveProvider = 'all';
  let _ctDirty = {};
  let _ctInitialized = false;

  function ctBuildModelList() {
    _ctModels = [];
    _ctProviders = new Set(['all']);
    const seen = new Set();
    _ctConnections.forEach(conn => {
      const prov = conn.provider || 'openai';
      _ctProviders.add(prov);
      (conn.models || []).forEach(m => {
        const key = prov + ':' + m;
        if (seen.has(key)) return;
        seen.add(key);
        _ctModels.push({ provider: prov, model: m, ...ctLookupPrice(prov, m), source: 'connection', connection: conn.name });
      });
    });
    for (const [prov, models] of Object.entries(_ctPricing)) {
      _ctProviders.add(prov);
      for (const [m, vals] of Object.entries(models)) {
        if (m.startsWith('_')) continue;
        const key = prov + ':' + m;
        if (seen.has(key)) continue;
        seen.add(key);
        _ctModels.push({
          provider: prov, model: m,
          input_per_1m: vals.input_per_1m || 0,
          cached_input_per_1m: vals.cached_input_per_1m || 0,
          output_per_1m: vals.output_per_1m || 0,
          training_per_1m: vals.training_per_1m || 0,
          source: 'pricing_yaml',
        });
      }
    }
    _ctModels.sort((a, b) => a.provider !== b.provider ? a.provider.localeCompare(b.provider) : a.model.localeCompare(b.model));
  }

  function ctLookupPrice(provider, model) {
    const pp = _ctPricing[provider] || {};
    let mp = pp[model];
    if (!mp) { for (const [k, v] of Object.entries(pp)) { if (!k.startsWith('_') && typeof v === 'object' && model.startsWith(k)) { mp = v; break; } } }
    if (!mp) mp = pp['_default'] || {};
    return { input_per_1m: mp.input_per_1m||0, cached_input_per_1m: mp.cached_input_per_1m||0, output_per_1m: mp.output_per_1m||0, training_per_1m: mp.training_per_1m||0 };
  }

  function ctRenderTabs() {
    const el = document.getElementById('ct-provider-tabs');
    const counts = {};
    _ctModels.forEach(m => { counts[m.provider] = (counts[m.provider]||0) + 1; });
    let html = `<button class="ct-prov-tab ${_ctActiveProvider==='all'?'active':''}" onclick="ctSetProvider('all')">All<span class="ct-prov-count">${_ctModels.length}</span></button>`;
    for (const prov of [..._ctProviders].filter(p=>p!=='all').sort()) {
      html += `<button class="ct-prov-tab ${_ctActiveProvider===prov?'active':''}" onclick="ctSetProvider('${prov}')">${prov}<span class="ct-prov-count">${counts[prov]||0}</span></button>`;
    }
    el.innerHTML = html;
  }

  function ctRenderTable() {
    const tbody = document.getElementById('ct-pricing-tbody');
    const filtered = _ctActiveProvider === 'all' ? _ctModels : _ctModels.filter(m => m.provider === _ctActiveProvider);
    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="ct-empty"><span style="font-size:2rem;display:block;margin-bottom:0.5rem;">ðŸ’°</span>No models found. Add a connection in Settings or click "Refresh Models".</td></tr>`;
      return;
    }
    tbody.innerHTML = filtered.map(m => {
      const key = m.provider + ':' + m.model;
      const tag = m.source === 'connection'
        ? `<span style="font-size:0.6rem;color:#52525b;margin-left:0.25rem;">\u26a1 live</span>`
        : `<span style="font-size:0.6rem;color:#3f3f46;margin-left:0.25rem;">\ud83d\udcc4 config</span>`;
      return `<tr data-key="${_esc(key)}">
        <td><span class="ct-model-name">${_esc(m.model)}</span>${tag}<br><span class="ct-model-provider">${_esc(m.provider)}${m.connection ? ' \u00b7 ' + _esc(m.connection) : ''}</span></td>
        <td><span class="ct-price-prefix">$</span><input type="number" class="ct-price-input" step="0.001" min="0" value="${m.input_per_1m}" onchange="ctMarkDirty('${_esc(key)}','input_per_1m',this.value)"></td>
        <td><span class="ct-price-prefix">$</span><input type="number" class="ct-price-input" step="0.001" min="0" value="${m.cached_input_per_1m}" onchange="ctMarkDirty('${_esc(key)}','cached_input_per_1m',this.value)"></td>
        <td><span class="ct-price-prefix">$</span><input type="number" class="ct-price-input" step="0.001" min="0" value="${m.output_per_1m}" onchange="ctMarkDirty('${_esc(key)}','output_per_1m',this.value)"></td>
        <td><span class="ct-price-prefix">$</span><input type="number" class="ct-price-input" step="0.001" min="0" value="${m.training_per_1m}" onchange="ctMarkDirty('${_esc(key)}','training_per_1m',this.value)"></td>
        <td><button class="ct-row-del" title="Remove" onclick="ctRemoveModel('${_esc(key)}')">âœ•</button></td>
      </tr>`;
    }).join('');
  }

  function ctSetProvider(prov) { _ctActiveProvider = prov; ctRenderTabs(); ctRenderTable(); }
  function ctMarkDirty(key, field, value) { if (!_ctDirty[key]) _ctDirty[key] = {}; _ctDirty[key][field] = parseFloat(value)||0; }

  async function ctSaveAll() {
    const pricing = JSON.parse(JSON.stringify(_ctPricing));
    for (const [key, fields] of Object.entries(_ctDirty)) {
      const [prov, ...mp] = key.split(':'); const model = mp.join(':');
      if (!pricing[prov]) pricing[prov] = {};
      if (!pricing[prov][model]) {
        const ex = _ctModels.find(m => m.provider === prov && m.model === model);
        pricing[prov][model] = { input_per_1m: ex?.input_per_1m||0, cached_input_per_1m: ex?.cached_input_per_1m||0, output_per_1m: ex?.output_per_1m||0, training_per_1m: ex?.training_per_1m||0 };
      }
      Object.assign(pricing[prov][model], fields);
    }
    _ctModels.forEach(m => {
      if (!pricing[m.provider]) pricing[m.provider] = {};
      if (!pricing[m.provider][m.model]) pricing[m.provider][m.model] = { input_per_1m: m.input_per_1m, cached_input_per_1m: m.cached_input_per_1m, output_per_1m: m.output_per_1m, training_per_1m: m.training_per_1m };
    });
    const resp = await fetch('/api/pricing', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(pricing) });
    if (resp.ok) { _ctDirty = {}; Object.assign(_ctPricing, pricing); showToast('Pricing saved'); } else { showToast('Save failed', true); }
  }

  async function ctRemoveModel(key) {
    const [prov, ...mp] = key.split(':'); const model = mp.join(':');
    if (!confirm(`Remove pricing for ${prov}/${model}?`)) return;
    const resp = await fetch(`/api/pricing/${encodeURIComponent(prov)}/${encodeURIComponent(model)}`, { method:'DELETE' });
    if (resp.ok) {
      if (_ctPricing[prov]) delete _ctPricing[prov][model];
      _ctModels = _ctModels.filter(m => !(m.provider === prov && m.model === model));
      delete _ctDirty[key];
      ctRenderTabs(); ctRenderTable(); showToast('Model removed');
    }
  }

  function ctAddModel() {
    const prov = document.getElementById('ct-add-provider').value;
    const model = document.getElementById('ct-add-model-name').value.trim();
    if (!model) return;
    if (_ctModels.find(m => m.provider === prov && m.model === model)) { showToast('Model already exists', true); return; }
    _ctModels.push({ provider: prov, model, source: 'manual', input_per_1m:0, cached_input_per_1m:0, output_per_1m:0, training_per_1m:0 });
    _ctProviders.add(prov);
    _ctDirty[prov+':'+model] = { input_per_1m:0, cached_input_per_1m:0, output_per_1m:0, training_per_1m:0 };
    document.getElementById('ct-add-model-name').value = '';
    ctRenderTabs(); ctRenderTable();
  }

  async function ctRefreshModels() {
    showToast('Refreshing models from connections\u2026');
    try {
      const resp = await fetch('/api/pricing/models');
      const data = await resp.json();
      if (data.models) {
        data.models.forEach(m => {
          if (!_ctModels.find(x => x.provider === m.provider && x.model === m.model)) {
            _ctModels.push({ ...m, source: 'connection' });
            _ctProviders.add(m.provider);
          }
        });
        ctRenderTabs(); ctRenderTable();
        showToast(`Found ${data.models.length} models`);
      }
    } catch(e) { showToast('Refresh failed: ' + e, true); }
  }

  async function ctRefreshLog() {
    try {
      const resp = await fetch('/api/pricing/cost-log?limit=50');
      const data = await resp.json();
      const tbody = document.getElementById('ct-log-tbody');
      if (!data.events || !data.events.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="ct-empty"><span style="font-size:2rem;display:block;margin-bottom:0.5rem;">ðŸ“Š</span>No cost events yet.</td></tr>`;
        return;
      }
      tbody.innerHTML = data.events.reverse().map(ev => {
        const ts = new Date(ev.ts).toLocaleString();
        const tokens = ((ev.usage?.prompt_tokens||0) + (ev.usage?.completion_tokens||0)).toLocaleString();
        const cost = '$' + (ev.cost?.total_cost||0).toFixed(6);
        return `<tr>
          <td style="color:#71717a;font-size:0.75rem;">${_esc(ts)}</td>
          <td style="text-transform:capitalize;">${_esc(ev.agent||'\u2014')}</td>
          <td><span class="ct-model-name" style="font-size:0.75rem;">${_esc(ev.model||'\u2014')}</span></td>
          <td>${tokens}</td>
          <td style="font-family:ui-monospace,SFMono-Regular,'SF Mono',Menlo,monospace;">${cost}</td>
        </tr>`;
      }).join('');
    } catch(e) { console.error('Cost log failed:', e); }
  }

  // Auto-open cost_tracker if URL has #cost_tracker
  if (location.hash === '#cost_tracker') {
    setTimeout(() => openToolEditor('cost_tracker'), 100);
  }
</script>
{% endblock %}
